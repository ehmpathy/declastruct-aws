# execution: phase 1 — foundation

## summary

phase 1 establishes the foundation for VPC tunnel implementation by installing dependencies and updating the context interface.

---

## tasks

### 1.1 install dependencies

- [x] **task**: add AWS SDK packages
  ```bash
  npm install @aws-sdk/client-ec2 @aws-sdk/client-rds
  ```

- **status**: ✅ completed
- **verification**:
  ```
  $ npm ls @aws-sdk/client-ec2 @aws-sdk/client-rds
  declastruct-aws@1.0.2
  ├── @aws-sdk/client-ec2@3.940.0
  └── @aws-sdk/client-rds@3.940.0
  ```

---

### 1.2 update `ContextAwsApi`

- [x] **task**: update `src/domain.objects/ContextAwsApi.ts` with new shape
  - added `credentials: { account?, region? }`
  - added `cache.DeclaredAwsVpcTunnel.processes.dir`

- **status**: ✅ completed
- **changes**:
  ```typescript
  // before
  export interface ContextAwsApi {
    aws: {
      account?: string;
      region?: string;
    };
  }

  // after
  export interface ContextAwsApi {
    aws: {
      credentials: {
        account?: string;
        region?: string;
      };
      cache: {
        DeclaredAwsVpcTunnel: {
          processes: {
            dir: string;
          };
        };
      };
    };
  }
  ```

- **verification**: `npm run test:types` passes ✅

---

## additional fixes (pre-existing issues)

the following pre-existing issues were discovered and fixed during phase 1:

### fix 1: install missing `@aws-sdk/client-lambda`

- [x] **issue**: lambda module referenced `@aws-sdk/client-lambda` which was not in `package.json`
- **resolution**: `npm install @aws-sdk/client-lambda`

### fix 2: update lambda operations for new context shape

- [x] **issue**: existing lambda operations used `context.aws.region` which no longer exists
- **resolution**: updated to use `context.aws.credentials.region` in:
  - `src/domain.operations/lambda/getLambda.ts`
  - `src/domain.operations/lambda/getLambdas.ts`
  - `src/domain.operations/lambda/setLambda.ts`
  - `src/domain.operations/lambda/setLambda.test.ts`

### fix 3: fix `isUniqueKeyRef` → `isRefByUnique`

- [x] **issue**: `getLambda.ts` imported non-existent `isUniqueKeyRef` from domain-objects
- **resolution**: changed to `isRefByUnique` and added type casts for `Ref` narrowing

### fix 4: create missing test asset

- [x] **issue**: integration tests imported non-existent `getSampleAwsApiContext`
- **resolution**: created `src/__test_assets__/getSampleAwsApiContext.ts`

---

## verification

```bash
$ npm run test:types
> tsc -p ./tsconfig.build.json --noEmit
# (no errors)

$ npm run build
> npm run build:clean && npm run build:compile
# (success)
```

---

## files modified

| file | change |
|------|--------|
| `package.json` | added `@aws-sdk/client-ec2`, `@aws-sdk/client-rds`, `@aws-sdk/client-lambda` |
| `src/domain.objects/ContextAwsApi.ts` | restructured to `{ credentials, cache }` shape |
| `src/domain.operations/lambda/getLambda.ts` | updated context usage, fixed import |
| `src/domain.operations/lambda/getLambdas.ts` | updated context usage |
| `src/domain.operations/lambda/setLambda.ts` | updated context usage |
| `src/domain.operations/lambda/setLambda.test.ts` | updated test context shape |
| `src/__test_assets__/getSampleAwsApiContext.ts` | created (new file) |

---

## next phase

proceed to **phase 2: domain objects** which includes:
- `DeclaredAwsEc2Instance`
- `DeclaredAwsRdsCluster`
- `DeclaredAwsVpcTunnel`
- `DeclastructAwsProvider` type
