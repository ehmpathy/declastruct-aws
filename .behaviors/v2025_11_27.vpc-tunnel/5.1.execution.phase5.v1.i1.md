# execution: phase 5 - tunnel utilities

## status: complete âœ…

## summary

created tunnel utility functions for VPC tunnel lifecycle management:

- `isPortInUse` - checks if a local port is bound
- `isTunnelHealthy` - TCP connect to verify tunnel is forwarding
- `isProcessAlive` - checks if process with pid exists
- `isFilePresent` - checks if file exists at path
- `getTunnelHash` - deterministic hash from tunnel ref
- `TunnelCacheFile` - interface for cache file schema

## files created

### utilities

1. `src/domain.operations/vpcTunnel/utils/isPortInUse.ts`
   - creates net.Server to test if port is bindable
   - returns true if EADDRINUSE, false if listening succeeds
   - failfasts on unexpected errors

2. `src/domain.operations/vpcTunnel/utils/isTunnelHealthy.ts`
   - TCP connect to verify tunnel is forwarding
   - 5 second timeout
   - returns true if connect succeeds, false otherwise

3. `src/domain.operations/vpcTunnel/utils/isProcessAlive.ts`
   - uses `process.kill(pid, 0)` to check existence
   - returns true if process exists, false otherwise

4. `src/domain.operations/vpcTunnel/utils/isFilePresent.ts`
   - uses `fs.access` to check file existence
   - returns true if file exists, false if ENOENT
   - failfasts on unexpected errors

5. `src/domain.operations/vpcTunnel/utils/getTunnelHash.ts`
   - serializes tunnel ref with `serialize()` from domain-objects
   - produces 16-character sha256 hash
   - deterministic: same input always produces same hash

6. `src/domain.operations/vpcTunnel/utils/TunnelCacheFile.ts`
   - interface with `pid: number` and `tunnel: RefByUnique<DeclaredAwsVpcTunnel>`

### unit tests

1. `isPortInUse.test.ts` - 4 tests
2. `isTunnelHealthy.test.ts` - 4 tests
3. `isProcessAlive.test.ts` - 4 tests
4. `isFilePresent.test.ts` - 4 tests
5. `getTunnelHash.test.ts` - 5 tests

## verification

```
npm run test:types  # passes
npm run test:unit --testPathPattern="vpcTunnel/utils"  # 21 tests pass
```
