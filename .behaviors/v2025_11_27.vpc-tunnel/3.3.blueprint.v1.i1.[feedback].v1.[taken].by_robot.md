# feedback response: blueprint v1

## blocker.1 — tunnel tracking

**issue**: tracking tunnels in-memory won't work; process terminates after operation

**resolution**: adopted the pidfile + port check + health probe strategy from `3.1.research.v2.i1.md`
- pidfiles stored at `~/.declastruct/tunnels/{tunnelHash}.pid`
- metadata stored at `~/.declastruct/tunnels/{tunnelHash}.meta`
- on open: check port → check pidfile → verify process alive → spawn if needed
- on close: read pidfile → kill process → cleanup files

---

## blocker.2 — generic usefulness of resources

**issue**: `.why` comments scoped too narrowly to VPC tunneling use case

**resolution**: generalized all `.why` comments to reflect broader utility
- `DeclaredAwsEc2Instance`: "enables declarative management of AWS EC2 instances"
- `DeclaredAwsRdsCluster`: "enables declarative management of AWS RDS clusters"
- `DeclaredAwsVpcTunnel`: "enables declarative management of SSM port-forwarding tunnels to private resources"

---

## nitpick.3 — endpoint naming

**issue**: `endpoint` and `readerEndpoint` are ambiguous

**resolution**: changed to nested `host` structure:
```typescript
host?: {
  writer: string;
  reader: string;
};
```

---

## nitpick.4 — mechanism qualifier

**issue**: tunnel `via` should qualify the mechanism for future extensibility

**resolution**: added `mechanism: 'aws.ssm'` to via structure:
```typescript
via: {
  mechanism: 'aws.ssm';
  bastion: RefByUnique<typeof DeclaredAwsEc2Instance>;
};
```

---

## blocker.5 — RefByPrimary support

**issue**: `getEc2Instance` used raw `instanceId` instead of `RefByPrimary`

**resolution**: updated signature to use proper domain-objects pattern:
```typescript
by: PickOne<{
  primary: RefByPrimary<typeof DeclaredAwsEc2Instance>;
  unique: RefByUnique<typeof DeclaredAwsEc2Instance>;
}>;
```

---

## blocker.6 — ContextLogTrail

**issue**: used `VisualogicContext` instead of `ContextLogTrail`

**resolution**: replaced all `VisualogicContext` with `ContextLogTrail` from `simple-log-methods`

---

## blocker.7 — setEc2Instance naming and signature

**issue**: `setEc2Instance` with `state` property conflicts with future creation/update operations and `state` is ambiguous

**resolution**:
- renamed to `setEc2InstanceStatus`
- changed `state` to `status`
- restructured signature with `by.instance` and `to.status` pattern
- updated `DeclaredAwsEc2Instance` to use `status` instead of `state`

---

## blocker.8 — tunnel health verification

**issue**: should verify database is reachable after tunnel opens

**resolution**: added TCP health probe after tunnel spawn:
```typescript
const isTunnelHealthy = async ({ port }: { port: number }): Promise<boolean> => {
  // TCP connect to localhost:port with timeout
  // confirms tunnel is forwarding connections
};
```

waits for successful TCP connection before returning from `setVpcTunnel({ status: 'OPEN' })`
