# feedback response: blueprint v3

## blocker.1 — id should remain optional metadata

**issue**: changed `id` to required, but it's only known after AWS lookup

**resolution**: reverted `id` back to optional metadata (`id?: string`), as it was originally in v2

---

## blocker.2 — getTunnelHash shouldn't need lookups

**issue**: `getTunnelHash` was doing AWS lookups to resolve bastion/cluster, adding unnecessary complexity and latency

**resolution**: simplified to compute hash from `serialize(input.for.tunnel)` directly — no AWS lookups needed. the tunnel ref itself is sufficient for deterministic identity.

---

## nitpick.3 — fileExists → isFilePresent

**issue**: inconsistent naming convention

**resolution**: renamed `fileExists` to `isFilePresent` to match `isPortInUse`, `isProcessAlive`, `isTunnelHealthy` pattern

---

## blocker.4 — default tunnels dir in getContext only

**issue**: `DEFAULT_TUNNELS_DIR` spread across multiple files

**resolution**:
- removed default from operation files
- context interface now requires `cache.DeclaredAwsVpcTunnel.processes.dir` (non-optional)
- default is set only in `getContext` or equivalent context factory
- operations just read `context.aws.cache.DeclaredAwsVpcTunnel.processes.dir` directly

---

## nitpick.5 — acknowledged

(no specific change needed — was just a code snippet reference)

---

## blocker.6 — simplify if/else to narrative flow

**issue**: nested if/else for process alive + healthy check

**resolution**: flattened to:
```typescript
// return early if existing tunnel is alive and healthy
if (isProcessAlive({ pid }) && await isTunnelHealthy({ port: input.from.port }))
  return new DeclaredAwsVpcTunnel({ ...input, status: 'OPEN', pid });

// otherwise, cleanup stale tunnel; fallthrough to respawn
if (isProcessAlive({ pid })) process.kill(pid, 'SIGTERM');
await fs.rm(cachePath, { force: true });
```

---

## blocker.7 — single cache file instead of pid + meta

**issue**: separate `.pid` and `.meta` files for same tunnel

**resolution**: merged into single JSON file at `{tunnelsDir}/{tunnelHash}.json` containing:
```typescript
{ pid: number; tunnel: DeclaredAwsVpcTunnel }
```

---

## blocker.8 — getVpcTunnel input signature

**issue**: input required `as DeclaredAwsVpcTunnel` cast due to mismatched signature

**resolution**: changed input to `{ by: { unique: RefByUnique<typeof DeclaredAwsVpcTunnel> } }` which is directly assignable to `getTunnelHash` input
