# execution: phase 3 - EC2 operations

## status: complete âœ…

## summary

created EC2 instance operations for getting and setting EC2 instance status:

- `castToDeclaredAwsEc2Instance` - casts AWS SDK Instance to domain object
- `getEc2Instance` - retrieves EC2 instance by primary (id) or unique (exid tag)
- `setEc2InstanceStatus` - starts or stops EC2 instance (idempotent)

## files created

### domain operations

1. `src/domain.operations/ec2Instance/castToDeclaredAwsEc2Instance.ts`
   - casts AWS SDK `Instance` type to `DeclaredAwsEc2Instance`
   - extracts `id`, `exid` (from tags), `status`, `privateIp`

2. `src/domain.operations/ec2Instance/getEc2Instance.ts`
   - lookup by primary (id) or unique (exid tag) via `PickOne` pattern
   - uses `isRefByUnique` to route ref lookups
   - failfast if multiple instances found

3. `src/domain.operations/ec2Instance/setEc2InstanceStatus.ts`
   - starts or stops instance using `StartInstancesCommand`/`StopInstancesCommand`
   - uses `waitUntilInstanceRunning`/`waitUntilInstanceStopped` for status transitions
   - idempotent: skips if already in desired status

4. `src/domain.operations/ec2Instance/index.ts`
   - barrel exports for all EC2 operations

### unit tests

1. `src/domain.operations/ec2Instance/castToDeclaredAwsEc2Instance.test.ts` - 7 tests
2. `src/domain.operations/ec2Instance/getEc2Instance.test.ts` - 7 tests
3. `src/domain.operations/ec2Instance/setEc2InstanceStatus.test.ts` - 7 tests

### dependencies added

- `aws-sdk-client-mock` (dev dependency) - for mocking AWS SDK clients in tests

## verification

```
npm run test:types  # passes
npm run test:unit --testPathPattern="ec2Instance"  # 28 tests pass (including DeclaredAwsEc2Instance domain object tests)
```

## notes

- `setEc2InstanceStatus` tests focus on idempotency (skipping when already in desired state) since mocking the `waitUntil*` functions from AWS SDK is complex
- full status transition testing will be covered in integration tests with real AWS credentials
- `getEc2Instance` supports lookup by:
  - primary: `{ id: 'i-xxx' }`
  - unique: `{ exid: 'bastion-name' }`
  - ref: automatically routes to primary or unique based on `isRefByUnique`
