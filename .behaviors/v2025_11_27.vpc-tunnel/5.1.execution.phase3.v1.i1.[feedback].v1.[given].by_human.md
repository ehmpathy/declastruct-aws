emit your response to the feedback into .behaviors/v2025_11_27.vpc-tunnel/5.1.execution.phase3.v1.i1.[feedback].v1.[taken].by_robot.md

1. emit your response checklist
2. exec your response plan
3. emit your response checkoffs into the checklist

---

reboot your mechanics briefs first.

npx rhachet roles boot --repo ehmpathy --role mechanic

then address the blockers and nitpicks below

---

# blocker.1

  return new DeclaredAwsEc2Instance({
    id: input.InstanceId,
    exid: exidTag?.Value ?? '',

 exid is the unique key; failfast if not defined; never failhide; this is a huge failhide hazard currently!!! :cry:


----


# blocker.2


  // handle by ref
  if (input.by.ref) {
    if (isRefByUnique({ of: DeclaredAwsEc2Instance })(input.by.ref))
      return getEc2Instance(
        { by: { unique: input.by.ref as RefByUnique<typeof DeclaredAwsEc2Instance> } },
        context,
      );
    return getEc2Instance(
      { by: { primary: input.by.ref as RefByPrimary<typeof DeclaredAwsEc2Instance> } },
      context,
    );
  }

never nested if :cry:

use an IFFE with early returns. never nest anything.

and fail if you reach the end without an earlyreturn hit


----


# blocker.3

did you run npm run test:types?

`throw UnexpectedCodePathError.throw` is invalid

just `UnexpectedCodePathError.throw` instead

it throws within it already


----

# blocker.4

elimiante index files that were not specifically asked for

e.g.,
src/domain.operations/ec2Instance/index.ts

they just make multiple ways to import the same thing -> multiple ways to get an import cycle

big hazards all around


---

# blocker.5


  // failfast if instance id not known
  if (!instance.id)
    throw UnexpectedCodePathError.throw(
      'instance id not known; cannot set status',
      { instance },
    );


we already talked about this. HasMetadata guarantees that instance.id will be defined; this is unnessesary


---

# blocker.6


this is not an IFFE+EarlyReturn


  // start or stop based on desired status
  if (input.to.status === 'running') {
    await ec2.send(new StartInstancesCommand({ InstanceIds: [instance.id] }));
    await waitUntilInstanceRunning(
      { client: ec2, maxWaitTime: 300 },
      { InstanceIds: [instance.id] },
    );
  } else if (input.to.status === 'stopped') {
    await ec2.send(new StopInstancesCommand({ InstanceIds: [instance.id] }));
    await waitUntilInstanceStopped(
      { client: ec2, maxWaitTime: 300 },
      { InstanceIds: [instance.id] },
    );
  } else {
    throw UnexpectedCodePathError.throw('unsupported status', { input });
  }


fix it to be an IFFE+EarlyReturn instead; always

we hate the term `else`; its a codereak

not even a smell

a REAK

---
