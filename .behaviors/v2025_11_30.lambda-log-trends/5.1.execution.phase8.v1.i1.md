# Phase 8: Acceptance Test Fixes for Log Group Reports

## Summary

This phase addressed issues discovered while running acceptance tests for the log group reports feature. The tests now verify that reports contain actual data from AWS CloudWatch Logs.

## Fixes Applied

### 1. Empty Report Instead of Null for Non-Existent Log Groups

**File:** `src/domain.operations/logGroupReportDistOfPattern/getOneLogGroupReportDistOfPattern.ts`

**Issue:** When a log group doesn't exist, returning `null` caused declastruct to see `[CREATE]` decision, which then tried to write the readonly entity and threw `BadRequestError`.

**Fix:** Return an empty report with `scannedBytes: 0`, `matchedEvents: 0`, `rows: []` so declastruct sees `[KEEP]` instead.

```typescript
if (error.name === 'ResourceNotFoundException')
  return assure(
    DeclaredAwsLogGroupReportDistOfPattern.as({
      ...input.by.unique,
      scannedBytes: 0,
      matchedEvents: 0,
      rows: [],
    }),
    hasReadonly({ of: DeclaredAwsLogGroupReportDistOfPattern }),
  );
```

### 2. IAM Role Policy for CloudWatch Logs Permissions

**Files:**
- `src/contract/sdks/.test/assets/resources.acceptance.ts`
- `src/domain.operations/provider/getDeclastructAwsProvider.ts`

**Issue:** Lambda role had no permissions to write logs, so log groups were never created.

**Fix:** Added `DeclaredAwsIamRolePolicy` resource with CloudWatch Logs permissions and registered the DAO in the provider.

```typescript
const lambdaRolePolicy = DeclaredAwsIamRolePolicy.as({
  name: 'cloudwatch-logs',
  role: RefByUnique.as<typeof DeclaredAwsIamRole>(lambdaRole),
  statements: [
    {
      effect: 'Allow',
      action: [
        'logs:CreateLogGroup',
        'logs:CreateLogStream',
        'logs:PutLogEvents',
      ],
      resource: '*',
    },
  ],
});
```

### 3. Time Range Fix for Log Group Reports

**File:** `src/contract/sdks/.test/assets/resources.acceptance.ts`

**Issue:** Time range was `subDays(new Date(), 7)` for both since AND until, meaning it queried a single day 7 days ago instead of the last 7 days.

**Fix:** Changed `until` to `endOfDay(new Date())` to capture logs up to the current time.

```typescript
const logGroupReportRange = {
  since: asUniDateTime(startOfDay(subDays(new Date(), 7))),
  until: asUniDateTime(endOfDay(new Date())),
};
```

### 4. Nested Property Definitions for Row Types

**Files:**
- `src/domain.objects/DeclaredAwsLogGroupReportDistOfPattern.ts`
- `src/domain.objects/DeclaredAwsLogGroupReportCostOfIngestion.ts`

**Issue:** `DomainObjectNotSafeToManipulateError` for `percentOfTotal` key in row types.

**Fix:** Added `nested` static property to both row classes.

```typescript
export class DeclaredAwsLogGroupReportDistOfPatternRow ... {
  public static nested = {
    percentOfTotal: DomainLiteral,
  };
}

export class DeclaredAwsLogGroupReportCostOfIngestionRow ... {
  public static nested = {
    percentOfTotal: DomainLiteral,
  };
}
```

### 5. Jest VM Modules Flag for AWS SDK

**File:** `package.json`

**Issue:** AWS SDK v3 requires `--experimental-vm-modules` for dynamic imports in Jest.

**Fix:** Added the flag to `test:acceptance:locally` script.

```json
"test:acceptance:locally": "npm run build && LOCALLY=true NODE_OPTIONS='--experimental-vm-modules' jest -c ./jest.acceptance.config.ts ..."
```

### 6. Test Structure for Lambda Invocation Timing

**File:** `src/contract/sdks/declastruct.acceptance.test.ts`

**Issue:** Lambda invoke in top-level `beforeAll` ran before declastruct applied the IAM policy, so logs weren't generated.

**Fix:** Moved log group reports test into its own `when` block with `beforeAll` that invokes the lambda after resources are applied.

```typescript
when('fetching log group reports after lambda invocation', () => {
  beforeAll(async () => {
    execSync(`aws lambda invoke --function-name ${lambdaName} ...`);
  });

  then('fetches log group reports with patterns and costs', async () => {
    // assertions for non-empty reports
  });
});
```

## Test Results

All 8 acceptance tests now pass:

```
✓ then: creates a valid plan file
✓ then: plan includes VPC tunnel resource
✓ then: plan includes lambda deployment resources
✓ then: plan includes log group report resources
✓ then: opens VPC tunnel and verifies it is active
✓ then: deploys lambda with aliased version
✓ then: is idempotent - applying same plan twice succeeds
✓ then: fetches log group reports with patterns and costs
```

The final test verifies that both reports contain actual data:
- `patternReport.rows.length > 0`
- `patternReport.matchedEvents > 0`
- `costReport.rows.length > 0`
- `costReport.totalIngestedBytes > 0`
- `costReport.totalEstimatedCostUsd > 0`
