# AWS Domain Research for Lambda Log Trends Wish (v2)

## Context

The wish is to declaratively:
1. Get a histogram of log messages emitted by a given set of lambdas
   - What are the common `.message` attributes?
   - How often do they occur?
   - How large are the messages?
2. Optionally get the report of ingestion cost declaratively

This document defines AWS SDK domain objects in `domain-objects` syntax, prefixed with `SdkAws...` to match AWS's exact terms.

---

## Domain Objects

### Entities

#### SdkAwsLogGroup

```typescript
import type { LogGroupClass, DataProtectionStatus, InheritedProperty } from '@aws-sdk/client-cloudwatch-logs';
import { DomainEntity } from 'domain-objects';

/**
 * .what = an AWS CloudWatch Logs log group
 * .note = the primary container for log streams
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/LogGroup/
 *   - https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_LogGroup.html
 */
export interface SdkAwsLogGroup {
  /**
   * .what = the ARN of the log group (with trailing `:*`)
   * .note = is @metadata -> assigned by AWS
   */
  arn?: string;

  /**
   * .what = the ARN of the log group (without trailing `:*`)
   * .note = preferred for tagging and IAM policies
   */
  logGroupArn?: string;

  /**
   * .what = the name of the log group
   * .note = for lambda: `/aws/lambda/<function-name>`
   */
  logGroupName?: string;

  /**
   * .what = the log class
   * .note = STANDARD | INFREQUENT_ACCESS | DELIVERY
   */
  logGroupClass?: LogGroupClass;

  /**
   * .what = creation time in milliseconds since epoch
   */
  creationTime?: number;

  /**
   * .what = retention period in days
   * .note = valid values: 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1096, 1827, 2192, 2557, 2922, 3288, 3653
   */
  retentionInDays?: number;

  /**
   * .what = total bytes currently stored
   * .note = is @readonly -> resolved from AWS with ~24hr delay
   */
  storedBytes?: number;

  /**
   * .what = number of metric filters on this log group
   */
  metricFilterCount?: number;

  /**
   * .what = KMS key id for encryption (if configured)
   */
  kmsKeyId?: string;

  /**
   * .what = data protection status
   */
  dataProtectionStatus?: DataProtectionStatus;

  /**
   * .what = whether deletion protection is enabled
   */
  deletionProtectionEnabled?: boolean;

  /**
   * .what = properties inherited from account settings
   */
  inheritedProperties?: InheritedProperty[];
}

export class SdkAwsLogGroup
  extends DomainEntity<SdkAwsLogGroup>
  implements SdkAwsLogGroup
{
  public static primary = ['arn'] as const;
  public static unique = ['logGroupName'] as const;
  public static metadata = ['arn', 'logGroupArn', 'creationTime'] as const;
  public static readonly = ['storedBytes', 'metricFilterCount'] as const;
}
```

#### SdkAwsLogStream

```typescript
import { DomainEntity } from 'domain-objects';

/**
 * .what = an AWS CloudWatch Logs log stream
 * .note = a sequence of log events from a single source
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/LogStream/
 */
export interface SdkAwsLogStream {
  /**
   * .what = the ARN of the log stream
   * .note = is @metadata -> assigned by AWS
   */
  arn?: string;

  /**
   * .what = the name of the log stream
   * .note = lambda pattern: `YYYY/MM/DD/[<FunctionVersion>]<InstanceId>`
   */
  logStreamName?: string;

  /**
   * .what = creation time in milliseconds since epoch
   */
  creationTime?: number;

  /**
   * .what = timestamp of first log event
   */
  firstEventTimestamp?: number;

  /**
   * .what = timestamp of most recent log event
   * .note = eventually consistent
   */
  lastEventTimestamp?: number;

  /**
   * .what = when CloudWatch last received a log event
   * .note = eventually consistent
   */
  lastIngestionTime?: number;

  /**
   * .what = bytes stored in this stream
   * .note = DEPRECATED: always returns 0 since June 17, 2019
   */
  storedBytes?: number;

  /**
   * .what = sequence token for PutLogEvents
   * .note = now ignored in PutLogEvents actions
   */
  uploadSequenceToken?: string;
}

export class SdkAwsLogStream
  extends DomainEntity<SdkAwsLogStream>
  implements SdkAwsLogStream
{
  public static primary = ['arn'] as const;
  public static unique = ['logStreamName'] as const;
  public static metadata = ['arn', 'creationTime'] as const;
  public static readonly = ['firstEventTimestamp', 'lastEventTimestamp', 'lastIngestionTime'] as const;
}
```

#### SdkAwsLogEvent (OutputLogEvent)

```typescript
import { DomainValueObject } from 'domain-objects';

/**
 * .what = an AWS CloudWatch Logs log event
 * .note = the fundamental unit of log data (output form)
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/OutputLogEvent/
 */
export interface SdkAwsLogEvent {
  /**
   * .what = when the log event occurred
   * .note = milliseconds since epoch
   */
  timestamp?: number;

  /**
   * .what = the log message content
   * .note = max 1MB per event
   */
  message?: string;

  /**
   * .what = when CloudWatch received the event
   * .note = milliseconds since epoch
   */
  ingestionTime?: number;
}

export class SdkAwsLogEvent
  extends DomainValueObject<SdkAwsLogEvent>
  implements SdkAwsLogEvent {}
```

#### SdkAwsQueryDefinition

```typescript
import type { QueryLanguage } from '@aws-sdk/client-cloudwatch-logs';
import { DomainEntity } from 'domain-objects';

/**
 * .what = a saved CloudWatch Logs Insights query
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/QueryDefinition/
 */
export interface SdkAwsQueryDefinition {
  /**
   * .what = unique identifier for the query definition
   * .note = is @metadata -> assigned by AWS
   */
  queryDefinitionId?: string;

  /**
   * .what = the name of the query
   */
  name?: string;

  /**
   * .what = the query syntax
   */
  queryString?: string;

  /**
   * .what = the query language
   * .note = CWLI | SQL | PPL
   */
  queryLanguage?: QueryLanguage;

  /**
   * .what = log groups the query is limited to
   */
  logGroupNames?: string[];

  /**
   * .what = when the query was last modified
   */
  lastModified?: number;
}

export class SdkAwsQueryDefinition
  extends DomainEntity<SdkAwsQueryDefinition>
  implements SdkAwsQueryDefinition
{
  public static primary = ['queryDefinitionId'] as const;
  public static unique = ['name'] as const;
  public static metadata = ['queryDefinitionId', 'lastModified'] as const;
}
```

#### SdkAwsMetricFilter

```typescript
import type { MetricTransformation } from '@aws-sdk/client-cloudwatch-logs';
import { DomainEntity, DomainLiteral } from 'domain-objects';

/**
 * .what = transforms log data into CloudWatch metrics
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/MetricFilter/
 */
export interface SdkAwsMetricFilter {
  /**
   * .what = name of the filter
   */
  filterName?: string;

  /**
   * .what = pattern to match log events
   */
  filterPattern?: string;

  /**
   * .what = associated log group name
   */
  logGroupName?: string;

  /**
   * .what = how to create metrics from matches
   */
  metricTransformations?: SdkAwsMetricTransformation[];

  /**
   * .what = creation time in milliseconds since epoch
   */
  creationTime?: number;

  /**
   * .what = whether filter applies to transformed logs
   */
  applyOnTransformedLogs?: boolean;

  /**
   * .what = system fields emitted as additional metric dimensions
   */
  emitSystemFieldDimensions?: string[];

  /**
   * .what = filter expression for processing based on system fields
   */
  fieldSelectionCriteria?: string;
}

export class SdkAwsMetricFilter
  extends DomainEntity<SdkAwsMetricFilter>
  implements SdkAwsMetricFilter
{
  public static primary = ['filterName', 'logGroupName'] as const;
  public static unique = ['filterName', 'logGroupName'] as const;
  public static metadata = ['creationTime'] as const;
}
```

### Value Objects / Literals

#### SdkAwsMetricTransformation

```typescript
import type { StandardUnit } from '@aws-sdk/client-cloudwatch-logs';
import { DomainLiteral } from 'domain-objects';

/**
 * .what = metric transformation rule
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/MetricTransformation/
 */
export interface SdkAwsMetricTransformation {
  metricName: string;
  metricNamespace: string;
  metricValue: string;
  defaultValue?: number;
  dimensions?: Record<string, string>;
  unit?: StandardUnit;
}

export class SdkAwsMetricTransformation
  extends DomainLiteral<SdkAwsMetricTransformation>
  implements SdkAwsMetricTransformation {}
```

#### SdkAwsResultField

```typescript
import { DomainLiteral } from 'domain-objects';

/**
 * .what = a field/value pair from Logs Insights query results
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/ResultField/
 */
export interface SdkAwsResultField {
  field?: string;
  value?: string;
}

export class SdkAwsResultField
  extends DomainLiteral<SdkAwsResultField>
  implements SdkAwsResultField {}
```

#### SdkAwsQueryStatistics

```typescript
import { DomainLiteral } from 'domain-objects';

/**
 * .what = statistics about a Logs Insights query execution
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/QueryStatistics/
 */
export interface SdkAwsQueryStatistics {
  bytesScanned?: number;
  recordsScanned?: number;
  recordsMatched?: number;
  logGroupsScanned?: number;
  estimatedBytesSkipped?: number;
  estimatedRecordsSkipped?: number;
}

export class SdkAwsQueryStatistics
  extends DomainLiteral<SdkAwsQueryStatistics>
  implements SdkAwsQueryStatistics {}
```

#### SdkAwsDatapoint (for CloudWatch Metrics)

```typescript
import type { StandardUnit } from '@aws-sdk/client-cloudwatch';
import { DomainLiteral } from 'domain-objects';

/**
 * .what = a data point from CloudWatch Metrics
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch/Interface/Datapoint/
 */
export interface SdkAwsDatapoint {
  Timestamp?: Date;
  Sum?: number;
  Average?: number;
  Minimum?: number;
  Maximum?: number;
  SampleCount?: number;
  Unit?: StandardUnit;
  ExtendedStatistics?: Record<string, number>;
}

export class SdkAwsDatapoint
  extends DomainLiteral<SdkAwsDatapoint>
  implements SdkAwsDatapoint {}
```

#### SdkAwsDimension

```typescript
import { DomainLiteral } from 'domain-objects';

/**
 * .what = a dimension for CloudWatch metrics
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch/Interface/Dimension/
 */
export interface SdkAwsDimension {
  Name?: string;
  Value?: string;
}

export class SdkAwsDimension
  extends DomainLiteral<SdkAwsDimension>
  implements SdkAwsDimension {}
```

### Literals (Enums)

#### SdkAwsLogGroupClass

```typescript
/**
 * .what = log group class enumeration
 * .refs
 *   - https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CloudWatch_Logs_Log_Classes.html
 */
export const SdkAwsLogGroupClass = {
  STANDARD: 'STANDARD',
  INFREQUENT_ACCESS: 'INFREQUENT_ACCESS',
  DELIVERY: 'DELIVERY',
} as const;

export type SdkAwsLogGroupClass = (typeof SdkAwsLogGroupClass)[keyof typeof SdkAwsLogGroupClass];
```

#### SdkAwsQueryLanguage

```typescript
/**
 * .what = query language for Logs Insights
 * .refs
 *   - https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_AnalyzeLogData.html
 */
export const SdkAwsQueryLanguage = {
  CWLI: 'CWLI',
  SQL: 'SQL',
  PPL: 'PPL',
} as const;

export type SdkAwsQueryLanguage = (typeof SdkAwsQueryLanguage)[keyof typeof SdkAwsQueryLanguage];
```

#### SdkAwsQueryStatus

```typescript
/**
 * .what = status of a Logs Insights query
 */
export const SdkAwsQueryStatus = {
  Scheduled: 'Scheduled',
  Running: 'Running',
  Complete: 'Complete',
  Failed: 'Failed',
  Cancelled: 'Cancelled',
  Timeout: 'Timeout',
  Unknown: 'Unknown',
} as const;

export type SdkAwsQueryStatus = (typeof SdkAwsQueryStatus)[keyof typeof SdkAwsQueryStatus];
```

---

## Domain Operations

### CloudWatch Logs Operations

| Operation | Type | SDK Command | Description |
|-----------|------|-------------|-------------|
| `describeLogGroups` | getAll | `DescribeLogGroupsCommand` | List log groups, optionally filtered by prefix |
| `describeLogStreams` | getAll | `DescribeLogStreamsCommand` | List log streams within a log group |
| `getLogEvents` | getAll | `GetLogEventsCommand` | Retrieve log events from a specific log stream |
| `filterLogEvents` | getAll | `FilterLogEventsCommand` | Search log events across streams with filter patterns |
| `getLogGroupFields` | getOne | `GetLogGroupFieldsCommand` | Get fields and their frequency in a log group |
| `getLogRecord` | getOne | `GetLogRecordCommand` | Get a single log event by its pointer |
| `describeQueryDefinitions` | getAll | `DescribeQueryDefinitionsCommand` | List saved query definitions |

### Query Operations (Analytics)

| Operation | Type | SDK Command | Description |
|-----------|------|-------------|-------------|
| `startQuery` | execute | `StartQueryCommand` | Start a CloudWatch Logs Insights query |
| `stopQuery` | execute | `StopQueryCommand` | Cancel a running query |
| `getQueryResults` | getOne | `GetQueryResultsCommand` | Retrieve query results |
| `describeQueries` | getAll | `DescribeQueriesCommand` | List queries in progress or recently completed |

### Write Operations

| Operation | Type | SDK Command | Description |
|-----------|------|-------------|-------------|
| `createLogGroup` | setCreate | `CreateLogGroupCommand` | Create a new log group |
| `createLogStream` | setCreate | `CreateLogStreamCommand` | Create a new log stream |
| `deleteLogGroup` | setDelete | `DeleteLogGroupCommand` | Delete a log group |
| `deleteLogStream` | setDelete | `DeleteLogStreamCommand` | Delete a log stream |
| `putLogEvents` | setCreate | `PutLogEventsCommand` | Add log events to a stream |
| `putRetentionPolicy` | setUpdate | `PutRetentionPolicyCommand` | Set retention period |
| `deleteRetentionPolicy` | setDelete | `DeleteRetentionPolicyCommand` | Remove retention policy |
| `putQueryDefinition` | setCreate/setUpdate | `PutQueryDefinitionCommand` | Save a query definition |
| `deleteQueryDefinition` | setDelete | `DeleteQueryDefinitionCommand` | Remove a query definition |
| `putMetricFilter` | setCreate/setUpdate | `PutMetricFilterCommand` | Create/update a metric filter |
| `deleteMetricFilter` | setDelete | `DeleteMetricFilterCommand` | Remove a metric filter |

### CloudWatch Metrics Operations (for cost analysis)

| Operation | Type | SDK Command | Description |
|-----------|------|-------------|-------------|
| `getMetricStatistics` | getOne | `GetMetricStatisticsCommand` | Get statistics for a specific metric |
| `getMetricData` | getAll | `GetMetricDataCommand` | Batch metric retrieval with math expressions |
| `listMetrics` | getAll | `ListMetricsCommand` | List available metrics |

---

## Operation Input/Output Types

### StartQuery Input

```typescript
import type { QueryLanguage } from '@aws-sdk/client-cloudwatch-logs';

/**
 * .what = input for starting a Logs Insights query
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/StartQueryCommandInput/
 */
export interface SdkAwsStartQueryInput {
  /** epoch seconds - query start time (inclusive) */
  startTime: number;

  /** epoch seconds - query end time (inclusive) */
  endTime: number;

  /** the query string */
  queryString: string;

  /** query language: CWLI, SQL, or PPL */
  queryLanguage?: QueryLanguage;

  /** max log events to return (default 10000) */
  limit?: number;

  /** single log group to query */
  logGroupName?: string;

  /** up to 50 log group names */
  logGroupNames?: string[];

  /** up to 50 log groups by name or ARN */
  logGroupIdentifiers?: string[];
}
```

### GetQueryResults Output

```typescript
import type { QueryLanguage, QueryStatus } from '@aws-sdk/client-cloudwatch-logs';

/**
 * .what = output from getting Logs Insights query results
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/GetQueryResultsCommandOutput/
 */
export interface SdkAwsGetQueryResultsOutput {
  /** query execution status */
  status?: QueryStatus;

  /** query language used */
  queryLanguage?: QueryLanguage;

  /** nested array - each element is a log event with field/value pairs */
  results?: SdkAwsResultField[][];

  /** query execution statistics */
  statistics?: SdkAwsQueryStatistics;

  /** KMS key ARN if results are encrypted */
  encryptionKey?: string;
}
```

### GetMetricStatistics Input

```typescript
import type { Dimension, Statistic, StandardUnit } from '@aws-sdk/client-cloudwatch';

/**
 * .what = input for getting CloudWatch metric statistics
 * .refs
 *   - https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch/Interface/GetMetricStatisticsCommandInput/
 */
export interface SdkAwsGetMetricStatisticsInput {
  /** metric namespace (e.g., 'AWS/Logs') */
  Namespace: string;

  /** metric name (e.g., 'IncomingBytes') */
  MetricName: string;

  /** dimensions to filter by */
  Dimensions?: Dimension[];

  /** start time (inclusive) */
  StartTime: Date;

  /** end time (exclusive) */
  EndTime: Date;

  /** granularity in seconds */
  Period: number;

  /** statistics to retrieve: Sum, Average, Minimum, Maximum, SampleCount */
  Statistics?: Statistic[];

  /** percentile statistics (e.g., 'p99') */
  ExtendedStatistics?: string[];

  /** filter by unit */
  Unit?: StandardUnit;
}
```

---

## Key Metrics for Cost Analysis

| Namespace | Metric | Dimension | Description |
|-----------|--------|-----------|-------------|
| `AWS/Logs` | `IncomingBytes` | `LogGroupName` | Uncompressed bytes ingested |
| `AWS/Logs` | `IncomingLogEvents` | `LogGroupName` | Number of log events ingested |

**Cost Calculation:**
- Ingestion cost = `IncomingBytes * $0.50 / GB` (varies by region)
- Standard class: ~$0.50/GB ingested
- Infrequent Access class: ~$0.25/GB ingested

---

## Example Logs Insights Queries

### Get Common Message Patterns with Frequency and Size

```
fields @timestamp, @message
| stats count(*) as frequency,
        sum(strlen(@message)) as totalBytes,
        avg(strlen(@message)) as avgBytes
  by @message
| sort frequency desc
| limit 100
```

### Get Message Size Distribution

```
fields @message
| stats count(*) as count by strlen(@message) as messageSize
| sort messageSize desc
```

### Get Top Log Sources by Volume

```
stats sum(strlen(@message)) as totalBytes, count(*) as eventCount
  by @logStream
| sort totalBytes desc
| limit 20
```

---

## Key Constraints

1. **Query Concurrency**: Max 30 concurrent Logs Insights queries per account
2. **Query Time Range**: Max 24 hours of log events per batch (for best performance)
3. **Log Event Size**: Max 1MB per log event
4. **Batch Size**: Max 10,000 log events or 1MB per API call
5. **Rate Limits**: GetLogEvents/FilterLogEvents are not scalable for large volumes
6. **StoredBytes Delay**: `storedBytes` attribute updates ~24 hours behind real-time
7. **Query Results Limit**: Default 10,000 results per query

---

## Sources

- [CloudWatch Logs Concepts](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CloudWatchLogsConcepts.html)
- [Log Classes](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CloudWatch_Logs_Log_Classes.html)
- [AWS SDK LogGroup Interface](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/LogGroup/)
- [AWS SDK LogStream Interface](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/LogStream/)
- [AWS SDK OutputLogEvent Interface](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/OutputLogEvent/)
- [AWS SDK QueryDefinition Interface](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/QueryDefinition/)
- [AWS SDK MetricFilter Interface](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/MetricFilter/)
- [AWS SDK StartQueryCommandInput](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/StartQueryCommandInput/)
- [AWS SDK GetQueryResultsCommandOutput](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch-logs/Interface/GetQueryResultsCommandOutput/)
- [AWS SDK GetMetricStatisticsCommandInput](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/Package/-aws-sdk-client-cloudwatch/Interface/GetMetricStatisticsCommandInput/)
- [Logs Insights Query Syntax](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html)
- [Monitoring with CloudWatch Metrics](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CloudWatch-Logs-Monitoring-CloudWatch-Metrics.html)
