# Implementation Roadmap: Lambda Log Trends

This roadmap provides a checklist-style execution plan for the blueprint in `3.3.blueprint.v1.i1.md`, with ordered dependencies and behavioral acceptance criteria at each step.

---

## Phase 0: Setup

### 0.1 Install Dependencies

- [ ] **Install AWS SDK packages**

  ```bash
  npm install @aws-sdk/client-cloudwatch-logs @aws-sdk/client-cloudwatch
  ```

  **Acceptance Criteria**:
  - `@aws-sdk/client-cloudwatch-logs` appears in `package.json` dependencies
  - `@aws-sdk/client-cloudwatch` appears in `package.json` dependencies

  **Verification**:
  ```bash
  npm ls @aws-sdk/client-cloudwatch-logs @aws-sdk/client-cloudwatch
  ```

---

## Phase 1: Domain Objects

### 1.1 Create `DeclaredAwsLogGroup`

**Dependencies**: None

- [ ] **Create `src/domain.objects/DeclaredAwsLogGroup.ts`**

  **Acceptance Criteria**:
  - File exports `DeclaredAwsLogGroup` interface and class
  - Class extends `DomainEntity<DeclaredAwsLogGroup>`
  - `public static primary = ['arn']`
  - `public static unique = ['name']`
  - `public static metadata = ['arn']`
  - `public static readonly = ['storedBytes', 'createdAt', 'retentionInDays']`

  **Verification**:
  ```bash
  npm run test:types
  ```

- [ ] **Create `src/domain.objects/DeclaredAwsLogGroup.test.ts`**

  **Acceptance Criteria**:
  - Test `DeclaredAwsLogGroup.as()` creates valid instance
  - Test validates required fields (`name`, `class`, `kmsKeyId`)
  - Test optional readonly fields can be omitted

  **Verification**:
  ```bash
  npm run test:unit -- DeclaredAwsLogGroup.test.ts
  ```

---

### 1.2 Create `DeclaredAwsLogGroupReportDistOfPattern`

**Dependencies**: 1.1

- [ ] **Create `src/domain.objects/DeclaredAwsLogGroupReportDistOfPattern.ts`**

  **Acceptance Criteria**:
  - File exports `DeclaredAwsLogGroupReportDistOfPatternRow` literal class
  - File exports `DeclaredAwsLogGroupReportDistOfPattern` entity class
  - Entity has `public static primary = []` (no primary key)
  - Entity has `public static unique = ['logGroups', 'range', 'pattern', 'filter', 'limit']`
  - Entity has `public static readonly = ['entries', 'scannedBytes', 'matchedEvents']`
  - Entity has `public static nested` with `logGroups` and `entries`

  **Verification**:
  ```bash
  npm run test:types
  ```

- [ ] **Create `src/domain.objects/DeclaredAwsLogGroupReportDistOfPattern.test.ts`**

  **Acceptance Criteria**:
  - Test `DeclaredAwsLogGroupReportDistOfPatternRow.as()` creates valid instance
  - Test `DeclaredAwsLogGroupReportDistOfPattern.as()` creates valid instance
  - Test nested `entries` array works correctly
  - Test `percentOfTotal: { frequency, bytes }` structure

  **Verification**:
  ```bash
  npm run test:unit -- DeclaredAwsLogGroupReportDistOfPattern.test.ts
  ```

---

### 1.3 Create `DeclaredAwsLogGroupReportCostOfIngestion`

**Dependencies**: None (parallel with 1.2)

- [ ] **Create `src/domain.objects/DeclaredAwsLogGroupReportCostOfIngestion.ts`**

  **Acceptance Criteria**:
  - File exports `DeclaredAwsLogGroupFilter` type (PickOne)
  - File exports `DeclaredAwsLogGroupReportCostOfIngestionRow` literal class
  - File exports `DeclaredAwsLogGroupReportCostOfIngestion` entity class
  - Entity has `public static primary = []`
  - Entity has `public static unique = ['logGroupFilter', 'range']`
  - Entity has `public static readonly = ['entries', 'totalIngestedBytes', 'totalLogEvents', 'totalEstimatedCostUsd']`

  **Verification**:
  ```bash
  npm run test:types
  ```

- [ ] **Create `src/domain.objects/DeclaredAwsLogGroupReportCostOfIngestion.test.ts`**

  **Acceptance Criteria**:
  - Test `DeclaredAwsLogGroupReportCostOfIngestionRow.as()` creates valid instance
  - Test `DeclaredAwsLogGroupReportCostOfIngestion.as()` creates valid instance
  - Test `logGroupFilter` with `{ prefix }` works
  - Test `logGroupFilter` with `{ names }` works
  - Test `percentOfTotal: { bytes, events }` structure

  **Verification**:
  ```bash
  npm run test:unit -- DeclaredAwsLogGroupReportCostOfIngestion.test.ts
  ```

---

## Phase 2: Domain Operations - Log Group

### 2.1 Create `castIntoDeclaredAwsLogGroup`

**Dependencies**: 1.1

- [ ] **Create `src/domain.operations/logGroup/castIntoDeclaredAwsLogGroup.ts`**

  **Acceptance Criteria**:
  - Function accepts AWS SDK `LogGroup` type
  - Function returns `HasReadonly<typeof DeclaredAwsLogGroup>`
  - Maps `logGroupName` → `name`
  - Maps `logGroupClass` → `class` (defaults to `'STANDARD'`)
  - Maps `creationTime` → `createdAt` (ISO string)
  - Handles missing optional fields

  **Verification**:
  ```bash
  npm run test:types
  ```

- [ ] **Create `src/domain.operations/logGroup/castIntoDeclaredAwsLogGroup.test.ts`**

  **Acceptance Criteria**:
  - Test maps all fields correctly
  - Test handles missing `logGroupClass` (defaults to STANDARD)
  - Test handles missing `kmsKeyId` (null)
  - Test handles missing `creationTime` (undefined)

  **Verification**:
  ```bash
  npm run test:unit -- castIntoDeclaredAwsLogGroup.test.ts
  ```

---

### 2.2 Create `getOneLogGroup`

**Dependencies**: 2.1

- [ ] **Create `src/domain.operations/logGroup/getOneLogGroup.ts`**

  **Acceptance Criteria**:
  - Function accepts `by.primary`, `by.unique`, or `by.ref`
  - Uses `DescribeLogGroupsCommand` with `logGroupNamePrefix`
  - Returns `null` if log group not found
  - Casts result via `castIntoDeclaredAwsLogGroup`
  - Wrapped with `asProcedure`

  **Verification**:
  ```bash
  npm run test:types
  ```

- [ ] **Create `src/domain.operations/logGroup/getOneLogGroup.test.ts`**

  **Acceptance Criteria**:
  - Test routes `by.primary` correctly
  - Test routes `by.unique` correctly
  - Test routes `by.ref` (unique) correctly
  - Test routes `by.ref` (primary) correctly
  - Test returns `null` when not found
  - Test throws on AWS errors

  **Verification**:
  ```bash
  npm run test:unit -- getOneLogGroup.test.ts
  ```

- [ ] **Create `src/domain.operations/logGroup/getOneLogGroup.integration.test.ts`**

  **Acceptance Criteria**:
  - Test retrieves real log group by name
  - Test returns `null` for non-existent log group
  - Test readonly fields are populated

  **Verification**:
  ```bash
  npm run test:integration -- getOneLogGroup.integration.test.ts
  ```

---

### 2.3 Create `getAllLogGroups`

**Dependencies**: 2.1

- [ ] **Create `src/domain.operations/logGroup/getAllLogGroups.ts`**

  **Acceptance Criteria**:
  - Function accepts `by.prefix` filter (optional)
  - Uses `paginateDescribeLogGroups` for pagination
  - Casts each result via `castIntoDeclaredAwsLogGroup`
  - Returns array of `HasReadonly<typeof DeclaredAwsLogGroup>`
  - Wrapped with `asProcedure`

  **Verification**:
  ```bash
  npm run test:types
  ```

- [ ] **Create `src/domain.operations/logGroup/getAllLogGroups.test.ts`**

  **Acceptance Criteria**:
  - Test returns all log groups when no prefix
  - Test filters by prefix
  - Test handles pagination
  - Test returns empty array when no matches

  **Verification**:
  ```bash
  npm run test:unit -- getAllLogGroups.test.ts
  ```

- [ ] **Create `src/domain.operations/logGroup/getAllLogGroups.integration.test.ts`**

  **Acceptance Criteria**:
  - Test retrieves log groups with `/aws/lambda/` prefix
  - Test returns non-empty array
  - Test each result has readonly fields

  **Verification**:
  ```bash
  npm run test:integration -- getAllLogGroups.integration.test.ts
  ```

---

## Phase 3: Domain Operations - Distribution Report

### 3.1 Create `castIntoDeclaredAwsLogGroupReportDistOfPattern`

**Dependencies**: 1.2

- [ ] **Create `src/domain.operations/logGroupReportDistOfPattern/castIntoDeclaredAwsLogGroupReportDistOfPattern.ts`**

  **Acceptance Criteria**:
  - Function accepts query input and `GetQueryResultsCommandOutput`
  - Parses `results.results` array
  - Extracts `pattern`, `frequency`, `totalBytes`, `avgBytes` from each row
  - Calculates `percentOfTotal.frequency` and `percentOfTotal.bytes`
  - Returns `HasReadonly<typeof DeclaredAwsLogGroupReportDistOfPattern>`

  **Verification**:
  ```bash
  npm run test:types
  ```

- [ ] **Create `src/domain.operations/logGroupReportDistOfPattern/castIntoDeclaredAwsLogGroupReportDistOfPattern.test.ts`**

  **Acceptance Criteria**:
  - Test parses query results correctly
  - Test calculates `percentOfTotal` correctly
  - Test handles empty results
  - Test preserves input unique key fields

  **Verification**:
  ```bash
  npm run test:unit -- castIntoDeclaredAwsLogGroupReportDistOfPattern.test.ts
  ```

---

### 3.2 Create `getOneLogGroupReportDistOfPattern`

**Dependencies**: 3.1, 2.2

- [ ] **Create `src/domain.operations/logGroupReportDistOfPattern/getOneLogGroupReportDistOfPattern.ts`**

  **Acceptance Criteria**:
  - Function accepts `by.unique` with `logGroups`, `range`, `pattern`, `filter`, `limit`
  - Builds CloudWatch Logs Insights query string
  - Executes `StartQueryCommand`
  - Polls `GetQueryResultsCommand` with exponential backoff
  - Handles `Complete`, `Failed`, `Cancelled`, `Timeout` statuses
  - Casts results via `castIntoDeclaredAwsLogGroupReportDistOfPattern`
  - Wrapped with `asProcedure`

  **Verification**:
  ```bash
  npm run test:types
  ```

- [ ] **Create `src/domain.operations/logGroupReportDistOfPattern/getOneLogGroupReportDistOfPattern.test.ts`**

  **Acceptance Criteria**:
  - Test builds query string correctly with pattern
  - Test builds query string correctly with filter
  - Test builds query string correctly with limit
  - Test polls until Complete
  - Test throws on Failed status
  - Test throws on Cancelled status

  **Verification**:
  ```bash
  npm run test:unit -- getOneLogGroupReportDistOfPattern.test.ts
  ```

- [ ] **Create `src/domain.operations/logGroupReportDistOfPattern/getOneLogGroupReportDistOfPattern.integration.test.ts`**

  **Acceptance Criteria**:
  - Test queries real log group with `@message` pattern
  - Test returns entries with `value`, `frequency`, `totalBytes`, `avgBytes`
  - Test `percentOfTotal` values sum correctly
  - Test respects `limit` parameter

  **Verification**:
  ```bash
  npm run test:integration -- getOneLogGroupReportDistOfPattern.integration.test.ts
  ```

---

## Phase 4: Domain Operations - Cost Report

### 4.1 Create `castIntoDeclaredAwsLogGroupReportCostOfIngestion`

**Dependencies**: 1.3

- [ ] **Create `src/domain.operations/logGroupReportCostOfIngestion/castIntoDeclaredAwsLogGroupReportCostOfIngestion.ts`**

  **Acceptance Criteria**:
  - Function accepts query input, resolved log groups, and `GetMetricDataCommandOutput`
  - Matches metric results to log groups by ID
  - Calculates `estimatedCostUsd = (ingestedBytes / 1024^3) * 0.50`
  - Calculates `totalIngestedBytes`, `totalLogEvents`, `totalEstimatedCostUsd`
  - Calculates `percentOfTotal.bytes` and `percentOfTotal.events`
  - Sorts entries by `ingestedBytes` descending
  - Returns `HasReadonly<typeof DeclaredAwsLogGroupReportCostOfIngestion>`

  **Verification**:
  ```bash
  npm run test:types
  ```

- [ ] **Create `src/domain.operations/logGroupReportCostOfIngestion/castIntoDeclaredAwsLogGroupReportCostOfIngestion.test.ts`**

  **Acceptance Criteria**:
  - Test matches metrics to log groups
  - Test calculates cost correctly ($0.50/GB)
  - Test calculates totals correctly
  - Test calculates percentOfTotal correctly
  - Test sorts by ingestedBytes descending
  - Test handles empty metrics

  **Verification**:
  ```bash
  npm run test:unit -- castIntoDeclaredAwsLogGroupReportCostOfIngestion.test.ts
  ```

---

### 4.2 Create `getOneLogGroupReportCostOfIngestion`

**Dependencies**: 4.1, 2.2, 2.3

- [ ] **Create `src/domain.operations/logGroupReportCostOfIngestion/getOneLogGroupReportCostOfIngestion.ts`**

  **Acceptance Criteria**:
  - Function accepts `by.unique` with `logGroupFilter`, `range`
  - Resolves log groups from filter (prefix or names)
  - Builds metric queries for `IncomingBytes` and `IncomingLogEvents`
  - Batches metric queries (max 500 per request)
  - Executes `GetMetricDataCommand`
  - Casts results via `castIntoDeclaredAwsLogGroupReportCostOfIngestion`
  - Wrapped with `asProcedure`

  **Verification**:
  ```bash
  npm run test:types
  ```

- [ ] **Create `src/domain.operations/logGroupReportCostOfIngestion/getOneLogGroupReportCostOfIngestion.test.ts`**

  **Acceptance Criteria**:
  - Test resolves log groups from `{ prefix }`
  - Test resolves log groups from `{ names }`
  - Test builds metric queries correctly
  - Test batches large metric requests
  - Test handles empty log group list

  **Verification**:
  ```bash
  npm run test:unit -- getOneLogGroupReportCostOfIngestion.test.ts
  ```

- [ ] **Create `src/domain.operations/logGroupReportCostOfIngestion/getOneLogGroupReportCostOfIngestion.integration.test.ts`**

  **Acceptance Criteria**:
  - Test queries real log groups with `/aws/lambda/` prefix
  - Test returns entries with `logGroupName`, `ingestedBytes`, `logEvents`, `estimatedCostUsd`
  - Test `totalIngestedBytes` equals sum of entries
  - Test `percentOfTotal` values sum to ~100%

  **Verification**:
  ```bash
  npm run test:integration -- getOneLogGroupReportCostOfIngestion.integration.test.ts
  ```

---

## Phase 5: Access DAOs

### 5.1 Create `DeclaredAwsLogGroupDao`

**Dependencies**: 2.2

- [ ] **Create `src/access/daos/DeclaredAwsLogGroupDao.ts`**

  **Acceptance Criteria**:
  - Exports `DeclaredAwsLogGroupDao` as `DeclastructDao`
  - Implements `get.byPrimary`, `get.byUnique`, `get.byRef`
  - No `set` operations (log groups are auto-created)

  **Verification**:
  ```bash
  npm run test:types
  ```

---

### 5.2 Create `DeclaredAwsLogGroupReportDistOfPatternDao`

**Dependencies**: 3.2

- [ ] **Create `src/access/daos/DeclaredAwsLogGroupReportDistOfPatternDao.ts`**

  **Acceptance Criteria**:
  - Exports `DeclaredAwsLogGroupReportDistOfPatternDao` as `DeclastructDao`
  - Implements `get.byUnique`, `get.byRef`
  - No `get.byPrimary` (entity has no primary key)
  - No `set` operations (readonly derived entity)

  **Verification**:
  ```bash
  npm run test:types
  ```

---

### 5.3 Create `DeclaredAwsLogGroupReportCostOfIngestionDao`

**Dependencies**: 4.2

- [ ] **Create `src/access/daos/DeclaredAwsLogGroupReportCostOfIngestionDao.ts`**

  **Acceptance Criteria**:
  - Exports `DeclaredAwsLogGroupReportCostOfIngestionDao` as `DeclastructDao`
  - Implements `get.byUnique`, `get.byRef`
  - No `get.byPrimary` (entity has no primary key)
  - No `set` operations (readonly derived entity)

  **Verification**:
  ```bash
  npm run test:types
  ```

---

## Phase 6: Exports & Provider

### 6.1 Update SDK Exports

**Dependencies**: 5.1, 5.2, 5.3

- [ ] **Update `src/contract/sdks/index.ts`**

  **Acceptance Criteria**:
  - Exports `DeclaredAwsLogGroup`
  - Exports `DeclaredAwsLogGroupReportDistOfPattern`, `DeclaredAwsLogGroupReportDistOfPatternRow`
  - Exports `DeclaredAwsLogGroupReportCostOfIngestion`, `DeclaredAwsLogGroupReportCostOfIngestionRow`, `DeclaredAwsLogGroupFilter`
  - Exports `getOneLogGroup`, `getAllLogGroups`
  - Exports `getOneLogGroupReportDistOfPattern`
  - Exports `getOneLogGroupReportCostOfIngestion`
  - Exports `DeclaredAwsLogGroupDao`, `DeclaredAwsLogGroupReportDistOfPatternDao`, `DeclaredAwsLogGroupReportCostOfIngestionDao`

  **Verification**:
  ```bash
  npm run test:types
  ```

---

### 6.2 Update Provider Type

**Dependencies**: 6.1

- [ ] **Update `src/domain.objects/DeclastructAwsProvider.ts`**

  **Acceptance Criteria**:
  - `DeclastructAwsProvider` type includes `DeclaredAwsLogGroup` DAO
  - `DeclastructAwsProvider` type includes `DeclaredAwsLogGroupReportDistOfPattern` DAO
  - `DeclastructAwsProvider` type includes `DeclaredAwsLogGroupReportCostOfIngestion` DAO

  **Verification**:
  ```bash
  npm run test:types
  ```

---

## Phase 7: Final Verification

### 7.1 Run All Tests

**Dependencies**: All previous phases

- [ ] **Run unit tests**

  **Verification**:
  ```bash
  npm run test:unit
  ```

- [ ] **Run integration tests**

  **Verification**:
  ```bash
  npm run test:integration
  ```

- [ ] **Run type checks**

  **Verification**:
  ```bash
  npm run test:types
  ```

- [ ] **Run linting**

  **Verification**:
  ```bash
  npm run test:lint
  ```

---

### 7.2 End-to-End Acceptance Test

**Dependencies**: 7.1

- [ ] **Create acceptance test for wish fulfillment**

  **Acceptance Criteria**:
  - Can retrieve cost report for `/aws/lambda/` prefix
  - Cost report shows `totalEstimatedCostUsd`
  - Cost report entries sorted by `ingestedBytes` descending
  - Can drill into top log group for pattern distribution
  - Pattern distribution shows `@message` frequencies
  - Pattern distribution shows `percentOfTotal.bytes`

  **Verification**:
  ```typescript
  // Test script
  const costReport = await getOneLogGroupReportCostOfIngestion({
    by: {
      unique: {
        logGroupFilter: { prefix: '/aws/lambda/' },
        range: { since: '2024-11-01T00:00:00Z', until: '2024-11-30T23:59:59Z' },
      },
    },
  }, context);

  expect(costReport.totalEstimatedCostUsd).toBeGreaterThan(0);
  expect(costReport.entries).toBeDefined();
  expect(costReport.entries![0].ingestedBytes).toBeGreaterThanOrEqual(costReport.entries![1]?.ingestedBytes ?? 0);

  const distribution = await getOneLogGroupReportDistOfPattern({
    by: {
      unique: {
        logGroups: [{ name: costReport.entries![0].logGroupName }],
        range: { since: '2024-11-01T00:00:00Z', until: '2024-11-30T23:59:59Z' },
        pattern: '@message',
        filter: null,
        limit: 100,
      },
    },
  }, context);

  expect(distribution.entries).toBeDefined();
  expect(distribution.entries!.length).toBeGreaterThan(0);
  expect(distribution.entries![0].percentOfTotal.bytes).toBeGreaterThan(0);
  ```

---

## Summary: Dependency Graph

```
Phase 0: Setup
  └── 0.1 Install Dependencies

Phase 1: Domain Objects (parallel)
  ├── 1.1 DeclaredAwsLogGroup
  ├── 1.2 DeclaredAwsLogGroupReportDistOfPattern (depends: 1.1)
  └── 1.3 DeclaredAwsLogGroupReportCostOfIngestion

Phase 2: Log Group Operations
  ├── 2.1 castIntoDeclaredAwsLogGroup (depends: 1.1)
  ├── 2.2 getOneLogGroup (depends: 2.1)
  └── 2.3 getAllLogGroups (depends: 2.1)

Phase 3: Distribution Report Operations
  ├── 3.1 castIntoDeclaredAwsLogGroupReportDistOfPattern (depends: 1.2)
  └── 3.2 getOneLogGroupReportDistOfPattern (depends: 3.1, 2.2)

Phase 4: Cost Report Operations
  ├── 4.1 castIntoDeclaredAwsLogGroupReportCostOfIngestion (depends: 1.3)
  └── 4.2 getOneLogGroupReportCostOfIngestion (depends: 4.1, 2.2, 2.3)

Phase 5: Access DAOs
  ├── 5.1 DeclaredAwsLogGroupDao (depends: 2.2)
  ├── 5.2 DeclaredAwsLogGroupReportDistOfPatternDao (depends: 3.2)
  └── 5.3 DeclaredAwsLogGroupReportCostOfIngestionDao (depends: 4.2)

Phase 6: Exports & Provider
  ├── 6.1 Update SDK Exports (depends: 5.1, 5.2, 5.3)
  └── 6.2 Update Provider Type (depends: 6.1)

Phase 7: Final Verification
  ├── 7.1 Run All Tests (depends: all)
  └── 7.2 End-to-End Acceptance Test (depends: 7.1)
```

---

## Checklist Summary

| Step | Description | Dependencies |
|------|-------------|--------------|
| 0.1 | Install Dependencies | - |
| 1.1 | DeclaredAwsLogGroup | 0.1 |
| 1.2 | DeclaredAwsLogGroupReportDistOfPattern | 1.1 |
| 1.3 | DeclaredAwsLogGroupReportCostOfIngestion | 0.1 |
| 2.1 | castIntoDeclaredAwsLogGroup | 1.1 |
| 2.2 | getOneLogGroup | 2.1 |
| 2.3 | getAllLogGroups | 2.1 |
| 3.1 | castIntoDeclaredAwsLogGroupReportDistOfPattern | 1.2 |
| 3.2 | getOneLogGroupReportDistOfPattern | 3.1, 2.2 |
| 4.1 | castIntoDeclaredAwsLogGroupReportCostOfIngestion | 1.3 |
| 4.2 | getOneLogGroupReportCostOfIngestion | 4.1, 2.2, 2.3 |
| 5.1 | DeclaredAwsLogGroupDao | 2.2 |
| 5.2 | DeclaredAwsLogGroupReportDistOfPatternDao | 3.2 |
| 5.3 | DeclaredAwsLogGroupReportCostOfIngestionDao | 4.2 |
| 6.1 | Update SDK Exports | 5.1, 5.2, 5.3 |
| 6.2 | Update Provider Type | 6.1 |
| 7.1 | Run All Tests | all |
| 7.2 | End-to-End Acceptance Test | 7.1 |
