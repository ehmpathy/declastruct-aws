# AWS Domain Research for Lambda Log Trends Wish

## Context

The wish is to declaratively:
1. Get a histogram of log messages emitted by a given set of lambdas
   - What are the common `.message` attributes?
   - How often do they occur?
   - How large are the messages?
2. Optionally get the report of ingestion cost declaratively

This research documents the AWS domain objects and operations available to fulfill this wish.

---

## Domain Objects

### Entities

#### LogGroup
The primary container for log streams. For Lambda functions, automatically created with pattern `/aws/lambda/<function-name>`.

**Key Attributes:**
- `arn`: Amazon Resource Name
- `logGroupName`: Name of the log group (e.g., `/aws/lambda/svc-chat-prod-getDisplayableMessages`)
- `logGroupClass`: `STANDARD`, `INFREQUENT_ACCESS`, or `DELIVERY`
- `retentionInDays`: How long logs are retained
- `storedBytes`: Total bytes stored (updated with ~24hr delay)
- `kmsKeyId`: Optional KMS key for encryption
- `creationTime`: When the log group was created

#### LogStream
A sequence of log events from a single source (e.g., one Lambda instance).

**Key Attributes:**
- `arn`: Amazon Resource Name
- `logStreamName`: Name (Lambda pattern: `YYYY/MM/DD/[<FunctionVersion>]<InstanceId>`)
- `creationTime`: When the stream was created
- `firstEventTimestamp`: Timestamp of first log event
- `lastEventTimestamp`: Timestamp of most recent log event
- `lastIngestionTime`: When CloudWatch last received a log event
- `storedBytes`: Bytes stored in this stream

#### LogEvent
The fundamental unit of log data.

**Key Attributes:**
- `timestamp`: Milliseconds since epoch (Jan 1, 1970 00:00:00 UTC)
- `message`: The log message content (max 1MB per event)
- `ingestionTime`: When CloudWatch received the event

#### QueryDefinition
A saved CloudWatch Logs Insights query.

**Key Attributes:**
- `queryDefinitionId`: Unique identifier
- `name`: Query name
- `queryString`: The query definition
- `logGroupNames`: Associated log groups

#### MetricFilter
Transforms log data into CloudWatch metrics.

**Key Attributes:**
- `filterName`: Name of the filter
- `filterPattern`: Pattern to match log events
- `metricTransformations`: How to create metrics from matches

### Events (System Fields in Log Events)

CloudWatch Logs auto-generates these fields for each log event:

- `@timestamp`: When the log event occurred
- `@ingestionTime`: When CloudWatch received the event
- `@logStream`: Name of the log stream
- `@log`: Log group identifier (`account-id:log-group-name`)
- `@message`: The raw log message

For Lambda-specific logs, additional fields are auto-extracted:
- `@type`: Event type (e.g., `REPORT`, `START`, `END`)
- `@duration`: Execution duration (ms)
- `@billedDuration`: Billed duration (ms)
- `@memorySize`: Configured memory (bytes)
- `@maxMemoryUsed`: Peak memory usage (bytes)
- `@requestId`: Lambda invocation request ID

### Literals

#### Log Group Classes
- `STANDARD`: Full feature set
- `INFREQUENT_ACCESS`: Reduced features, lower cost
- `DELIVERY`: For delivering Lambda logs to S3/Firehose only

#### Query Languages
- `CWLI`: CloudWatch Logs Insights Query Language
- `SQL`: OpenSearch SQL
- `PPL`: OpenSearch Piped Processing Language

#### Query Status Values
- `Scheduled`
- `Running`
- `Complete`
- `Failed`
- `Cancelled`
- `Timeout`

#### Metric Namespaces
- `AWS/Logs`: Standard CloudWatch Logs metrics
  - `IncomingBytes`: Uncompressed bytes ingested
  - `IncomingLogEvents`: Number of log events ingested

---

## Domain Operations

### Read Operations (getOne / getAll)

| Operation | Type | Description |
|-----------|------|-------------|
| `DescribeLogGroups` | getAll | List log groups, optionally filtered by prefix |
| `DescribeLogStreams` | getAll | List log streams within a log group |
| `GetLogEvents` | getAll | Retrieve log events from a specific log stream |
| `FilterLogEvents` | getAll | Search log events across streams with filter patterns |
| `GetLogGroupFields` | getOne | Get fields and their frequency in a log group |
| `GetLogRecord` | getOne | Get a single log event by its pointer |
| `DescribeQueryDefinitions` | getAll | List saved query definitions |
| `GetQueryResults` | getOne | Get results from a completed Insights query |

### Query Operations (for analytics)

| Operation | Type | Description |
|-----------|------|-------------|
| `StartQuery` | execute | Start a CloudWatch Logs Insights query |
| `StopQuery` | execute | Cancel a running query |
| `GetQueryResults` | getOne | Retrieve query results |
| `DescribeQueries` | getAll | List queries in progress or recently completed |

**Logs Insights Query Commands:**
- `fields`: Select specific fields
- `filter`: Filter log events
- `stats`: Aggregate with functions (`count`, `sum`, `avg`, `min`, `max`, `pct`)
- `sort`: Order results
- `limit`: Restrict result count
- `parse`: Extract fields using glob or regex patterns
- `display`: Format output

**Key Aggregation Functions:**
```
stats count(*) by bin(1h)                    # Count by time bucket
stats sum(strlen(@message)) as totalBytes    # Sum message sizes
stats count(*) by @message                   # Group by message content
```

### Write Operations (setCreate / setUpdate / setDelete)

| Operation | Type | Description |
|-----------|------|-------------|
| `CreateLogGroup` | setCreate | Create a new log group |
| `CreateLogStream` | setCreate | Create a new log stream |
| `DeleteLogGroup` | setDelete | Delete a log group |
| `DeleteLogStream` | setDelete | Delete a log stream |
| `PutLogEvents` | setCreate | Add log events to a stream |
| `PutRetentionPolicy` | setUpdate | Set retention period |
| `DeleteRetentionPolicy` | setDelete | Remove retention policy |
| `PutQueryDefinition` | setCreate/setUpdate | Save a query definition |
| `DeleteQueryDefinition` | setDelete | Remove a query definition |
| `PutMetricFilter` | setCreate/setUpdate | Create/update a metric filter |
| `DeleteMetricFilter` | setDelete | Remove a metric filter |

### Metrics Operations (for cost analysis)

| Operation | Namespace | Metric | Description |
|-----------|-----------|--------|-------------|
| `GetMetricStatistics` | `AWS/Logs` | `IncomingBytes` | Bytes ingested per log group |
| `GetMetricStatistics` | `AWS/Logs` | `IncomingLogEvents` | Events ingested per log group |
| `GetMetricData` | `AWS/Logs` | Multiple | Batch metric retrieval with math |

**Example: Get ingestion bytes for a log group:**
```bash
aws cloudwatch get-metric-statistics \
  --namespace AWS/Logs \
  --metric-name IncomingBytes \
  --dimensions Name=LogGroupName,Value=/aws/lambda/my-function \
  --start-time 2024-01-01T00:00:00Z \
  --end-time 2024-01-31T23:59:59Z \
  --period 2592000 \
  --statistics Sum
```

---

## Relevant for the Wish

### To Get Log Message Histograms

**Primary Approach: CloudWatch Logs Insights**

```
# Get common message patterns with frequency and size
fields @timestamp, @message
| stats count(*) as frequency,
        sum(strlen(@message)) as totalBytes,
        avg(strlen(@message)) as avgBytes
  by @message
| sort frequency desc
| limit 100
```

**Operations Needed:**
1. `DescribeLogGroups` - Find log groups matching lambda patterns
2. `StartQuery` - Execute Logs Insights query
3. `GetQueryResults` - Retrieve aggregated results

### To Get Ingestion Cost Report

**Primary Approach: CloudWatch Metrics**

```
GetMetricData with:
  Namespace: AWS/Logs
  MetricName: IncomingBytes
  Dimensions: LogGroupName
  Period: 86400 (daily) or 2592000 (monthly)
  Statistics: Sum
```

**Cost Calculation:**
- Ingestion cost = `IncomingBytes * $0.50 / GB` (varies by region)

---

## Key Constraints

1. **Query Concurrency**: Max 30 concurrent Logs Insights queries
2. **Query Time Range**: Queries can span up to 24 hours of log events per batch
3. **Log Event Size**: Max 1MB per log event
4. **Batch Size**: Max 10,000 log events or 1MB per API call
5. **Rate Limits**: GetLogEvents/FilterLogEvents are not scalable for large volumes
6. **StoredBytes Delay**: `storedBytes` attribute updates ~24 hours behind real-time

---

## Sources

- [CloudWatch Logs Concepts](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CloudWatchLogsConcepts.html)
- [LogGroup API Reference](https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_LogGroup.html)
- [DescribeLogStreams API](https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_DescribeLogStreams.html)
- [GetLogEvents API](https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_GetLogEvents.html)
- [FilterLogEvents API](https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_FilterLogEvents.html)
- [StartQuery API](https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_StartQuery.html)
- [GetQueryResults API](https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_GetQueryResults.html)
- [GetLogGroupFields API](https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_GetLogGroupFields.html)
- [Logs Insights Query Syntax](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax.html)
- [Stats Query Command](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax-Stats.html)
- [Parse Query Command](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax-Parse.html)
- [Sample Queries](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CWL_QuerySyntax-examples.html)
- [Monitoring with CloudWatch Metrics](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CloudWatch-Logs-Monitoring-CloudWatch-Metrics.html)
- [Lambda CloudWatch Log Groups](https://docs.aws.amazon.com/lambda/latest/dg/monitoring-cloudwatchlogs-loggroups.html)
- [Determine Log Group Bill Increase](https://repost.aws/knowledge-center/cloudwatch-logs-bill-increase)
