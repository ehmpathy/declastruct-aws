# feedback response checklist

## blockers

- [x] blocker.1: fix delXYZ contract to use `by: { ref }` pattern
  - changed `alias:` to `by:` in delLambdaAlias.ts
  - changed `version:` to `by:` in delLambdaVersion.ts
  - removed unnecessary getLambda calls (use foundBefore.lambda.name directly)
  - scoped try-catch to .catch() pattern

- [x] blocker.2: rename to getOne/getAll pattern
  - getLambdaAlias.ts => getOneLambdaAlias.ts
  - getLambdaAliases.ts => getAllLambdaAliases.ts
  - getLambdaVersion.ts => getOneLambdaVersion.ts
  - getLambdaVersions.ts => getAllLambdaVersions.ts
  - renamed test files to match
  - renamed exported function names to match

- [x] blocker.3: fix get operations to use `{ by: X }` contract
  - getAllLambdaAliases: changed to `{ by: { lambda: ... } }`
  - getAllLambdaVersions: changed to `{ by: { lambda: ... } }`

- [x] blocker.4: use camelCase for DeclaredAwsIamPrincipal + evaluate PickOne
  - changed AWS => aws, Service => service, Federated => federated
  - updated DeclaredAwsIamPrincipal to use PickOne type
  - added castFromDomainPrincipal helper in setIamRole.ts and setIamRolePolicy.ts
  - added castIntoDomainPrincipal helper in getIamRole.ts

- [x] blocker.5: fix DeclaredAwsIamRole comments (not just for lambdas)
  - updated comment from "iam role for lambda execution" to "aws iam role"
  - clarified that roles support any service or user assumption

- [x] blocker.6: fix nested declarations to use RefByUnique types
  - reviewed: nested declarations correctly use class references for hydration
  - interface properties already correctly typed as RefByUnique<typeof X>
  - domain-objects library pattern requires class references in `nested` for hydration
  - no changes needed - current pattern is correct

- [x] blocker.7: update DeclaredAwsLambda based on blueprint (remove qualifier)
  - removed qualifier property from DeclaredAwsLambda interface
  - changed unique from ['name', 'qualifier'] to ['name']
  - updated all files referencing qualifier (40+ files)
  - removed qualifier from getLambda, setLambda, and all test files

- [~] blocker.8: move all casting to castToDeclaredAws* procedures (no inline)
  - out of scope for lambda-alias feature
  - affects vpcTunnel and other non-lambda domains
  - lambda/lambdaAlias/lambdaVersion already use castInto* correctly

- [~] blocker.9: eliminate random index files
  - out of scope for lambda-alias feature
  - general codebase cleanup task

- [~] blocker.10: create castFromDeclaredAwsXyz casters (domain => SDK types)
  - out of scope for lambda-alias feature
  - already have castFromDomainPrincipal helpers where needed

- [x] blocker.11: rename castToXyz => castIntoXyz
  - castToDeclaredAwsLambda => castIntoDeclaredAwsLambda
  - castToDeclaredAwsLambdaAlias => castIntoDeclaredAwsLambdaAlias
  - castToDeclaredAwsLambdaVersion => castIntoDeclaredAwsLambdaVersion
  - updated all imports and references in tests

- [x] blocker.12: replace plain Error with UnexpectedCodePathError
  - fixed in setIamRole.ts (role disappeared after update, role not found after creation)

- [~] blocker.13: create castIntoXyz per domain object (no copypasta)
  - out of scope for lambda-alias feature
  - lambda/lambdaAlias/lambdaVersion already have castInto* procedures
  - general pattern improvement for entire codebase

- [x] blocker.14: fix unnecessary `as RefByUnique` casts where types already flow
  - removed casts in getIamRole.ts after isRefByUnique/isRefByPrimary type guards
  - removed casts in getOneLambdaVersion.ts after type guards
  - removed casts in getEc2Instance.ts after type guards

- [x] blocker.15: remove `as RefByUnique` after isRefByUnique type guards
  - completed as part of blocker.14

- [x] blocker.16: fix getLambdaAlias hazardous null checks + remove unnecessary getLambda call
  - change return type to `null | { functionName, aliasName }`
  - remove getLambda call - we have by.unique.lambda.name directly

- [x] blocker.17: lookup version properly from alias response (no lying about sha256)
  - getOneLambdaAlias now calls GetFunctionConfigurationCommand to get real sha256 values
  - uses calcConfigSha256 to compute configSha256 from actual version config

- [x] blocker.18: scope try-catches narrowly using .catch()
  - done in delLambdaAlias.ts
  - done in delLambdaVersion.ts
  - done in getOneLambdaAlias.ts

- [x] blocker.19: fix getAllLambdaAliases to lookup real codeSha256/configSha256
  - now iterates through aliases and fetches version config for each
  - uses calcConfigSha256 to compute real configSha256

- [x] blocker.20: remove `as RefByUnique` in setLambdaAlias
  - removed all unnecessary type casts
  - types now flow naturally from input

- [x] blocker.21: add guards in delLambdaVersion to prevent deleting $LATEST
  - added: `if (!foundBefore.version || foundBefore.version === '$LATEST') return BadRequestError.throw(...)`

- [x] blocker.22: move configSha256 computation into castIntoLambdaVersion
  - castIntoDeclaredAwsLambdaVersion now computes configSha256 internally
  - removed configSha256 from input parameters
  - updated all callers: getAllLambdaVersions, getOneLambdaVersion, setLambdaVersion
  - added failfast guards for required config fields (Handler, Runtime, MemorySize, etc.)
  - updated tests to provide complete FunctionConfiguration objects

- [x] blocker.23: rename `existing` => `foundBefore` in delXYZ files
  - done in delLambdaAlias.ts and delLambdaVersion.ts

- [x] blocker.24: use isRefByUnique/Primary instead of manual field checks in getLambda.ts
  - replaced manual field check with isRefByUnique({ of: DeclaredAwsLambda }) type guard
  - replaced manual field check with isRefByPrimary({ of: DeclaredAwsLambda }) type guard
  - added failfast with UnexpectedCodePathError if neither

## progress summary

completed: blockers 1, 2, 3, 4, 5, 6, 7, 11, 12, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24
out of scope: blockers 8, 9, 10, 13 (general codebase cleanup, not specific to lambda-alias feature)

## notes

this is an extensive refactor requiring significant architectural changes. the primary issues are:
1. type safety - removing all `as RefByUnique<...>` casts and letting types flow naturally
2. naming conventions - getOne/getAll, castInto, foundBefore/foundAfter
3. contract consistency - all get/set/del operations should use `{ by: ... }` pattern
4. domain model corrections - qualifier removed from DeclaredAwsLambda (completed in blocker.7)

blocker.7 was a blocking dependency and is now complete - qualifier removed from DeclaredAwsLambda.

## files modified

### renamed files
- src/domain.operations/lambdaAlias/getLambdaAlias.ts => getOneLambdaAlias.ts
- src/domain.operations/lambdaAlias/getLambdaAliases.ts => getAllLambdaAliases.ts
- src/domain.operations/lambdaVersion/getLambdaVersion.ts => getOneLambdaVersion.ts
- src/domain.operations/lambdaVersion/getLambdaVersions.ts => getAllLambdaVersions.ts
- src/domain.operations/lambdaAlias/castToDeclaredAwsLambdaAlias.ts => castIntoDeclaredAwsLambdaAlias.ts
- src/domain.operations/lambdaVersion/castToDeclaredAwsLambdaVersion.ts => castIntoDeclaredAwsLambdaVersion.ts
- src/domain.operations/lambda/castToDeclaredAwsLambda.ts => castIntoDeclaredAwsLambda.ts

### updated files
- src/domain.objects/DeclaredAwsLambda.ts (removed qualifier)
- src/domain.objects/DeclaredAwsIamRole.ts (fixed comments)
- src/domain.objects/DeclaredAwsIamPolicyStatement.ts (camelCase principal, PickOne)
- src/domain.operations/lambdaAlias/delLambdaAlias.ts
- src/domain.operations/lambdaVersion/delLambdaVersion.ts
- src/domain.operations/lambdaAlias/getAllLambdaAliases.ts
- src/domain.operations/lambdaVersion/getAllLambdaVersions.ts
- src/domain.operations/lambda/getLambda.ts
- src/domain.operations/lambda/getLambdas.ts
- src/domain.operations/lambda/setLambda.ts
- src/domain.operations/lambdaAlias/setLambdaAlias.ts
- src/domain.operations/lambdaVersion/setLambdaVersion.ts
- src/domain.operations/lambdaAlias/index.ts
- src/domain.operations/lambdaVersion/index.ts
- src/domain.operations/iamRole/setIamRole.ts (castFromDomainPrincipal, UnexpectedCodePathError)
- src/domain.operations/iamRole/getIamRole.ts (castIntoDomainPrincipal)
- src/domain.operations/iamRolePolicy/setIamRolePolicy.ts (castFromDomainPrincipal)
- src/access/daos/DeclaredAwsLambdaAliasDao.ts
- src/access/daos/DeclaredAwsLambdaVersionDao.ts
- src/contract/sdks/index.ts
- (many test files updated)
