# AWS Domain Research for Log Retention Policies Wish

## Context

The wish is to be able to set log retention policies for all log groups that currently exist, allowing for declarative management of retention settings.

This research documents the AWS domain objects and operations available to fulfill this wish.

---

## Key Finding: Retention is NOT a Separate Entity

**Important**: AWS does not model retention policies as a separate entity. Instead:
- Retention is an **attribute** of the `LogGroup` entity (`retentionInDays`)
- Retention is modified via **dedicated operations** (`PutRetentionPolicy`, `DeleteRetentionPolicy`)
- There is **no** `UpdateLogGroup` API — retention is the primary mutable attribute

This means the ideal approach from the wish (creating separate policy entities) is **not directly supported** by AWS. The alternative approach (updating existing log groups) is how AWS models this.

---

## Domain Objects

### Entities

#### LogGroup

The primary entity. Retention is an attribute of the log group itself.

**Key Attributes:**
| Attribute | Type | Description |
|-----------|------|-------------|
| `arn` | `string` | Amazon Resource Name (with trailing `:*` for IAM, without for tagging) |
| `logGroupName` | `string` | Unique name (e.g., `/aws/lambda/svc-chat-prod-getDisplayableMessages`) |
| `logGroupClass` | `enum` | `STANDARD`, `INFREQUENT_ACCESS`, or `DELIVERY` |
| `retentionInDays` | `number \| null` | Days to retain logs; `null` = never expire |
| `storedBytes` | `number` | Total bytes stored (~24hr delay in updates) |
| `kmsKeyId` | `string \| null` | Optional KMS key for encryption |
| `creationTime` | `number` | Milliseconds since epoch |
| `deletionProtectionEnabled` | `boolean` | Blocks deletion operations when enabled |
| `dataProtectionStatus` | `enum` | `ACTIVATED`, `DELETED`, `ARCHIVED`, `DISABLED` |
| `metricFilterCount` | `number` | Count of metric filters |

**Existing Implementation:** `DeclaredAwsLogGroup` in `src/domain.objects/DeclaredAwsLogGroup.ts`

### Events

No specific events related to retention policies. Retention changes do not emit events to EventBridge or similar services.

### Literals

#### Valid Retention Days Values

AWS restricts `retentionInDays` to specific values:

```typescript
type ValidRetentionDays =
  | 1 | 3 | 5 | 7 | 14      // up to 2 weeks
  | 30 | 60 | 90             // months
  | 120 | 150 | 180          // 4-6 months
  | 365 | 400 | 545          // 1-1.5 years
  | 731 | 1096 | 1827        // 2-5 years
  | 2192 | 2557 | 2922       // 6-8 years
  | 3288 | 3653;             // 9-10 years
```

**Note:** `null` or `undefined` means "never expire" (infinite retention).

#### Log Group Classes

- `STANDARD`: Full CloudWatch Logs features
- `INFREQUENT_ACCESS`: Reduced features, lower cost
- `DELIVERY`: For delivering Lambda logs to S3/Firehose only

---

## Domain Operations

### Read Operations

| Operation | Type | SDK Command | Description |
|-----------|------|-------------|-------------|
| `DescribeLogGroups` | getAll | `DescribeLogGroupsCommand` | List log groups with filtering by prefix, includes `retentionInDays` |
| `DescribeLogGroups` | getOne | `DescribeLogGroupsCommand` | Get specific log group by exact name |

**Current Implementation:**
- `getAllLogGroups` in `src/domain.operations/logGroup/getAllLogGroups.ts`
- `getOneLogGroup` in `src/domain.operations/logGroup/getOneLogGroup.ts`

### Write Operations

#### PutRetentionPolicy (setUpdate)

Sets or updates the retention policy for a log group.

**SDK:**
```typescript
import { CloudWatchLogsClient, PutRetentionPolicyCommand } from "@aws-sdk/client-cloudwatch-logs";

const client = new CloudWatchLogsClient({});
const command = new PutRetentionPolicyCommand({
  logGroupName: "/aws/lambda/my-function", // required
  retentionInDays: 30                       // required, must be valid value
});
await client.send(command);
// Returns: {} (empty body on success)
```

**Input:**
```typescript
interface PutRetentionPolicyCommandInput {
  logGroupName: string;    // required
  retentionInDays: number; // required, must be one of the valid values
}
```

**Errors:**
| Error | HTTP | Description |
|-------|------|-------------|
| `InvalidParameterException` | 400 | Parameter specified incorrectly |
| `OperationAbortedException` | 400 | Concurrent requests conflicted |
| `ResourceNotFoundException` | 400 | Log group does not exist |
| `ServiceUnavailableException` | 500 | Service unavailable |

#### DeleteRetentionPolicy (setUpdate → null)

Removes retention policy so logs never expire.

**SDK:**
```typescript
import { CloudWatchLogsClient, DeleteRetentionPolicyCommand } from "@aws-sdk/client-cloudwatch-logs";

const client = new CloudWatchLogsClient({});
const command = new DeleteRetentionPolicyCommand({
  logGroupName: "/aws/lambda/my-function" // required
});
await client.send(command);
// Returns: {} (empty body on success)
```

**Input:**
```typescript
interface DeleteRetentionPolicyCommandInput {
  logGroupName: string; // required
}
```

**Errors:** Same as `PutRetentionPolicy`

### Operation Mapping to Declarative Semantics

| Desired Retention | AWS Operation |
|-------------------|---------------|
| Set to specific days | `PutRetentionPolicy` |
| Set to "never expire" (null) | `DeleteRetentionPolicy` |

**Note:** There is no single "update log group" operation. Retention is managed through these dedicated operations.

---

## Implementation Approach

### Option 1: Update Existing DeclaredAwsLogGroup (Recommended)

Since AWS models retention as an attribute of the log group:

1. **Make `retentionInDays` writable** — Remove from `readonly` array
2. **Implement `setUpdateLogGroupRetention`** — Operation that:
   - Calls `PutRetentionPolicy` if value is a number
   - Calls `DeleteRetentionPolicy` if value is `null`
3. **Usage:**
   ```typescript
   const logGroups = await getAllLogGroups({ by: { prefix: '/aws/lambda/' }});
   const updated = logGroups.map(lg => ({
     ...lg,
     retentionInDays: 30  // set desired retention
   }));
   // Apply via setUpdate operations
   ```

### Option 2: Create Separate Retention Policy Entity (Not Recommended)

While AWS doesn't support this natively, a wrapper could be created:

```typescript
interface DeclaredAwsLogGroupRetentionPolicy {
  logGroupName: string;        // @unique, @primary
  retentionInDays: number | null;
}
```

**Cons:**
- Artificial abstraction not matching AWS domain model
- Extra complexity for no benefit
- Must still use the same AWS operations under the hood

---

## Important Behavior Notes

1. **Deletion Delay**: CloudWatch doesn't immediately delete log events when they expire. It typically takes up to 72 hours after expiration before events are deleted.

2. **Cost Impact**: Log events marked for deletion no longer incur storage costs even before actual deletion.

3. **No Read Operation**: There's no dedicated `GetRetentionPolicy` operation. Retention is returned as part of `DescribeLogGroups`.

4. **Concurrency**: Concurrent modifications to the same log group can cause `OperationAbortedException`. Consider retry logic.

5. **IAM Permissions Required**:
   - `logs:PutRetentionPolicy`
   - `logs:DeleteRetentionPolicy`
   - `logs:DescribeLogGroups` (for reading current state)

---

## Recommended New Operations

| Operation | Type | Description |
|-----------|------|-------------|
| `setUpdateLogGroupRetention` | setUpdate | Set retention for a single log group |
| `setUpdateAllLogGroupsRetention` | setUpdate (bulk) | Set retention for multiple log groups (convenience) |

---

## Sources

- [PutRetentionPolicy API](https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_PutRetentionPolicy.html)
- [DeleteRetentionPolicy API](https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_DeleteRetentionPolicy.html)
- [LogGroup Data Type](https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_LogGroup.html)
- [Working with Log Groups](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/Working-with-log-groups-and-streams.html)
- [AWS SDK for JavaScript v3 - PutRetentionPolicyCommand](http://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/cloudwatch-logs/command/PutRetentionPolicyCommand/)
- [AWS SDK for JavaScript v3 - DeleteRetentionPolicyCommand](http://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/cloudwatch-logs/command/DeleteRetentionPolicyCommand/)
