# feedback response checklist

## blocker.1 - use refByUnique instead of getUniqueIdentifier

- [x] search codebase for `getUniqueIdentifier` usage
- [x] replace with `refByUnique` from domain-objects
- [x] verify types still work
- [x] run tests

## blocker.2 - DeclaredAwsSsoAccountAssignment primary key issue

- [x] review aws sdk for account assignment response structure
- [x] check if there's a createdAt or other metadata
- [x] determine if this should be DomainLiteral (no identity) vs DomainEntity
- [x] clarify `primary` key approach (see findings below)
- [x] add readonly/metadata attributes if they exist in aws response

## blocker.3 - identity store provisioning

- [x] research how identity store is provisioned in aws
- [x] check if we need a DeclaredAwsIdentityStore resource
- [x] determine if identityStoreId comes from SSO instance or needs its own resource
- [x] update domain model accordingly

---

# execution

## blocker.1 - refByUnique

### changes

- `provision/aws/admin.declastruct.resources.ts`:
  - replaced `import { getUniqueIdentifier }` with `import { refByUnique }`
  - updated `permissionSet: getUniqueIdentifier(adminPermissionSet)` → `refByUnique(adminPermissionSet)`
  - updated `principal: getUniqueIdentifier(adminUser)` → `refByUnique(adminUser)`

- `provision/aws/demo.declastruct.resources.ts`:
  - replaced `import { getUniqueIdentifier }` with `import { refByUnique }`
  - updated `permissionSet: getUniqueIdentifier(demoPermissionSet)` → `refByUnique(demoPermissionSet)`
  - updated `principal: getUniqueIdentifier(demoUser)` → `refByUnique(demoUser)`
  - updated `target: getUniqueIdentifier(demoAccount)` → `refByUnique(demoAccount)`

### rationale

- `getUniqueIdentifier` extracts unique keys at runtime from an instance
- `refByUnique` is the typed utility that properly creates `RefByUnique<T>` objects
- cleaner semantics: `refByUnique(instance)` explicitly says "create a reference by unique key"

## blocker.2 - DeclaredAwsSsoAccountAssignment

### findings

1. **aws does not assign a single id to account assignments**
   - assignments are identified by composite key: `instanceArn + permissionSetArn + principalType + principalId + targetType + targetId`
   - the CreateAccountAssignment API returns a `CreatedDate` but this is not captured in our domain model (optional enhancement)

2. **DomainEntity vs DomainLiteral**
   - initially tried `DomainLiteral` but this breaks `DeclastructDao<T>` which requires `Refable` (needs `unique` static property)
   - `DomainEntity` requires exactly 1 primary key element (type constraint)
   - **solution**: keep as `DomainEntity` with `instanceArn` as nominal primary key

3. **updated structure**
   - `public static primary = ['instanceArn'] as const;` - nominal primary for type compatibility
   - `public static unique = [6 fields]` - the actual composite key used by aws
   - documented that `byPrimary` lookups are unsupported (dao throws)
   - added `nested` definitions for ref types

### changes

- `src/domain.objects/DeclaredAwsSsoAccountAssignment.ts`:
  - updated header comments to clarify identity model
  - added `DomainLiteral` import for nested refs
  - kept `primary = ['instanceArn']` with documentation that it's nominal
  - defined `nested` for `permissionSet`, `principal`, `target` refs

## blocker.3 - identity store provisioning

### findings

1. **no CreateIdentityStore API exists**
   - identity store is automatically provisioned when IAM Identity Center is enabled
   - enabling IAM Identity Center is a manual console operation (one-time)

2. **how identityStoreId is obtained**
   - via `getSsoInstance({ by: { auth: true } })` lookup
   - returns `{ instanceArn, identityStoreId }` from the SSO instance
   - this is already implemented in `src/domain.operations/ssoInstance/getSsoInstance.ts`

3. **no DeclaredAwsIdentityStore needed**
   - `identityStoreId` is a property of the SSO instance, not a separate resource
   - current pattern is correct: lookup instance → use `identityStoreId` for user operations

### conclusion

no changes needed for blocker.3 - current implementation is correct.

---

# verification

- [x] `npm run build:ts` passes
- [x] `npm run test:unit` passes (455 tests)
