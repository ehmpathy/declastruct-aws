# github-oidc deployment pattern (recommended)
a minimal, safe, two-actor setup for ci/cd in demo accounts

---

## .what
define the correct separation of responsibilities between two actors:

1. **human** — performs provisioning, defines permissions, creates roles
2. **robot** — ci/cd pipelines (github actions) that deploy using oidc

---

## .why
- minimizes blast radius
- removes long-lived credentials
- prevents robot-led privilege escalation
- prevents cost spikes in demo accounts
- forces a clean security boundary:
  **human builds the door → robot only walks through it**

---

# 1. actors in the system

### **human**
- signs in with AWS SSO
- runs provisioning steps manually
- defines IAM roles, OIDC trust, SCPs, budgets
- has full context and judgment

### **robot**
- github actions using oidc
- deploys or updates resources
- holds no credentials and cannot mutate its own permissions
- operates strictly inside the sandbox defined by human

---

# 2. provisioning layer (human)

provisioning is executed manually using:

\`\`\`
aws sso login
\`\`\`

and the SSO `AdministratorAccess` role.

### human responsibilities:

1. **create the GitHub OIDC identity provider**
   one-time setup per AWS account.

2. **create a dedicated GitHub OIDC role for the robot**
   trust policy must restrict:
   - repo: yourname/yourrepo
   - branch: refs/heads/main
   - audience: sts.amazonaws.com

3. **attach a least-privilege policy**
   allow only what robot needs:
   - S3 writes
   - CloudFront invalidations
   - Lambda deployments
   - DynamoDB writes
   - Parameter Store reads

   explicitly forbid:
   - \`iam:*\`
   - \`sts:AssumeRole*\`
   - \`iam:PassRole\` (except narrow cases)
   - \`ec2:RunInstances\`
   - \`sagemaker:*\`
   - \`emr:*\`
   - any high-cost compute

4. **apply SCP guardrails (optional but highly recommended)**
   examples:
   - deny GPU instance families
   - deny EC2 entirely if serverless only
   - deny NAT gateways
   - deny SageMaker / EMR
   - deny IAM creation from member accounts

5. **add budgets + alerting** (optional)
   not a hard limit, but gives visibility.

### rule of the layer:
**only human may create/modify IAM, OIDC providers, or SCPs.**

robots can never change their own power.

---

# 3. runtime layer (robot)

the robot authenticates via GitHub OIDC:

\`\`\`
permissions:
  id-token: write
  contents: read

steps:
  - uses: actions/checkout@v4

  - name: configure aws credentials
    uses: aws-actions/configure-aws-credentials@v4
    with:
      role-to-assume: arn:aws:iam::<ACCOUNT_ID>:role/GitHubActionsOpenSource
      aws-region: us-east-1

  - run: aws sts get-caller-identity
\`\`\`

the robot gets:

- temporary credentials
- strictly scoped access
- a fixed sandbox defined by human
- no ability to:
  - mutate IAM
  - create users
  - create access keys
  - open new trust paths
  - spin up expensive compute
  - modify SCPs
  - assume other roles

---

# 4. guarantees of the two-actor pattern

### ✔ robot cannot escalate
no IAM write
no STS assume-role
no policy mutation
no role creation

### ✔ robot cannot persist
cannot create long-lived keys
cannot create backdoor roles

### ✔ robot cannot cause huge bills
SCPs restrict expensive service families
CI policy doesn’t allow compute creation

### ✔ robot cannot affect other accounts
trust policy binds it to a single AWS account and repo

### ✔ human retains full control
human adjusts permissions; robot cannot.

---

# 5. mental model

### **human = architect**
designs the perimeter, creates the door, defines capabilities.

### **robot = operator**
executes deployments *inside* the perimeter.
never edits the perimeter.
never creates doors.

---

# 6. summary

this pattern provides:

- strong, simple security posture
- complete separation of provisioning vs deployment
- minimal blast radius inside a demo account
- no long-lived credentials
- a modern, OIDC-based CI/CD story that is safe even for public repos

---

if you'd like, I can now generate:

- the **human provisioning script** (`provision-oidc-role.sh`)
- a **terraform module** implementing this brief
- the **robot workflow** (`deploy.yml`)
- an **scp bundle** for safe demo accounts
just say which one you want next.
