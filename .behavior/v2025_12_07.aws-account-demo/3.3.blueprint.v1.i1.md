# blueprint: aws account provisioning via declastruct

blueprint for implementing the wish declared in:
- `.behavior/v2025_12_07.aws-account-demo/0.wish.md`
- `.behavior/v2025_12_07.aws-account-demo/1.vision.md`

based on:
- `.behavior/v2025_12_07.aws-account-demo/3.1.research.domain._.v1.i1.md`
- `.behavior/v2025_12_07.aws-account-demo/3.2.distill.domain._.v1.i1.md`

---

## 1. architectural overview

### 1.1 two-phase provisioning model

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PHASE 1: BOOTSTRAP                           â”‚
â”‚                    (run by: root or initial admin)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ SSO Permission  â”‚â”€â”€â”€â–¶â”‚   SSO User      â”‚â”€â”€â”€â–¶â”‚  Assignment   â”‚  â”‚
â”‚   â”‚ Set: Admin      â”‚    â”‚   (admin)       â”‚    â”‚  (adminâ†’mgmt) â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚   result: admin can `aws sso login --profile use.ehmpathy.admin`    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        PHASE 2: PROVISION                           â”‚
â”‚                    (run by: admin via sso)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚   â”‚  Organization   â”‚â”€â”€â”€â–¶â”‚  Demo Account   â”‚                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                    â”‚                                â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                    â–¼               â–¼               â–¼                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚  OIDC Provider  â”‚   â”‚  OIDC Role      â”‚   â”‚  SSO Permission â”‚  â”‚
â”‚   â”‚  (github)       â”‚   â”‚  (demo-oidc)    â”‚   â”‚  Set (demo-sso) â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                    â”‚               â”‚                â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                            â–¼                        â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚                              â”‚ Shared Permissions  â”‚                â”‚
â”‚                              â”‚ (demoPermissions-   â”‚                â”‚
â”‚                              â”‚  Policy bundle)     â”‚                â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  SSO User       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Assignment         â”‚   â”‚
â”‚   â”‚  (demo-agent)   â”‚                    â”‚  (demoâ†’demo-acct)   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                     â”‚
â”‚   result: github actions can assume `ehmpathy-demo-oidc` via oidc   â”‚
â”‚   result: agents can `aws sso login --profile use.ehmpathy.demo`    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 1.2 layer structure

```
src/
â”œâ”€â”€ domain.objects/
â”‚   â”œâ”€â”€ DeclaredAwsOrganization.ts              # âœ… exists
â”‚   â”œâ”€â”€ DeclaredAwsOrganizationAccount.ts       # âœ… exists
â”‚   â”œâ”€â”€ DeclaredAwsIamRole.ts                   # âš ï¸ needs policy field
â”‚   â”œâ”€â”€ DeclaredAwsIamPolicyStatement.ts        # âš ï¸ needs condition field
â”‚   â”œâ”€â”€ DeclaredAwsIamPolicyDocument.ts         # âœ… exists
â”‚   â”œâ”€â”€ DeclaredAwsIamPolicyBundle.ts           # ğŸ†• new literal
â”‚   â”œâ”€â”€ DeclaredAwsIamOidcProvider.ts           # ğŸ†• new entity
â”‚   â”œâ”€â”€ DeclaredAwsSsoPermissionSet.ts          # ğŸ†• new entity
â”‚   â”œâ”€â”€ DeclaredAwsSsoUser.ts                   # ğŸ†• new entity
â”‚   â””â”€â”€ DeclaredAwsSsoAccountAssignment.ts      # ğŸ†• new entity
â”‚
â”œâ”€â”€ domain.operations/
â”‚   â”œâ”€â”€ organization/                           # âœ… exists
â”‚   â”œâ”€â”€ organizationAccount/                    # âœ… exists
â”‚   â”œâ”€â”€ iamRole/                                # âœ… exists (needs update)
â”‚   â”œâ”€â”€ iamOidcProvider/                        # ğŸ†• new folder
â”‚   â”‚   â”œâ”€â”€ castIntoDeclaredAwsIamOidcProvider.ts
â”‚   â”‚   â”œâ”€â”€ getOneIamOidcProvider.ts
â”‚   â”‚   â”œâ”€â”€ getAllIamOidcProviders.ts
â”‚   â”‚   â”œâ”€â”€ setIamOidcProvider.ts
â”‚   â”‚   â””â”€â”€ delIamOidcProvider.ts
â”‚   â”œâ”€â”€ ssoPermissionSet/                       # ğŸ†• new folder
â”‚   â”‚   â”œâ”€â”€ castIntoDeclaredAwsSsoPermissionSet.ts
â”‚   â”‚   â”œâ”€â”€ getOneSsoPermissionSet.ts
â”‚   â”‚   â”œâ”€â”€ getAllSsoPermissionSets.ts
â”‚   â”‚   â”œâ”€â”€ setSsoPermissionSet.ts
â”‚   â”‚   â””â”€â”€ delSsoPermissionSet.ts
â”‚   â”œâ”€â”€ ssoUser/                                # ğŸ†• new folder
â”‚   â”‚   â”œâ”€â”€ castIntoDeclaredAwsSsoUser.ts
â”‚   â”‚   â”œâ”€â”€ getOneSsoUser.ts
â”‚   â”‚   â”œâ”€â”€ getAllSsoUsers.ts
â”‚   â”‚   â”œâ”€â”€ setSsoUser.ts
â”‚   â”‚   â””â”€â”€ delSsoUser.ts
â”‚   â””â”€â”€ ssoAccountAssignment/                   # ğŸ†• new folder
â”‚       â”œâ”€â”€ castIntoDeclaredAwsSsoAccountAssignment.ts
â”‚       â”œâ”€â”€ getOneSsoAccountAssignment.ts
â”‚       â”œâ”€â”€ getAllSsoAccountAssignments.ts
â”‚       â”œâ”€â”€ setSsoAccountAssignment.ts
â”‚       â””â”€â”€ delSsoAccountAssignment.ts
â”‚
â”œâ”€â”€ access/
â”‚   â””â”€â”€ daos/
â”‚       â”œâ”€â”€ DeclaredAwsOrganizationDao.ts       # âœ… exists
â”‚       â”œâ”€â”€ DeclaredAwsOrganizationAccountDao.ts # âœ… exists
â”‚       â”œâ”€â”€ DeclaredAwsIamRoleDao.ts            # âœ… exists
â”‚       â”œâ”€â”€ DeclaredAwsIamOidcProviderDao.ts    # ğŸ†• new dao
â”‚       â”œâ”€â”€ DeclaredAwsSsoPermissionSetDao.ts   # ğŸ†• new dao
â”‚       â”œâ”€â”€ DeclaredAwsSsoUserDao.ts            # ğŸ†• new dao
â”‚       â””â”€â”€ DeclaredAwsSsoAccountAssignmentDao.ts # ğŸ†• new dao
â”‚
â””â”€â”€ contract/
    â””â”€â”€ sdks/
        â””â”€â”€ index.ts                            # âš ï¸ needs new exports

provision/
â””â”€â”€ aws/
    â”œâ”€â”€ admin.declastruct.resources.ts          # ğŸ†• phase 1 resources
    â””â”€â”€ demo.declastruct.resources.ts           # ğŸ†• phase 2 resources
```

---

## 2. domain object designs

### 2.1 new domain objects

#### DeclaredAwsIamPolicyBundle (literal)

```ts
export interface DeclaredAwsIamPolicyBundle {
  managed: string[];                    // arn list of managed policies
  inline: DeclaredAwsIamPolicyDocument; // inline policy statements
}
```

**rationale**: enables single source of truth for permissions shared between IAM roles and SSO permission sets.

---

#### DeclaredAwsIamOidcProvider (entity)

```ts
export interface DeclaredAwsIamOidcProvider {
  arn?: string;              // @primary, @metadata
  url: string;               // @unique
  clientIds: string[];
  thumbprints: string[];     // can be empty for AWS-trusted providers
  tags?: Record<string, string>;
}
```

**identity**:
- primary = `[arn]`
- unique = `[url]`

---

#### DeclaredAwsSsoPermissionSet (entity)

```ts
export interface DeclaredAwsSsoPermissionSet {
  arn?: string;              // @primary, @metadata
  instanceArn: string;       // @unique.part
  name: string;              // @unique.part
  description?: string;
  sessionDuration?: string;
  policy: DeclaredAwsIamPolicyBundle;
  tags?: Record<string, string>;
}
```

**identity**:
- primary = `[arn]`
- unique = `[instanceArn, name]`

---

#### DeclaredAwsSsoUser (entity)

```ts
export interface DeclaredAwsSsoUser {
  id?: string;               // @primary, @metadata
  identityStoreId: string;   // @unique.part
  userName: string;          // @unique.part
  displayName: string;
  givenName?: string;
  familyName?: string;
  email: string;
}
```

**identity**:
- primary = `[id]`
- unique = `[identityStoreId, userName]`

---

#### DeclaredAwsSsoAccountAssignment (entity)

```ts
export interface DeclaredAwsSsoAccountAssignment {
  instanceArn: string;
  permissionSet: Ref<typeof DeclaredAwsSsoPermissionSet>;
  principalType: 'USER' | 'GROUP';
  principal: Ref<typeof DeclaredAwsSsoUser>;
  targetType: 'AWS_ACCOUNT';
  target: Ref<typeof DeclaredAwsOrganizationAccount> | string;
}
```

**identity**:
- unique = composite of all fields (no aws-assigned primary)

---

### 2.2 updates to existing domain objects

#### DeclaredAwsIamPolicyStatement

add `condition` field:

```ts
condition?: Record<string, Record<string, string | string[]>>;
```

**rationale**: required for OIDC trust policies with audience/subject restrictions.

---

#### DeclaredAwsIamRole

replace `managedPolicies` + `inlinePolicy` with:

```ts
policy: DeclaredAwsIamPolicyBundle;
```

**rationale**: simplifies interface, enables reuse of permission bundles.

---

#### DeclaredAwsSsoPermissionSet

replace `managedPolicies` + `inlinePolicy` with:

```ts
policy: DeclaredAwsIamPolicyBundle;
```

**rationale**: same as above â€” consistent interface across IAM and SSO.

---

## 3. operation patterns

### 3.1 standard operation set per entity

each new entity folder follows the declastruct pattern:

| operation          | description                            |
| ------------------ | -------------------------------------- |
| `castInto{Entity}` | transform sdk response â†’ domain object |
| `getOne{Entity}`   | get by primary, unique, or ref         |
| `getAll{Entities}` | list all in scope                      |
| `set{Entity}`      | findsert or upsert                     |
| `del{Entity}`      | idempotent delete                      |

### 3.2 sdk client mapping

| entity               | sdk package                     | sdk client          |
| -------------------- | ------------------------------- | ------------------- |
| IamOidcProvider      | `@aws-sdk/client-iam`           | IAMClient           |
| SsoPermissionSet     | `@aws-sdk/client-sso-admin`     | SSOAdminClient      |
| SsoUser              | `@aws-sdk/client-identitystore` | IdentitystoreClient |
| SsoAccountAssignment | `@aws-sdk/client-sso-admin`     | SSOAdminClient      |

---

## 4. resource file patterns

### 4.1 phase 1: admin.declastruct.resources.ts

```ts
export const getResources = async (): Promise<DomainEntity<any>[]> => {
  // lookup sso instance (must be pre-enabled)
  const ssoInstance = await getSsoInstance(...);

  // declare resources
  const adminPermissionSet = DeclaredAwsSsoPermissionSet.as({ ... });
  const adminUser = DeclaredAwsSsoUser.as({ ... });
  const adminAssignment = DeclaredAwsSsoAccountAssignment.as({ ... });

  return [adminPermissionSet, adminUser, adminAssignment];
};
```

**auth**: `AWS_PROFILE=use.ehmpathy.root`

---

### 4.2 phase 2: demo.declastruct.resources.ts

```ts
export const getResources = async (): Promise<DomainEntity<any>[]> => {
  // declare org layer
  const organization = DeclaredAwsOrganization.as({ ... });
  const demoAccount = DeclaredAwsOrganizationAccount.as({ ... });

  // declare shared permissions
  const demoPermissionsPolicy = DeclaredAwsIamPolicyBundle.as({ ... });

  // declare iam layer (oidc)
  const githubOidcProvider = DeclaredAwsIamOidcProvider.as({ ... });
  const demoOidcRole = DeclaredAwsIamRole.as({ policy: demoPermissionsPolicy, ... });

  // declare sso layer
  const demoPermissionSet = DeclaredAwsSsoPermissionSet.as({ policy: demoPermissionsPolicy, ... });
  const demoUser = DeclaredAwsSsoUser.as({ ... });
  const demoAssignment = DeclaredAwsSsoAccountAssignment.as({ ... });

  return [
    organization, demoAccount,
    githubOidcProvider, demoOidcRole,
    demoPermissionSet, demoUser, demoAssignment,
  ];
};
```

**auth**: `AWS_PROFILE=use.ehmpathy.admin`

---

## 5. access patterns

### 5.1 github actions (oidc)

```yaml
- uses: aws-actions/configure-aws-credentials@v4
  with:
    role-to-assume: arn:aws:iam::${DEMO_ACCOUNT_ID}:role/ehmpathy-demo-oidc
    aws-region: us-east-1
```

### 5.2 sso agents

```bash
# single profile â€” direct permissions from permission set
aws sso login --profile use.ehmpathy.demo
AWS_PROFILE=use.ehmpathy.demo aws sts get-caller-identity
```

**aws config**:
```ini
[profile use.ehmpathy.demo]
sso_start_url = https://ehmpathy.awsapps.com/start
sso_region = us-east-1
sso_account_id = ${DEMO_ACCOUNT_ID}
sso_role_name = ehmpathy-demo-sso
region = us-east-1
```

---

## 6. key design decisions

### 6.1 direct permissions vs role assumption

**decision**: sso users get permissions directly from the permission set, not via role assumption.

**rationale**:
- simpler aws cli configuration (single profile, no chained role)
- aws cli cannot combine `sso_*` and `role_arn` in same profile
- still achieves single source of truth via shared `DeclaredAwsIamPolicyBundle`

---

### 6.2 shared permissions policy

**decision**: declare `demoPermissionsPolicy` as a `DeclaredAwsIamPolicyBundle` literal reused by both OIDC role and SSO permission set.

**rationale**:
- single source of truth for demo permissions
- changes to permissions automatically apply to both access paths
- clear separation of concerns (trust vs permissions)

---

### 6.3 thumbprints for oidc

**decision**: use empty thumbprints array for github oidc provider.

**rationale**:
- as of 2025, aws trusts github's root ca directly
- thumbprints are ignored for github, google, auth0
- simplifies maintenance (no thumbprint rotation needed)

---

## 7. verification strategy

### 7.1 unit tests

- domain object instantiation with `.as()`
- cast functions: sdk response â†’ domain object
- ref resolution: `RefByUnique`, `RefByPrimary`

### 7.2 integration tests

- getOne/getAll against live aws
- set (findsert) idempotency
- del idempotency

### 7.3 end-to-end tests

- phase 1: admin can signin via `aws sso login`
- phase 2: demo agent can signin via `aws sso login`
- phase 2: github actions can assume role via oidc

---

## 8. implementation order

see `.behavior/v2025_12_07.aws-account-demo/4.1.roadmap.v1.i1.md` for detailed checklist with:
- dependencies between phases
- acceptance criteria per task
- verification commands
