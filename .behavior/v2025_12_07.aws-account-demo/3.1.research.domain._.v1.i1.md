# domain research: aws account provisioning

research for fulfilling the wish declared in:
- `.behavior/v2025_12_07.aws-account-demo/0.wish.md`
- `.behavior/v2025_12_07.aws-account-demo/1.vision.md`

---

## 1. domain objects

### 1.1 entities

#### 1.1.1 DeclaredAwsOrganization

represents an aws organization - the top-level container for accounts.

**fields** [1]:
| field | type | description |
|-------|------|-------------|
| Id | string | unique identifier (pattern: `o-` followed by 10-32 lowercase letters/digits) |
| Arn | string | amazon resource name of the organization |
| MasterAccountId | string | unique identifier of the management account (max 12 chars) |
| MasterAccountArn | string | arn of the management account |
| MasterAccountEmail | string | email of management account (6-64 chars) |
| FeatureSet | enum | `ALL` or `CONSOLIDATED_BILLING` |

**unique key**: `Id`
**primary key**: `Id`

**quote** [1]:
> "By default (or if you set the FeatureSet parameter to ALL), the new organization is created with all features enabled and service control policies automatically enabled in the root."

---

#### 1.1.2 DeclaredAwsOrganizationAccount

represents an aws account within an organization.

**fields** [2]:
| field | type | description |
|-------|------|-------------|
| Id | string | unique identifier (exactly 12 digits) |
| Arn | string | amazon resource name of the account |
| Email | string | email address (6-64 chars) |
| Name | string | friendly name (1-50 chars) |
| JoinedMethod | enum | `INVITED` or `CREATED` |
| JoinedTimestamp | timestamp | when account joined |
| State | enum | `PENDING_ACTIVATION`, `ACTIVE`, `SUSPENDED`, `PENDING_CLOSURE`, `CLOSED` |

**unique key**: `Email`
**primary key**: `Id`

**quote** [2]:
> "The Account object contains information about an Amazon Web Services account that is a member of an organization."

**quote** [3]:
> "Between September 2025 and September 2026, both State and Status fields will be available... The Status parameter in the API response will be retired on September 9, 2026."

---

#### 1.1.3 DeclaredAwsIamRole

represents an iam role that can be assumed by identities.

**fields** [4]:
| field | type | description |
|-------|------|-------------|
| RoleName | string | friendly name (1-64 chars) |
| Arn | string | amazon resource name |
| RoleId | string | stable unique id (16-128 chars) |
| AssumeRolePolicyDocument | string | trust policy (1-131072 chars) |
| Path | string | path, defaults to `/` |
| MaxSessionDuration | number | session duration in seconds (3600-43200) |
| Description | string | optional description (max 1000 chars) |
| CreateDate | timestamp | when role was created |

**unique key**: `RoleName` + `Path`
**primary key**: `Arn`

**quote** [4]:
> "The friendly name that identifies the role... The policy that grants an entity permission to assume the role."

---

#### 1.1.4 DeclaredAwsOidcProvider

represents an openid connect identity provider for federated access (e.g., github actions).

**fields** [5]:
| field | type | description |
|-------|------|-------------|
| OpenIDConnectProviderArn | string | arn (20-2048 chars) |
| Url | string | url of the oidc identity provider |
| ClientIDList | string[] | audiences allowed to auth (each 1-255 chars, max 100 items) |
| ThumbprintList | string[] | server cert thumbprints (40-char hex sha-1 hash each) |
| CreateDate | timestamp | when provider was created |
| Tags | Tag[] | attached tags (max 50) |

**unique key**: `Url`
**primary key**: `OpenIDConnectProviderArn`

**quote** [5]:
> "Creates an IAM entity to describe an identity provider (IdP) that supports OpenID Connect (OIDC)."

**quote** [6]:
> "Trust for the OIDC provider is derived from the IAM provider that this operation creates. Therefore, it is best to limit access to the CreateOpenIDConnectProvider operation to highly privileged users."

---

#### 1.1.5 DeclaredAwsSsoPermissionSet

represents a permission set in identity center that defines access levels.

**fields** [7]:
| field | type | description |
|-------|------|-------------|
| PermissionSetArn | string | arn (10-1224 chars) |
| Name | string | name (1-32 chars) |
| Description | string | description (1-700 chars) |
| SessionDuration | string | iso-8601 duration (1-100 chars) |
| RelayState | string | redirect url during federation (1-240 chars) |
| CreatedDate | timestamp | when permission set was created |

**unique key**: `Name` (within an identity center instance)
**primary key**: `PermissionSetArn`

**quote** [7]:
> "Creates a permission set within a specified IAM Identity Center instance."

---

#### 1.1.6 DeclaredAwsSsoUser

represents a user in identity center (identity store).

**fields** [8]:
| field | type | description |
|-------|------|-------------|
| UserId | string | unique identifier (uuid format) |
| UserName | string | unique username (max 128 chars) |
| DisplayName | string | formatted display name |
| Emails | Email[] | email addresses (fixed to 1 item) |
| IdentityStoreId | string | identity store id (e.g., `d-1234567890`) |

**unique key**: `UserName` (within identity store)
**primary key**: `UserId`

**quote** [8]:
> "A unique string used to identify the user. The length limit is 128 characters."

---

#### 1.1.7 DeclaredAwsSsoAccountAssignment

represents the assignment of a user/group to an account via a permission set.

**fields** [9]:
| field | type | description |
|-------|------|-------------|
| InstanceArn | string | identity center instance arn |
| PermissionSetArn | string | permission set arn |
| PrincipalId | string | user or group guid |
| PrincipalType | enum | `USER` or `GROUP` |
| TargetId | string | aws account id |
| TargetType | enum | `AWS_ACCOUNT` |

**unique key**: `PermissionSetArn` + `PrincipalId` + `TargetId`
**primary key**: composite of all fields

**quote** [9]:
> "Assigns access to a principal for a specified AWS account using a specified permission set. The term principal here refers to a user or group that is defined in IAM Identity Center."

---

### 1.2 events

#### 1.2.1 CreateAccountStatus

tracks the async status of account creation.

**fields** [10]:
| field | type | description |
|-------|------|-------------|
| Id | string | unique request id |
| AccountId | string | resulting account id (once created) |
| AccountName | string | name of account being created |
| State | enum | `IN_PROGRESS`, `SUCCEEDED`, `FAILED` |
| RequestedTimestamp | timestamp | when creation was requested |
| CompletedTimestamp | timestamp | when creation completed |
| FailureReason | string | reason for failure if failed |

**quote** [10]:
> "CreateAccount operates asynchronously, it can return a successful completion message even though account initialization might still be in progress."

---

### 1.3 literals

#### 1.3.1 PolicyTypeSummary

**fields** [1]:
| field | type | description |
|-------|------|-------------|
| Status | string | status relative to root |
| Type | string | policy type (e.g., `SERVICE_CONTROL_POLICY`) |

#### 1.3.2 Tag

**fields**:
| field | type | description |
|-------|------|-------------|
| Key | string | tag key |
| Value | string | tag value |

#### 1.3.3 Email (identity store)

**fields** [8]:
| field | type | description |
|-------|------|-------------|
| Primary | boolean | whether primary email |
| Type | string | email type |
| Value | string | email address |

---

## 2. domain operations

### 2.1 DeclaredAwsOrganization

| operation | sdk command | description |
|-----------|-------------|-------------|
| getOne | `DescribeOrganization` | retrieves organization info [1] |
| setCreate | `CreateOrganization` | creates a new organization [1] |
| setDelete | `DeleteOrganization` | deletes empty organization [11] |

**quote** [1]:
> "describeOrganization retrieves information about the organization that the user's account belongs to."

---

### 2.2 DeclaredAwsOrganizationAccount

| operation | sdk command | description |
|-----------|-------------|-------------|
| getOne.byPrimary | `DescribeAccount` | get account by id [2] |
| getAll | `ListAccounts` | list all accounts [2] |
| setCreate | `CreateAccount` | create new member account (async) [10] |
| setClose | `CloseAccount` | close/suspend account (async) [12] |
| setRemove | `RemoveAccountFromOrganization` | remove account from org [13] |

**quote** [12]:
> "Closes an AWS member account within an organization... This is an asynchronous request that AWS performs in the background."

**quote** [13]:
> "Removes the specified account from the organization. You can remove an account from your organization only if the account is configured with the information required to operate as a standalone account."

---

### 2.3 DeclaredAwsIamRole

| operation | sdk command | description |
|-----------|-------------|-------------|
| getOne | `GetRole` | get role by name [4] |
| getAll | `ListRoles` | list all roles [4] |
| setCreate | `CreateRole` | create new role [4] |
| setUpdate | `UpdateRole` / `UpdateAssumeRolePolicy` | update role properties [4] |
| setDelete | `DeleteRole` | delete role [4] |
| setPolicy.inline | `PutRolePolicy` | add inline policy [4] |
| setPolicy.managed | `AttachRolePolicy` | attach managed policy [4] |
| delPolicy.inline | `DeleteRolePolicy` | remove inline policy [4] |
| delPolicy.managed | `DetachRolePolicy` | detach managed policy [4] |

**quote** [4]:
> "GetRole retrieves information about the specified role, including the role's path, GUID, ARN, and the role's trust policy that grants permission to assume the role."

---

### 2.4 DeclaredAwsOidcProvider

| operation | sdk command | description |
|-----------|-------------|-------------|
| getOne | `GetOpenIDConnectProvider` | get provider by arn [5] |
| getAll | `ListOpenIDConnectProviders` | list all providers [5] |
| setCreate | `CreateOpenIDConnectProvider` | create oidc provider [5] |
| setUpdate.thumbprint | `UpdateOpenIDConnectProviderThumbprint` | update thumbprints [14] |
| setUpdate.clientId | `AddClientIDToOpenIDConnectProvider` | add client id [5] |
| setDelete | `DeleteOpenIDConnectProvider` | delete provider [15] |

**quote** [14]:
> "Replaces the existing list of server certificate thumbprints associated with an OpenID Connect (OIDC) provider resource object with a new list of thumbprints."

**quote** [15]:
> "Deletes an OpenID Connect identity provider (IdP) resource object in IAM... Deleting an IAM OIDC provider resource does not update any roles that reference the provider as a principal in their trust policies."

---

### 2.5 DeclaredAwsSsoPermissionSet

| operation | sdk command | description |
|-----------|-------------|-------------|
| getOne | `DescribePermissionSet` | get permission set by arn [7] |
| getAll | `ListPermissionSets` | list all permission sets [7] |
| setCreate | `CreatePermissionSet` | create permission set [7] |
| setUpdate | `UpdatePermissionSet` | update permission set [7] |
| setDelete | `DeletePermissionSet` | delete permission set [7] |
| setPolicy.inline | `PutInlinePolicyToPermissionSet` | attach inline policy [7] |
| setPolicy.managed | `AttachManagedPolicyToPermissionSet` | attach managed policy [7] |
| provision | `ProvisionPermissionSet` | provision to account [7] |

**quote** [7]:
> "To grant users and groups access to AWS account resources, you should use CreateAccountAssignment."

---

### 2.6 DeclaredAwsSsoUser

| operation | sdk command | description |
|-----------|-------------|-------------|
| getOne.byPrimary | `DescribeUser` | get user by id [8] |
| getOne.byUnique | `GetUserId` | get user id by alternate key [8] |
| getAll | `ListUsers` | list all users [8] |
| setCreate | `CreateUser` | create user [8] |
| setUpdate | `UpdateUser` | update user [8] |
| setDelete | `DeleteUser` | delete user [8] |

**quote** [8]:
> "Retrieves the user metadata and attributes from the UserId in an identity store."

---

### 2.7 DeclaredAwsSsoAccountAssignment

| operation | sdk command | description |
|-----------|-------------|-------------|
| getAll | `ListAccountAssignments` | list assignments for permission set + account [9] |
| setCreate | `CreateAccountAssignment` | assign access to principal [9] |
| setDelete | `DeleteAccountAssignment` | remove access from principal [9] |

**quote** [9]:
> "As part of a successful CreateAccountAssignment call, the specified permission set will automatically be provisioned to the account in the form of an IAM policy. That policy is attached to the IAM role created in IAM Identity Center."

---

## 3. sdk packages

| domain | package |
|--------|---------|
| organizations | `@aws-sdk/client-organizations` [16] |
| iam | `@aws-sdk/client-iam` [4] |
| identity center (sso admin) | `@aws-sdk/client-sso-admin` [9] |
| identity store | `@aws-sdk/client-identitystore` [8] |

---

## 4. citations

1. [Organization - AWS Organizations API Reference](https://docs.aws.amazon.com/organizations/latest/APIReference/API_Organization.html)
2. [Account - AWS Organizations API Reference](https://docs.aws.amazon.com/organizations/latest/APIReference/API_Account.html)
3. [AWS Organizations launches account state information - AWS Blog](https://aws.amazon.com/blogs/mt/updates-to-account-status-information-in-aws-organizations/)
4. [Role - AWS IAM API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_Role.html)
5. [CreateOpenIDConnectProvider - AWS IAM API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateOpenIDConnectProvider.html)
6. [GetOpenIDConnectProvider - AWS IAM API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_GetOpenIDConnectProvider.html)
7. [PermissionSet - IAM Identity Center API Reference](https://docs.aws.amazon.com/singlesignon/latest/APIReference/API_PermissionSet.html)
8. [User - Identity Store API Reference](https://docs.aws.amazon.com/singlesignon/latest/IdentityStoreAPIReference/API_User.html)
9. [CreateAccountAssignment - IAM Identity Center API Reference](https://docs.aws.amazon.com/singlesignon/latest/APIReference/API_CreateAccountAssignment.html)
10. [DescribeCreateAccountStatus - AWS Organizations API Reference](https://docs.aws.amazon.com/organizations/latest/APIReference/API_DescribeCreateAccountStatus.html)
11. [DeleteOrganization - AWS Organizations API Reference](https://docs.aws.amazon.com/organizations/latest/APIReference/API_DeleteOrganization.html)
12. [CloseAccount - AWS Organizations API Reference](https://docs.aws.amazon.com/organizations/latest/APIReference/API_CloseAccount.html)
13. [RemoveAccountFromOrganization - AWS Organizations API Reference](https://docs.aws.amazon.com/organizations/latest/APIReference/API_RemoveAccountFromOrganization.html)
14. [UpdateOpenIDConnectProviderThumbprint - AWS IAM API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_UpdateOpenIDConnectProviderThumbprint.html)
15. [DeleteOpenIDConnectProvider - AWS IAM API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeleteOpenIDConnectProvider.html)
16. [@aws-sdk/client-organizations - npm](https://www.npmjs.com/package/@aws-sdk/client-organizations)
