# bootstrap github actions oidc role
secure, keyless ci/cd access for public repos

---

## .what
create a **github actions oidc role** in aws so github workflows can authenticate **without access keys**, using short-lived, auto-rotating credentials.

---

## .why
- access keys in github secrets are unsafe
- oidc provides “just-in-time” credentials
- github proves “this workflow came from this repo + branch”
- aws issues temporary sts tokens (no keys to leak)
- required for secure public repos, ci pipelines, and terraform plans

---

# 1. prerequisites
you must already have:

- aws identity center enabled
- an admin sso login working
- `aws sso login` working locally
- an s3 bucket or other aws resources you want github to access

---

# 2. create the github oidc provider
run:

\`\`\`
aws iam create-open-id-connect-provider \
  --url "https://token.actions.githubusercontent.com" \
  --client-id-list "sts.amazonaws.com" \
  --thumbprint-list "6938fd4d98bab03faadb97b34396831e3780aea1"
\`\`\`

this registers github as a trusted identity provider in your aws account.

---

# 3. create the trust policy (who can assume the role)
create a file named: **github-oidc-trust.json**

\`\`\`
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::<ACCOUNT_ID>:oidc-provider/token.actions.githubusercontent.com"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
        },
        "StringLike": {
          "token.actions.githubusercontent.com:sub": "repo:yourname/yourrepo:*"
        }
      }
    }
  ]
}
\`\`\`

replace:

- `<ACCOUNT_ID>` with your aws account id
- `yourname/yourrepo` with your actual github repo

---

# 4. create the role
\`\`\`
aws iam create-role \
  --role-name GitHubActionsOpenSource \
  --assume-role-policy-document file://github-oidc-trust.json
\`\`\`

the role now exists but has *no permissions* yet.

---

# 5. attach a permissions policy
example: allow deploy to a single s3 bucket.

create **github-oidc-policy.json**:

\`\`\`
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::my-demo-bucket",
        "arn:aws:s3:::my-demo-bucket/*"
      ]
    }
  ]
}
\`\`\`

attach it:

\`\`\�
aws iam put-role-policy \
  --role-name GitHubActionsOpenSource \
  --policy-name GitHubActionsOpenSourceInline \
  --policy-document file://github-oidc-policy.json
\`\`\`

---

# 6. configure your github workflow
create `.github/workflows/deploy.yml`:

\`\`\`
name: deploy
on:
  push:
    branches: [ "main" ]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::<ACCOUNT_ID>:role/GitHubActionsOpenSource
          aws-region: us-east-1

      - name: verify
        run: aws sts get-caller-identity
\`\`\`

---

# 7. security recommendations
- restrict the role to specific repos (never `repo:*`)
- restrict to specific branches (`repo:your/repo:ref:refs/heads/main`)
- give the role the smallest permission footprint needed
- avoid wildcards in s3, lambda, iam, cloudformation, etc.

---

# complete
github can now deploy to aws securely using oidc:
no keys, no rotation, no risk of credential leaks.

if you want scps, terraform versions, or a one-command bootstrap script, i can generate those next.
