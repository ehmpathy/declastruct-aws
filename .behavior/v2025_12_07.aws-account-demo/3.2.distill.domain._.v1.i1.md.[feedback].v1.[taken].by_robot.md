# response to feedback: 3.2.distill.domain._.v1.i1.md

---

## checklist

- [x] find existing `declastruct.resources.ts` examples for pattern reference
- [x] write full contract example for phase 1: root admin bootstraps admin role
- [x] write full contract example for phase 2: admin provisions demo infrastructure
- [x] emit response checkoffs

---

## response

### blocker.1: full declastruct.resources.ts contract examples

---

## phase 1: provision/aws/admin.declastruct.resources.ts

```ts
/**
 * .what = bootstrap admin sso access for human administrators
 * .why = enables admins to signin via `aws sso login` instead of root credentials
 *
 * .auth = AWS_PROFILE=use.ehmpathy.root (or root console)
 *
 * .usage
 *   AWS_PROFILE=use.ehmpathy.root npx declastruct apply provision/aws/admin.declastruct.resources.ts
 *
 * .prereq
 *   - identity center must be enabled manually in console (one-time)
 *   - this script provisions the permission set and user assignments
 */
import { DeclastructProvider } from 'declastruct';
import { DomainEntity, RefByUnique } from 'domain-objects';

import {
  DeclaredAwsSsoPermissionSet,
  DeclaredAwsSsoUser,
  DeclaredAwsSsoAccountAssignment,
  getDeclastructAwsProvider,
  getSsoInstance,
} from '../../src/contract/sdks';

export const getProviders = async (): Promise<DeclastructProvider[]> => [
  await getDeclastructAwsProvider(
    {},
    {
      log: {
        info: console.info,
        debug: () => {},
        warn: console.warn,
        error: console.error,
      },
    },
  ),
];

export const getResources = async (): Promise<DomainEntity<any>[]> => {
  // get the provider context
  const [provider] = await getProviders();
  const providerContext = (provider as any).context;
  const accountId = providerContext.aws.credentials.account;

  // lookup the identity center instance (must already be enabled in console)
  const ssoInstance = await getSsoInstance({ by: { auth: true } }, providerContext);
  if (!ssoInstance) throw new Error('identity center not enabled. enable it in aws console first.');

  // declare the admin permission set
  const adminPermissionSet = DeclaredAwsSsoPermissionSet.as({
    instanceArn: ssoInstance.instanceArn,
    name: 'AdministratorAccess',
    description: 'Full administrator access for human admins',
    sessionDuration: 'PT4H',
    managedPolicies: ['arn:aws:iam::aws:policy/AdministratorAccess'],
  });

  // declare the admin user
  const adminUser = DeclaredAwsSsoUser.as({
    identityStoreId: ssoInstance.identityStoreId,
    userName: 'admin',
    displayName: 'Admin User',
    givenName: 'Admin',
    familyName: 'User',
    email: 'admin@ehmpathy.com',
  });

  // declare the account assignment linking admin user to account via permission set
  const adminAssignment = DeclaredAwsSsoAccountAssignment.as({
    instanceArn: ssoInstance.instanceArn,
    permissionSetArn: adminPermissionSet.arn!, // will be resolved by declastruct
    principalType: 'USER',
    principalId: adminUser.id!, // will be resolved by declastruct
    targetType: 'AWS_ACCOUNT',
    targetId: accountId,
  });

  return [adminPermissionSet, adminUser, adminAssignment];
};
```

---

## phase 2: provision/aws/demo.declastruct.resources.ts

```ts
/**
 * .what = provision demo infrastructure for ehmpathy-demo account
 * .why = enables demo agents (sso) and github actions (oidc) to access demo account
 *
 * .auth = AWS_PROFILE=use.ehmpathy.admin
 *
 * .usage
 *   AWS_PROFILE=use.ehmpathy.admin npx declastruct apply provision/aws/demo.declastruct.resources.ts
 *
 * .steps
 *   1. ensure organization exists (finsert)
 *   2. create demo account in organization (finsert)
 *   3. create github oidc provider in demo account
 *   4. create demo iam role assumable by github actions via oidc
 *   5. create demo permission set for sso access
 *   6. create demo user for agent access
 *   7. assign demo user to demo account via permission set
 */
import { DeclastructProvider } from 'declastruct';
import { DomainEntity, RefByUnique } from 'domain-objects';

import {
  DeclaredAwsOrganization,
  DeclaredAwsOrganizationAccount,
  DeclaredAwsIamRole,
  DeclaredAwsIamOidcProvider,
  DeclaredAwsSsoPermissionSet,
  DeclaredAwsSsoUser,
  DeclaredAwsSsoAccountAssignment,
  getDeclastructAwsProvider,
  setOrganization,
  setOrganizationAccount,
  getSsoInstance,
} from '../../src/contract/sdks';

export const getProviders = async (): Promise<DeclastructProvider[]> => [
  await getDeclastructAwsProvider(
    {},
    {
      log: {
        info: console.info,
        debug: () => {},
        warn: console.warn,
        error: console.error,
      },
    },
  ),
];

export const getResources = async (): Promise<DomainEntity<any>[]> => {
  // get the provider context
  const [provider] = await getProviders();
  const providerContext = (provider as any).context;
  const managementAccountId = providerContext.aws.credentials.account;

  // lookup the identity center instance
  const ssoInstance = await getSsoInstance({ by: { auth: true } }, providerContext);
  if (!ssoInstance) throw new Error('identity center not enabled');

  // =========================================================================
  // step 1: ensure organization exists
  // =========================================================================
  const organization = await setOrganization(
    {
      finsert: DeclaredAwsOrganization.as({
        managementAccount: { id: managementAccountId },
        featureSet: 'ALL',
      }),
    },
    providerContext,
  );

  // =========================================================================
  // step 2: create demo account in organization
  // =========================================================================
  const demoAccount = await setOrganizationAccount(
    {
      finsert: DeclaredAwsOrganizationAccount.as({
        organization: { id: organization.id! },
        name: 'ehmpathy-demo',
        email: 'demo@ehmpathy.com',
        iamUserAccessToBilling: 'ALLOW',
        tags: {
          managedBy: 'declastruct',
          purpose: 'demo',
        },
      }),
    },
    providerContext,
  );

  // =========================================================================
  // step 3: create github oidc provider in demo account
  // note: this resource is applied in the demo account context
  // =========================================================================
  const githubOidcProvider = DeclaredAwsIamOidcProvider.as({
    url: 'https://token.actions.githubusercontent.com',
    clientIds: ['sts.amazonaws.com'],
    thumbprints: ['6938fd4d98bab03faadb97b34396831e3780aea1'],
    tags: {
      managedBy: 'declastruct',
      purpose: 'github-actions-oidc',
    },
  });

  // =========================================================================
  // step 4: create demo iam role assumable by github actions via oidc
  // =========================================================================
  const demoRole = DeclaredAwsIamRole.as({
    name: 'ehmpathy-demo-role',
    description: 'Demo role for ehmpathy agents and github actions',
    policies: [
      // trust policy: allow github actions to assume this role via oidc
      {
        effect: 'Allow',
        action: 'sts:AssumeRoleWithWebIdentity',
        principal: {
          federated: `arn:aws:iam::${demoAccount.id}:oidc-provider/token.actions.githubusercontent.com`,
        },
        condition: {
          StringEquals: {
            'token.actions.githubusercontent.com:aud': 'sts.amazonaws.com',
          },
          StringLike: {
            'token.actions.githubusercontent.com:sub': 'repo:ehmpathy/*:*',
          },
        },
      },
    ],
    tags: {
      managedBy: 'declastruct',
      purpose: 'demo',
    },
  });

  // =========================================================================
  // step 5: create demo permission set for sso access
  // =========================================================================
  const demoPermissionSet = DeclaredAwsSsoPermissionSet.as({
    instanceArn: ssoInstance.instanceArn,
    name: 'EhmpathyDemoAccess',
    description: 'Demo access for ehmpathy agents',
    sessionDuration: 'PT4H',
    managedPolicies: [
      // read-only access + specific demo permissions
      'arn:aws:iam::aws:policy/ReadOnlyAccess',
    ],
    inlinePolicy: {
      version: '2012-10-17',
      statements: [
        {
          effect: 'Allow',
          action: [
            's3:PutObject',
            's3:GetObject',
            's3:DeleteObject',
          ],
          resource: [
            'arn:aws:s3:::ehmpathy-demo-*',
            'arn:aws:s3:::ehmpathy-demo-*/*',
          ],
        },
        {
          effect: 'Allow',
          action: [
            'lambda:InvokeFunction',
          ],
          resource: [
            `arn:aws:lambda:*:${demoAccount.id}:function:ehmpathy-demo-*`,
          ],
        },
      ],
    },
  });

  // =========================================================================
  // step 6: create demo user for agent access
  // =========================================================================
  const demoUser = DeclaredAwsSsoUser.as({
    identityStoreId: ssoInstance.identityStoreId,
    userName: 'demo-agent',
    displayName: 'Demo Agent',
    givenName: 'Demo',
    familyName: 'Agent',
    email: 'demo-agent@ehmpathy.com',
  });

  // =========================================================================
  // step 7: assign demo user to demo account via permission set
  // =========================================================================
  const demoAssignment = DeclaredAwsSsoAccountAssignment.as({
    instanceArn: ssoInstance.instanceArn,
    permissionSetArn: demoPermissionSet.arn!, // resolved by declastruct
    principalType: 'USER',
    principalId: demoUser.id!, // resolved by declastruct
    targetType: 'AWS_ACCOUNT',
    targetId: demoAccount.id!,
  });

  // =========================================================================
  // return all resources for declastruct to apply
  // =========================================================================
  return [
    // organization layer (already finserted above, but included for completeness)
    organization,
    demoAccount,

    // iam layer (applied in demo account context)
    githubOidcProvider,
    demoRole,

    // sso layer (applied in management account context)
    demoPermissionSet,
    demoUser,
    demoAssignment,
  ];
};
```

---

## usage summary

### phase 1: root bootstraps admin

```bash
# authenticate as root (or initial admin)
AWS_PROFILE=use.ehmpathy.root npx declastruct plan provision/aws/admin.declastruct.resources.ts
AWS_PROFILE=use.ehmpathy.root npx declastruct apply provision/aws/admin.declastruct.resources.ts
```

**result**: admin can now signin via `aws sso login --profile use.ehmpathy.admin`

---

### phase 2: admin provisions demo

```bash
# authenticate as admin (via sso)
aws sso login --profile use.ehmpathy.admin
AWS_PROFILE=use.ehmpathy.admin npx declastruct plan provision/aws/demo.declastruct.resources.ts
AWS_PROFILE=use.ehmpathy.admin npx declastruct apply provision/aws/demo.declastruct.resources.ts
```

**result**:
1. organization exists
2. `ehmpathy-demo` account exists under the organization
3. github oidc provider exists in demo account
4. `ehmpathy-demo-role` exists, assumable by github actions from `ehmpathy/*` repos
5. demo permission set exists for sso access
6. demo user exists
7. demo user can signin to demo account via `aws sso login --profile use.ehmpathy.demo`

---

## after provisioning

### github actions usage

```yaml
# .github/workflows/deploy.yml
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${DEMO_ACCOUNT_ID}:role/ehmpathy-demo-role
          aws-region: us-east-1

      - run: aws sts get-caller-identity
```

### agent sso usage

```bash
# agents authenticate via sso
aws sso login --profile use.ehmpathy.demo
aws sts get-caller-identity --profile use.ehmpathy.demo
```

---

## notes

1. **cross-account resources**: the oidc provider and demo role are declared for the demo account, but applied via the management account using assume-role. declastruct handles this via the `targetAccountId` pattern.

2. **dependency resolution**: declastruct resolves `arn!` and `id!` references automatically during apply. resources are applied in topological order based on dependencies.

3. **idempotency**: all operations use finsert semantics (find-or-insert). running `declastruct apply` multiple times produces the same result.

4. **separation of concerns**: phase 1 (admin bootstrap) and phase 2 (demo provisioning) are separate files with separate auth requirements, following the "human builds the door, robot walks through it" pattern from the research.
