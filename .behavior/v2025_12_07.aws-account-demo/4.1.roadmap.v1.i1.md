# roadmap: aws account provisioning via declastruct

implementation roadmap for the blueprint specified in:
- `.behavior/v2025_12_07.aws-account-demo/3.2.distill.domain._.v1.i1.md`

based on:
- `.behavior/v2025_12_07.aws-account-demo/0.wish.md`
- `.behavior/v2025_12_07.aws-account-demo/1.vision.md`

---

## phase 0: prerequisites

### 0.1 install sdk dependencies

- [ ] **add @aws-sdk/client-sso-admin**
  - .what = sdk for sso permission sets and account assignments
  - .verify = `npm ls @aws-sdk/client-sso-admin` shows installed version

- [ ] **add @aws-sdk/client-identitystore**
  - .what = sdk for sso users and groups
  - .verify = `npm ls @aws-sdk/client-identitystore` shows installed version

- [ ] **verify existing sdks**
  - .what = confirm @aws-sdk/client-organizations and @aws-sdk/client-iam are present
  - .verify = `npm ls @aws-sdk/client-organizations @aws-sdk/client-iam` shows both

---

## phase 1: domain.objects

### 1.1 update existing domain objects

- [ ] **add `condition` field to DeclaredAwsIamPolicyStatement**
  - .what = support iam policy conditions (StringEquals, StringLike, etc)
  - .where = `src/domain.objects/DeclaredAwsIamPolicyStatement.ts`
  - .accept = field `condition?: Record<string, Record<string, string | string[]>>` exists
  - .verify = `npm run test:types` passes

- [ ] **add DeclaredAwsIamPolicyBundle literal**
  - .what = bundle combining managed + inline policies for reuse
  - .where = `src/domain.objects/DeclaredAwsIamPolicyBundle.ts`
  - .accept = exports `DeclaredAwsIamPolicyBundle` with `{ managed: string[], inline: DeclaredAwsIamPolicyDocument }`
  - .verify = `npm run test:types` passes

- [ ] **add `policy` field to DeclaredAwsIamRole**
  - .what = replace managedPolicies + inlinePolicy with single policy bundle
  - .where = `src/domain.objects/DeclaredAwsIamRole.ts`
  - .accept = field `policy: DeclaredAwsIamPolicyBundle` exists
  - .verify = `npm run test:types` passes

### 1.2 create new domain objects

- [ ] **create DeclaredAwsIamOidcProvider**
  - .what = domain entity for oidc identity providers (github actions, etc)
  - .where = `src/domain.objects/DeclaredAwsIamOidcProvider.ts`
  - .accept = exports class with `primary=['arn']`, `unique=['url']`
  - .verify = `npm run test:unit -- DeclaredAwsIamOidcProvider` passes

- [ ] **create DeclaredAwsSsoPermissionSet**
  - .what = domain entity for sso permission sets
  - .where = `src/domain.objects/DeclaredAwsSsoPermissionSet.ts`
  - .accept = exports class with `primary=['arn']`, `unique=['instanceArn', 'name']`, `policy: DeclaredAwsIamPolicyBundle`
  - .verify = `npm run test:unit -- DeclaredAwsSsoPermissionSet` passes

- [ ] **create DeclaredAwsSsoUser**
  - .what = domain entity for identity center users
  - .where = `src/domain.objects/DeclaredAwsSsoUser.ts`
  - .accept = exports class with `primary=['id']`, `unique=['identityStoreId', 'userName']`
  - .verify = `npm run test:unit -- DeclaredAwsSsoUser` passes

- [ ] **create DeclaredAwsSsoAccountAssignment**
  - .what = domain entity for sso account assignments
  - .where = `src/domain.objects/DeclaredAwsSsoAccountAssignment.ts`
  - .accept = exports class with `unique=['instanceArn', 'permissionSet', 'principal', 'target']`
  - .verify = `npm run test:unit -- DeclaredAwsSsoAccountAssignment` passes

---

## phase 2: domain.operations — iam oidc provider

### 2.1 iamOidcProvider operations

- [ ] **create castIntoDeclaredAwsIamOidcProvider**
  - .what = cast from @aws-sdk/client-iam response to domain object
  - .where = `src/domain.operations/iamOidcProvider/castIntoDeclaredAwsIamOidcProvider.ts`
  - .accept = transforms `GetOpenIDConnectProviderResponse` to `DeclaredAwsIamOidcProvider`
  - .verify = `npm run test:unit -- castIntoDeclaredAwsIamOidcProvider` passes

- [ ] **create getOneIamOidcProvider**
  - .what = get oidc provider by primary (arn) or unique (url)
  - .where = `src/domain.operations/iamOidcProvider/getOneIamOidcProvider.ts`
  - .accept = supports `by: { primary | unique | ref }`
  - .verify = `npm run test:integration -- getOneIamOidcProvider` passes

- [ ] **create getAllIamOidcProviders**
  - .what = list all oidc providers in account
  - .where = `src/domain.operations/iamOidcProvider/getAllIamOidcProviders.ts`
  - .accept = returns `DeclaredAwsIamOidcProvider[]`
  - .verify = `npm run test:integration -- getAllIamOidcProviders` passes

- [ ] **create setIamOidcProvider**
  - .what = findsert/upsert oidc provider
  - .where = `src/domain.operations/iamOidcProvider/setIamOidcProvider.ts`
  - .accept = supports `{ findsert }` and `{ upsert }` modes
  - .verify = `npm run test:integration -- setIamOidcProvider` passes

- [ ] **create delIamOidcProvider**
  - .what = delete oidc provider by ref
  - .where = `src/domain.operations/iamOidcProvider/delIamOidcProvider.ts`
  - .accept = idempotent delete (no error if not found)
  - .verify = `npm run test:integration -- delIamOidcProvider` passes

---

## phase 3: domain.operations — sso permission set

### 3.1 ssoPermissionSet operations

- [ ] **create castIntoDeclaredAwsSsoPermissionSet**
  - .what = cast from @aws-sdk/client-sso-admin response to domain object
  - .where = `src/domain.operations/ssoPermissionSet/castIntoDeclaredAwsSsoPermissionSet.ts`
  - .accept = transforms `DescribePermissionSetResponse` to `DeclaredAwsSsoPermissionSet`
  - .verify = `npm run test:unit -- castIntoDeclaredAwsSsoPermissionSet` passes

- [ ] **create getOneSsoPermissionSet**
  - .what = get permission set by primary (arn) or unique (instanceArn, name)
  - .where = `src/domain.operations/ssoPermissionSet/getOneSsoPermissionSet.ts`
  - .accept = supports `by: { primary | unique | ref }`
  - .verify = `npm run test:integration -- getOneSsoPermissionSet` passes

- [ ] **create getAllSsoPermissionSets**
  - .what = list all permission sets for an identity center instance
  - .where = `src/domain.operations/ssoPermissionSet/getAllSsoPermissionSets.ts`
  - .accept = returns `DeclaredAwsSsoPermissionSet[]`
  - .verify = `npm run test:integration -- getAllSsoPermissionSets` passes

- [ ] **create setSsoPermissionSet**
  - .what = findsert/upsert permission set
  - .where = `src/domain.operations/ssoPermissionSet/setSsoPermissionSet.ts`
  - .accept = supports `{ findsert }` and `{ upsert }` modes, attaches policies
  - .verify = `npm run test:integration -- setSsoPermissionSet` passes

- [ ] **create delSsoPermissionSet**
  - .what = delete permission set by ref
  - .where = `src/domain.operations/ssoPermissionSet/delSsoPermissionSet.ts`
  - .accept = idempotent delete (no error if not found)
  - .verify = `npm run test:integration -- delSsoPermissionSet` passes

---

## phase 4: domain.operations — sso user

### 4.1 ssoUser operations

- [ ] **create castIntoDeclaredAwsSsoUser**
  - .what = cast from @aws-sdk/client-identitystore response to domain object
  - .where = `src/domain.operations/ssoUser/castIntoDeclaredAwsSsoUser.ts`
  - .accept = transforms `DescribeUserResponse` to `DeclaredAwsSsoUser`
  - .verify = `npm run test:unit -- castIntoDeclaredAwsSsoUser` passes

- [ ] **create getOneSsoUser**
  - .what = get user by primary (id) or unique (identityStoreId, userName)
  - .where = `src/domain.operations/ssoUser/getOneSsoUser.ts`
  - .accept = supports `by: { primary | unique | ref }`
  - .verify = `npm run test:integration -- getOneSsoUser` passes

- [ ] **create getAllSsoUsers**
  - .what = list all users in identity store
  - .where = `src/domain.operations/ssoUser/getAllSsoUsers.ts`
  - .accept = returns `DeclaredAwsSsoUser[]`
  - .verify = `npm run test:integration -- getAllSsoUsers` passes

- [ ] **create setSsoUser**
  - .what = findsert/upsert sso user
  - .where = `src/domain.operations/ssoUser/setSsoUser.ts`
  - .accept = supports `{ findsert }` and `{ upsert }` modes
  - .verify = `npm run test:integration -- setSsoUser` passes

- [ ] **create delSsoUser**
  - .what = delete user by ref
  - .where = `src/domain.operations/ssoUser/delSsoUser.ts`
  - .accept = idempotent delete (no error if not found)
  - .verify = `npm run test:integration -- delSsoUser` passes

---

## phase 5: domain.operations — sso account assignment

### 5.1 ssoAccountAssignment operations

- [ ] **create castIntoDeclaredAwsSsoAccountAssignment**
  - .what = cast from @aws-sdk/client-sso-admin response to domain object
  - .where = `src/domain.operations/ssoAccountAssignment/castIntoDeclaredAwsSsoAccountAssignment.ts`
  - .accept = transforms `AccountAssignment` to `DeclaredAwsSsoAccountAssignment`
  - .verify = `npm run test:unit -- castIntoDeclaredAwsSsoAccountAssignment` passes

- [ ] **create getOneSsoAccountAssignment**
  - .what = get assignment by composite unique key
  - .where = `src/domain.operations/ssoAccountAssignment/getOneSsoAccountAssignment.ts`
  - .accept = supports `by: { unique | ref }`
  - .verify = `npm run test:integration -- getOneSsoAccountAssignment` passes

- [ ] **create getAllSsoAccountAssignments**
  - .what = list assignments for a permission set + account combo
  - .where = `src/domain.operations/ssoAccountAssignment/getAllSsoAccountAssignments.ts`
  - .accept = returns `DeclaredAwsSsoAccountAssignment[]`
  - .verify = `npm run test:integration -- getAllSsoAccountAssignments` passes

- [ ] **create setSsoAccountAssignment**
  - .what = findsert account assignment (assignments are immutable)
  - .where = `src/domain.operations/ssoAccountAssignment/setSsoAccountAssignment.ts`
  - .accept = supports `{ findsert }` mode only (no update for assignments)
  - .verify = `npm run test:integration -- setSsoAccountAssignment` passes

- [ ] **create delSsoAccountAssignment**
  - .what = delete assignment by ref
  - .where = `src/domain.operations/ssoAccountAssignment/delSsoAccountAssignment.ts`
  - .accept = idempotent delete (no error if not found)
  - .verify = `npm run test:integration -- delSsoAccountAssignment` passes

---

## phase 6: access.daos

### 6.1 create daos

- [ ] **create DeclaredAwsIamOidcProviderDao**
  - .what = dao wrapping iamOidcProvider operations
  - .where = `src/access/daos/DeclaredAwsIamOidcProviderDao.ts`
  - .accept = exports `{ getOne, getAll, set, del }`
  - .verify = `npm run test:types` passes

- [ ] **create DeclaredAwsSsoPermissionSetDao**
  - .what = dao wrapping ssoPermissionSet operations
  - .where = `src/access/daos/DeclaredAwsSsoPermissionSetDao.ts`
  - .accept = exports `{ getOne, getAll, set, del }`
  - .verify = `npm run test:types` passes

- [ ] **create DeclaredAwsSsoUserDao**
  - .what = dao wrapping ssoUser operations
  - .where = `src/access/daos/DeclaredAwsSsoUserDao.ts`
  - .accept = exports `{ getOne, getAll, set, del }`
  - .verify = `npm run test:types` passes

- [ ] **create DeclaredAwsSsoAccountAssignmentDao**
  - .what = dao wrapping ssoAccountAssignment operations
  - .where = `src/access/daos/DeclaredAwsSsoAccountAssignmentDao.ts`
  - .accept = exports `{ getOne, getAll, set, del }`
  - .verify = `npm run test:types` passes

---

## phase 7: contract.sdks exports

### 7.1 export new domain objects and operations

- [ ] **export from contract/sdks**
  - .what = expose all new domain objects and operations via sdk exports
  - .where = `src/contract/sdks/index.ts` (or equivalent)
  - .accept = exports include:
    - `DeclaredAwsIamOidcProvider`
    - `DeclaredAwsIamPolicyBundle`
    - `DeclaredAwsSsoPermissionSet`
    - `DeclaredAwsSsoUser`
    - `DeclaredAwsSsoAccountAssignment`
    - `getSsoInstance`
  - .verify = `npm run build` passes

---

## phase 8: provision resources files

### 8.1 create declastruct resource files

- [ ] **create provision/aws/admin.declastruct.resources.ts**
  - .what = phase 1 resource file for admin sso bootstrap
  - .where = `provision/aws/admin.declastruct.resources.ts`
  - .accept = exports `getProviders` and `getResources` per distillation spec
  - .verify = `npx declastruct plan provision/aws/admin.declastruct.resources.ts` runs without error

- [ ] **create provision/aws/demo.declastruct.resources.ts**
  - .what = phase 2 resource file for demo infrastructure
  - .where = `provision/aws/demo.declastruct.resources.ts`
  - .accept = exports `getProviders` and `getResources` per distillation spec
  - .verify = `npx declastruct plan provision/aws/demo.declastruct.resources.ts` runs without error

---

## phase 9: end-to-end verification

### 9.1 integration test full flow

- [ ] **test admin bootstrap flow (phase 1)**
  - .what = verify admin sso resources can be provisioned
  - .accept = `AWS_PROFILE=use.ehmpathy.root npx declastruct apply provision/aws/admin.declastruct.resources.ts` succeeds
  - .verify = admin can signin via `aws sso login --profile use.ehmpathy.admin`

- [ ] **test demo provisioning flow (phase 2)**
  - .what = verify demo infrastructure can be provisioned
  - .accept = `AWS_PROFILE=use.ehmpathy.admin npx declastruct apply provision/aws/demo.declastruct.resources.ts` succeeds
  - .verify =
    - demo agent can signin via `aws sso login --profile use.ehmpathy.demo`
    - github actions can assume `ehmpathy-demo-oidc` role via oidc

---

## summary

| phase     | items  | description                     |
| --------- | ------ | ------------------------------- |
| 0         | 3      | prerequisites (sdk deps)        |
| 1         | 7      | domain.objects                  |
| 2         | 5      | iamOidcProvider operations      |
| 3         | 5      | ssoPermissionSet operations     |
| 4         | 5      | ssoUser operations              |
| 5         | 5      | ssoAccountAssignment operations |
| 6         | 4      | access.daos                     |
| 7         | 1      | contract.sdks exports           |
| 8         | 2      | provision resource files        |
| 9         | 2      | end-to-end verification         |
| **total** | **39** |                                 |

---

## dependencies

```
phase 0 (prereqs)
    │
    ▼
phase 1 (domain.objects)
    │
    ├──────────┬──────────┬──────────┐
    ▼          ▼          ▼          ▼
phase 2    phase 3    phase 4    phase 5
(oidc)     (permset)  (user)     (assign)
    │          │          │          │
    └──────────┴──────────┴──────────┘
                    │
                    ▼
              phase 6 (daos)
                    │
                    ▼
              phase 7 (exports)
                    │
                    ▼
              phase 8 (resources)
                    │
                    ▼
              phase 9 (e2e)
```

phases 2-5 can be executed in parallel after phase 1 completes.
