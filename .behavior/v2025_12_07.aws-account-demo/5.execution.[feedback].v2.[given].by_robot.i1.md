# execution feedback v2 — behavioral review

reviewed: current git diff (staged + unstaged) against wish/vision/blueprint

---

## summary

the implementation is ~85% complete but has several **blockers** preventing it from fulfilling the wish "out of the box". the core declastruct patterns are in place, but type errors, missing resources, and ref resolution issues need resolution.

---

## blockers

### blocker.1 — type errors: DeclaredAwsSsoAccountAssignment.primary = []

the domain-objects library requires `primary` to have at least one element:

```
src/domain.objects/DeclaredAwsSsoAccountAssignment.ts(55,14): error TS2417:
Class static side 'typeof DeclaredAwsSsoAccountAssignment' incorrectly extends base class...
Types of property 'primary' are incompatible.
Type 'readonly []' is not assignable to type 'readonly [string]'.
```

**diagnosis**: aws sso account assignments have no aws-assigned primary id. however, `DomainEntity` requires a primary key.

**options**:
1. extend from `DomainLiteral` instead since there's no aws-assigned identity
2. use a synthetic primary key that combines unique fields

**rationale needed**: determine if this is truly an entity (has lifecycle/aws state) or a literal (pure value). aws does track creation status and can list assignments, so it may warrant synthetic id.

---

### blocker.2 — type errors: refByUnique not assignable to Ref<...>

```
provision/aws/admin.declastruct.resources.ts(83,5): error TS2322:
Type 'RefByUnique<Refable<any, any, any>, any, any, any>' is not assignable to type 'Ref<typeof DeclaredAwsSsoPermissionSet>'.
```

this appears in both `admin.declastruct.resources.ts` and `demo.declastruct.resources.ts` for:
- `permissionSet: refByUnique(adminPermissionSet)`
- `principal: refByUnique(adminUser)`
- `target: refByUnique(demoAccount)`

**diagnosis**: the `Ref<T>` type in `DeclaredAwsSsoAccountAssignment` may need to use method syntax for bivariance or the type declaration needs adjustment.

**action**: review the ref type declarations and ensure they accept `RefByUnique` and `RefByPrimary`.

---

### blocker.3 — missing OIDC role for github actions

the wish specifies:
> set a narrowed 'ehmpathy-demo-role' under that account
> set the resources required to enable github-actions to auth via `oidc` under that demo role

the `demo.declastruct.resources.ts` creates:
- `githubOidcProvider` ✅

but **does not create**:
- `demoOidcRole` (a `DeclaredAwsIamRole` with trust policy for github oidc) ❌

without the oidc role, github actions cannot assume any role after authenticating via oidc. the oidc provider alone is not sufficient.

**action**: add `DeclaredAwsIamRole` with:
- trust policy pointing to the oidc provider
- conditions for repo/branch filtering
- the `demoPermissionsPolicy` attached

---

### blocker.4 — missing policy attachment for OIDC role

the blueprint specifies:
```ts
const demoOidcRole = DeclaredAwsIamRole.as({ policy: demoPermissionsPolicy, ... });
```

but `DeclaredAwsIamRole` has:
```ts
policies: DeclaredAwsIamPolicyStatement[];
```

this is just the trust policy (assume role statements). there's no `policy: DeclaredAwsIamPolicyBundle` field yet.

**diagnosis**: `DeclaredAwsIamRole` needs:
1. trust policy (who can assume) — already exists as `policies`
2. permissions policy (what they can do) — missing

the existing `setIamRole` operation only sets the trust policy, not inline/managed permission policies. the `DeclaredAwsIamRolePolicy` is separate.

**action**: either:
1. compose `DeclaredAwsIamRole` + `DeclaredAwsIamRolePolicy` in demo resources
2. or add a `permissions: DeclaredAwsIamPolicyBundle` field to `DeclaredAwsIamRole`

---

### blocker.5 — OIDC provider created in wrong account

the wish specifies:
> set a DeclaredAwsOrganizationAccount under that organization
> set the resources required to enable github-actions to auth via `oidc` under that demo role

the oidc provider and oidc role must be created **in the demo account**, not the management account.

current code creates `githubOidcProvider` in the management account context.

**diagnosis**: the oidc provider is in the wrong account. it needs to be created in the demo account after the account is provisioned.

**action**: either:
1. use cross-account role assumption to create resources in demo account
2. or split into separate resource files (one per account)
3. or have declastruct support cross-account provisioning

---

## nitpicks

### nitpick.1 — DeclaredAwsIamRole.policies naming

the field `policies: DeclaredAwsIamPolicyStatement[]` represents the **trust policy** (who can assume the role), not permission policies.

**suggestion**: rename to `trustPolicy` or `assumeRolePolicies` for clarity.

---

### nitpick.2 — inconsistent naming in tests

```ts
src/domain.objects/DeclaredAwsSsoAccountAssignment.test.ts(72,21): error TS2353:
Object literal may only specify known properties, and 'name' does not exist in type 'Ref<typeof DeclaredAwsOrganizationAccount>'.
```

test uses `{ name: ... }` but `DeclaredAwsOrganizationAccount.unique` is probably `['email']` or similar.

---

### nitpick.3 — missing waiters for async operations

`setSsoAccountAssignment` creates the assignment but the creation is async. aws returns `AccountAssignmentCreationStatus` with `IN_PROGRESS` status.

**current code**:
```ts
if (createResponse.AccountAssignmentCreationStatus?.FailureReason) ...
```

this only checks for immediate failure, not for async completion.

**suggestion**: poll until status is `SUCCEEDED` before returning.

---

### nitpick.4 — empty organization returned in demo resources

```ts
const organization = await setOrganization(
  { finsert: new DeclaredAwsOrganization({ ... }) },
  providerContext,
);
```

this is called during `getResources()` which should be declarative. calling `setOrganization` inside `getResources` mixes declaration with execution.

**suggestion**: declare the organization object and let declastruct handle the set. if prereq lookup is needed, use a separate method.

---

## what will work

1. **sso permission set creation/update** — `setSsoPermissionSet` looks solid
2. **sso user creation/update** — `setSsoUser` looks solid
3. **oidc provider creation/update** — `setIamOidcProvider` handles thumbprints and client ids
4. **sso account assignment creation** — basic finsert works (pending ref resolution)
5. **domain object definitions** — well-structured with clear identity keys

---

## what won't work

1. **github actions oidc auth** — no oidc role to assume
2. **demo permissions via oidc** — no policy bundle attached to oidc role
3. **cross-account oidc** — oidc provider in wrong account
4. **type check** — won't pass due to blocker.1 and blocker.2
5. **declastruct apply** — will fail on type errors before any aws calls

---

## recommendation

priority order:
1. fix blocker.1 (DomainLiteral vs empty primary)
2. fix blocker.2 (ref type compatibility)
3. fix blocker.3 + blocker.4 (add oidc role with permissions)
4. fix blocker.5 (cross-account provisioning strategy)

until blockers 1-2 are fixed, `npm run test:types` and `npm run build` will fail.
