# IAM Role Policy Attachment Refactor

## summary

refactor `DeclaredAwsIamRolePolicy` into two cleaner domain objects that better model AWS's separation of inline vs managed policy attachments.

## research

### aws api model

AWS treats role policy attachments as two separate mechanisms:

**inline policies** (policy document embedded in role):
- `PutRolePolicyCommand({ RoleName, PolicyName, PolicyDocument })`
- `DeleteRolePolicyCommand({ RoleName, PolicyName })`
- `ListRolePoliciesCommand({ RoleName })`
- `GetRolePolicyCommand({ RoleName, PolicyName })`

**managed policy attachments** (reference to standalone policy):
- `AttachRolePolicyCommand({ RoleName, PolicyArn })`
- `DetachRolePolicyCommand({ RoleName, PolicyArn })`
- `ListAttachedRolePoliciesCommand({ RoleName })`

**managed policy itself** (standalone resource):
- `GetPolicy({ PolicyArn })` - returns metadata (name, path, description, defaultVersionId)
- `GetPolicyVersion({ PolicyArn, VersionId })` - returns actual policy document
- `CreatePolicy({ PolicyName, PolicyDocument, Path?, Description?, Tags? })`

### managed policy response fields

from `GetPolicy`:
- `Arn` - primary identifier
- `PolicyName` - unique with path
- `Path` - defaults to '/'
- `Description` - optional
- `DefaultVersionId` - e.g., 'v1'
- `PolicyId` - internal aws id
- `CreateDate`, `UpdateDate` - timestamps
- `AttachmentCount` - number of attached entities

from `GetPolicyVersion`:
- `Document` - the actual policy JSON (URL-encoded)
- `VersionId` - e.g., 'v1'
- `IsDefaultVersion` - boolean
- `CreateDate` - timestamp

## design

### before

```ts
// single entity for inline policies only
interface DeclaredAwsIamRolePolicy {
  name: string;
  role: RefByUnique<typeof DeclaredAwsIamRole>;
  statements: DeclaredAwsIamPolicyStatement[];
}
```

### after

```ts
// inline policy attachment (document embedded)
interface DeclaredAwsIamRolePolicyAttachedDocument {
  name: string;
  role: RefByUnique<typeof DeclaredAwsIamRole>;
  document: DeclaredAwsIamPolicyDocument;
}

// managed policy attachment (reference to standalone policy)
interface DeclaredAwsIamRolePolicyAttachedReference {
  role: RefByUnique<typeof DeclaredAwsIamRole>;
  policy: RefByPrimary<typeof DeclaredAwsIamPolicy>;
}

// standalone managed policy (new)
interface DeclaredAwsIamPolicy {
  arn?: string;           // @primary, @metadata
  name: string;           // @unique (with path)
  path?: string;          // @unique (with name), default '/'
  description?: string;
  document: DeclaredAwsIamPolicyDocument;
  tags?: DeclaredAwsTags;
}
```

### naming rationale

- `AttachedDocument` - the policy content is *documented* (embedded) here
- `AttachedReference` - this is a *reference* to a policy that exists elsewhere
- clearer than `Inline` vs `Managed` which are AWS implementation terms

## tasks

1. [x] create `DeclaredAwsIamPolicy` domain object
2. [x] create `getOneIamPolicy` operation (supports AWS-managed + customer-managed)
3. [x] create `castIntoDeclaredAwsIamPolicy`
4. [x] create `DeclaredAwsIamRolePolicyAttachedDocument` domain object (new file, old one kept for backwards compat)
5. [x] create `DeclaredAwsIamRolePolicyAttachedReference` domain object
6. [x] create operations for `DeclaredAwsIamRolePolicyAttachedDocument` (set, get, del)
7. [x] create operations for `DeclaredAwsIamRolePolicyAttachedReference` (set, get, del)
8. [x] create DAOs for new domain objects
9. [x] update SDK exports
10. [x] update provision/ usages (resources.oidc.ts now uses both AttachedDocument and AttachedReference)
11. [ ] deprecate/remove old `DeclaredAwsIamRolePolicy` (kept for backwards compat)

## sources

- [GetPolicy API](https://docs.aws.amazon.com/IAM/latest/APIReference/API_GetPolicy.html)
- [GetPolicyVersion API](https://docs.aws.amazon.com/IAM/latest/APIReference/API_GetPolicyVersion.html)
