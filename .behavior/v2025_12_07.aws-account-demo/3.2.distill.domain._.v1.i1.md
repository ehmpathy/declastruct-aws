# distillation: declastruct domain for aws account provisioning

distillation for fulfilling the wish declared in:
- `.behavior/v2025_12_07.aws-account-demo/0.wish.md`
- `.behavior/v2025_12_07.aws-account-demo/1.vision.md`

based on research in:
- `.behavior/v2025_12_07.aws-account-demo/3.1.research.domain._.v1.i1.md`

---

## 1. usecases

### 1.1 overview

the wish describes a two-phase provisioning flow:

**phase 1: root admin bootstraps admin role** (under `use.ehmpathy.root`)
- find-or-create resources required for admin to signin via `aws sso`

**phase 2: admin provisions demo infrastructure** (under `use.ehmpathy.admin`)
1. set a `DeclaredAwsOrganization`
2. set a `DeclaredAwsOrganizationAccount` under that organization
3. set a narrowed `ehmpathy-demo-role` under that account
4. set sso resources for demo agents to signin via `aws sso`
5. set oidc resources for github-actions to auth via federated identity

---

### 1.2 usecase contracts

#### UC1: setOrganization

```ts
// already exists in repo
await setOrganization({
  findsert: {
    managementAccount: { id: '123456789012' },
    featureSet: 'ALL',
  },
}, context);
```

#### UC2: setOrganizationAccount

```ts
// already exists in repo
await setOrganizationAccount({
  findsert: {
    organization: { id: 'o-abc123' },
    name: 'ehmpathy-demo',
    email: 'demo@ehmpathy.com',
    iamUserAccessToBilling: 'ALLOW',
  },
}, context);
```

#### UC3: setIamOidcProvider

```ts
// NEW - needed for github actions oidc auth
await setIamOidcProvider({
  findsert: {
    url: 'https://token.actions.githubusercontent.com',
    clientIds: ['sts.amazonaws.com'],
    thumbprints: ['6938fd4d98bab03faadb97b34396831e3780aea1'],
  },
}, context);
```

#### UC4: setIamRole (for oidc-assumable demo role)

```ts
// already exists in repo, but needs oidc trust policy support
await setIamRole({
  findsert: {
    name: 'ehmpathy-demo-role',
    policies: [
      {
        effect: 'Allow',
        action: 'sts:AssumeRoleWithWebIdentity',
        principal: {
          federated: 'arn:aws:iam::${accountId}:oidc-provider/token.actions.githubusercontent.com',
        },
        condition: {
          StringEquals: {
            'token.actions.githubusercontent.com:aud': 'sts.amazonaws.com',
          },
          StringLike: {
            'token.actions.githubusercontent.com:sub': 'repo:ehmpathy/*:*',
          },
        },
      },
    ],
    tags: { purpose: 'demo' },
  },
}, context);
```

#### UC5: setSsoPermissionSet

```ts
// NEW - needed for sso-based demo agent signin
await setSsoPermissionSet({
  findsert: {
    instanceArn: 'arn:aws:sso:::instance/ssoins-xxx',
    name: 'EhmpathyDemoAccess',
    description: 'Demo access for ehmpathy agents',
    sessionDuration: 'PT4H',
    managedPolicies: ['arn:aws:iam::aws:policy/ReadOnlyAccess'],
  },
}, context);
```

#### UC6: setSsoUser

```ts
// NEW - needed for sso-based demo agent signin
await setSsoUser({
  findsert: {
    identityStoreId: 'd-1234567890',
    userName: 'demo-agent',
    displayName: 'Demo Agent',
    email: 'demo-agent@ehmpathy.com',
  },
}, context);
```

#### UC7: setSsoAccountAssignment

```ts
// NEW - needed to link user/group to account via permission set
await setSsoAccountAssignment({
  findsert: {
    instanceArn: 'arn:aws:sso:::instance/ssoins-xxx',
    permissionSetArn: 'arn:aws:sso:::permissionSet/ssoins-xxx/ps-xxx',
    principalType: 'USER',
    principalId: 'user-uuid',
    targetType: 'AWS_ACCOUNT',
    targetId: '123456789012',
  },
}, context);
```

---

## 2. domain.objects

### 2.1 already exists (reuse)

| domain object                    | status   | notes                                                                            |
| -------------------------------- | -------- | -------------------------------------------------------------------------------- |
| `DeclaredAwsOrganization`        | ✅ exists | no changes needed                                                                |
| `DeclaredAwsOrganizationAccount` | ✅ exists | no changes needed                                                                |
| `DeclaredAwsIamRole`             | ✅ exists | needs `policy: DeclaredAwsIamPolicyBundle` + `condition` support in trust policy |
| `DeclaredAwsIamPolicyStatement`  | ✅ exists | needs `condition` field added                                                    |

### 2.2 needs creation

#### 2.2.1 DeclaredAwsIamOidcProvider

```ts
/**
 * .what = a declarative structure representing an AWS IAM OIDC Provider
 * .why = enables github actions and other oidc-based federated auth
 *
 * .identity
 *   - @primary = [arn] — assigned by aws on creation
 *   - @unique = [url] — each url can only have one provider per account
 */
export interface DeclaredAwsIamOidcProvider {
  /**
   * .what = the arn of the oidc provider
   * .note = @metadata — assigned by aws on creation
   */
  arn?: string;

  /**
   * .what = the url of the identity provider (e.g., 'https://token.actions.githubusercontent.com')
   * .note = @unique — only one provider per url per account
   */
  url: string;

  /**
   * .what = client ids (audiences) allowed to authenticate
   * .note = typically 'sts.amazonaws.com' for aws role assumption
   */
  clientIds: string[];

  /**
   * .what = server certificate thumbprints for the oidc provider
   * .note = sha-1 hex fingerprints of the tls cert chain
   * .note = can be empty for AWS-trusted providers (GitHub, Google, Auth0)
   */
  thumbprints: string[];

  /**
   * .what = optional tags for the provider
   */
  tags?: Record<string, string>;
}

export class DeclaredAwsIamOidcProvider
  extends DomainEntity<DeclaredAwsIamOidcProvider>
  implements DeclaredAwsIamOidcProvider
{
  public static primary = ['arn'] as const;
  public static unique = ['url'] as const;
  public static metadata = ['arn'] as const;
  public static readonly = [] as const;
  public static nested = { tags: DomainLiteral };
}
```

---

#### 2.2.2 DeclaredAwsIamPolicyBundle

```ts
/**
 * .what = a bundle of iam permissions combining managed and inline policies
 * .why = enables reusing a set of permissions across IAM roles and SSO permission sets
 *
 * .note
 *   - this is a literal (value object) since it has no identity — just shape
 *   - aws treats managed and inline policies as separate attachment mechanisms
 *   - this abstraction groups them for convenient code reuse
 */
export interface DeclaredAwsIamPolicyBundle {
  /**
   * .what = arns of aws managed policies to attach
   */
  managed: string[];

  /**
   * .what = inline policy document with custom statements
   */
  inline: DeclaredAwsIamPolicyDocument;
}

export class DeclaredAwsIamPolicyBundle
  extends DomainLiteral<DeclaredAwsIamPolicyBundle>
  implements DeclaredAwsIamPolicyBundle
{
  public static nested = {
    inline: DeclaredAwsIamPolicyDocument,
  };
}
```

---

#### 2.2.4 DeclaredAwsSsoPermissionSet

```ts
/**
 * .what = a declarative structure representing an AWS SSO Permission Set
 * .why = defines the level of access users get when assuming a role via sso
 *
 * .identity
 *   - @primary = [arn] — assigned by aws on creation
 *   - @unique = [instanceArn, name] — name is unique per identity center instance
 */
export interface DeclaredAwsSsoPermissionSet {
  /**
   * .what = the arn of the permission set
   * .note = @metadata — assigned by aws on creation
   */
  arn?: string;

  /**
   * .what = the arn of the identity center instance
   */
  instanceArn: string;

  /**
   * .what = the name of the permission set
   * .constraint = 1-32 chars
   */
  name: string;

  /**
   * .what = description of the permission set
   */
  description?: string;

  /**
   * .what = session duration in iso-8601 format
   * .default = 'PT1H'
   */
  sessionDuration?: string;

  /**
   * .what = the permissions bundle (managed + inline policies)
   */
  policy: DeclaredAwsIamPolicyBundle;

  /**
   * .what = optional tags
   */
  tags?: Record<string, string>;
}

export class DeclaredAwsSsoPermissionSet
  extends DomainEntity<DeclaredAwsSsoPermissionSet>
  implements DeclaredAwsSsoPermissionSet
{
  public static primary = ['arn'] as const;
  public static unique = ['instanceArn', 'name'] as const;
  public static metadata = ['arn'] as const;
  public static readonly = [] as const;
  public static nested = {
    policy: DeclaredAwsIamPolicyBundle,
    tags: DomainLiteral,
  };
}
```

---

#### 2.2.5 DeclaredAwsSsoUser

```ts
/**
 * .what = a declarative structure representing an AWS Identity Center User
 * .why = enables creating users for sso-based access
 *
 * .identity
 *   - @primary = [id] — assigned by aws on creation
 *   - @unique = [identityStoreId, userName] — userName is unique per identity store
 */
export interface DeclaredAwsSsoUser {
  /**
   * .what = the unique user id
   * .note = @metadata — assigned by aws on creation
   */
  id?: string;

  /**
   * .what = the identity store this user belongs to
   */
  identityStoreId: string;

  /**
   * .what = the unique username
   * .constraint = max 128 chars
   */
  userName: string;

  /**
   * .what = display name for the user
   */
  displayName: string;

  /**
   * .what = given (first) name
   */
  givenName?: string;

  /**
   * .what = family (last) name
   */
  familyName?: string;

  /**
   * .what = primary email address
   */
  email: string;
}

export class DeclaredAwsSsoUser
  extends DomainEntity<DeclaredAwsSsoUser>
  implements DeclaredAwsSsoUser
{
  public static primary = ['id'] as const;
  public static unique = ['identityStoreId', 'userName'] as const;
  public static metadata = ['id'] as const;
  public static readonly = [] as const;
  public static nested = {};
}
```

---

#### 2.2.6 DeclaredAwsSsoAccountAssignment

```ts
/**
 * .what = a declarative structure representing an SSO Account Assignment
 * .why = links a user/group to an account via a permission set
 *
 * .identity
 *   - @primary = composite key (no single aws-assigned id)
 *   - @unique = [instanceArn, permissionSet, principalType, principal, target]
 */
export interface DeclaredAwsSsoAccountAssignment {
  /**
   * .what = the identity center instance arn
   */
  instanceArn: string;

  /**
   * .what = reference to the permission set defining access level
   */
  permissionSet: Ref<typeof DeclaredAwsSsoPermissionSet>;

  /**
   * .what = type of principal being assigned
   */
  principalType: 'USER' | 'GROUP';

  /**
   * .what = reference to the user or group
   */
  principal: Ref<typeof DeclaredAwsSsoUser>; // or DeclaredAwsSsoGroup when supported

  /**
   * .what = type of target (always AWS_ACCOUNT for account assignments)
   */
  targetType: 'AWS_ACCOUNT';

  /**
   * .what = reference to the target account, or raw account id
   */
  target: Ref<typeof DeclaredAwsOrganizationAccount> | string;
}

export class DeclaredAwsSsoAccountAssignment
  extends DomainEntity<DeclaredAwsSsoAccountAssignment>
  implements DeclaredAwsSsoAccountAssignment
{
  public static primary = [
    'instanceArn',
    'permissionSet',
    'principalType',
    'principal',
    'target',
  ] as const;
  public static unique = [
    'instanceArn',
    'permissionSet',
    'principalType',
    'principal',
    'target',
  ] as const;
  public static metadata = [] as const;
  public static readonly = [] as const;
  public static nested = {};
}
```

---

### 2.3 needs update

#### 2.3.1 DeclaredAwsIamPolicyStatement

add `condition` field to support oidc trust policies:

```ts
// add to existing interface
interface DeclaredAwsIamPolicyStatement {
  // ... existing fields ...

  /**
   * .what = optional conditions for when this statement applies
   * .why = needed for oidc trust policies with audience/subject restrictions
   */
  condition?: Record<string, Record<string, string | string[]>>;
}
```

---

## 3. domain.operations

### 3.1 already exists (reuse)

| folder                 | operations                                                 | notes                        |
| ---------------------- | ---------------------------------------------------------- | ---------------------------- |
| `organization/`        | `getOneOrganization`, `setOrganization`, `delOrganization` | ✅ complete                   |
| `organizationAccount/` | `getOneOrganizationAccount`, `setOrganizationAccount`      | needs creation if not exists |
| `iamRole/`             | `getIamRole`, `setIamRole`                                 | ✅ exists                     |

### 3.2 needs creation

#### 3.2.1 iamOidcProvider/

| file                                    | description                    |
| --------------------------------------- | ------------------------------ |
| `castIntoDeclaredAwsIamOidcProvider.ts` | cast from sdk response         |
| `getOneIamOidcProvider.ts`              | get by primary, unique, or ref |
| `getAllIamOidcProviders.ts`             | list all providers             |
| `setIamOidcProvider.ts`                 | findsert/upsert provider       |
| `delIamOidcProvider.ts`                 | delete provider                |

---

#### 3.2.2 ssoPermissionSet/

| file                                     | description                    |
| ---------------------------------------- | ------------------------------ |
| `castIntoDeclaredAwsSsoPermissionSet.ts` | cast from sdk response         |
| `getOneSsoPermissionSet.ts`              | get by primary, unique, or ref |
| `getAllSsoPermissionSets.ts`             | list all permission sets       |
| `setSsoPermissionSet.ts`                 | findsert/upsert permission set |
| `delSsoPermissionSet.ts`                 | delete permission set          |

---

#### 3.2.3 ssoUser/

| file                            | description                    |
| ------------------------------- | ------------------------------ |
| `castIntoDeclaredAwsSsoUser.ts` | cast from sdk response         |
| `getOneSsoUser.ts`              | get by primary, unique, or ref |
| `getAllSsoUsers.ts`             | list all users                 |
| `setSsoUser.ts`                 | findsert/upsert user           |
| `delSsoUser.ts`                 | delete user                    |

---

#### 3.2.4 ssoAccountAssignment/

| file                                         | description                                   |
| -------------------------------------------- | --------------------------------------------- |
| `castIntoDeclaredAwsSsoAccountAssignment.ts` | cast from sdk response                        |
| `getOneSsoAccountAssignment.ts`              | get by composite key                          |
| `getAllSsoAccountAssignments.ts`             | list assignments for permission set + account |
| `setSsoAccountAssignment.ts`                 | findsert assignment                           |
| `delSsoAccountAssignment.ts`                 | delete assignment                             |

---

## 4. access.daos

### 4.1 already exists (reuse)

| dao                                 | status   |
| ----------------------------------- | -------- |
| `DeclaredAwsOrganizationDao`        | ✅ exists |
| `DeclaredAwsOrganizationAccountDao` | ✅ exists |
| `DeclaredAwsIamRoleDao`             | ✅ exists |

### 4.2 needs creation

| dao                                  | description                         |
| ------------------------------------ | ----------------------------------- |
| `DeclaredAwsIamOidcProviderDao`      | wraps oidc provider operations      |
| `DeclaredAwsSsoPermissionSetDao`     | wraps permission set operations     |
| `DeclaredAwsSsoUserDao`              | wraps user operations               |
| `DeclaredAwsSsoAccountAssignmentDao` | wraps account assignment operations |

---

## 5. sdk packages required

| package                         | purpose                              |
| ------------------------------- | ------------------------------------ |
| `@aws-sdk/client-organizations` | organizations, accounts              |
| `@aws-sdk/client-iam`           | iam roles, oidc providers            |
| `@aws-sdk/client-sso-admin`     | permission sets, account assignments |
| `@aws-sdk/client-identitystore` | sso users, groups                    |

---

## 6. summary: what needs to be built

### new domain.objects (4)
1. `DeclaredAwsIamOidcProvider`
2. `DeclaredAwsSsoPermissionSet`
3. `DeclaredAwsSsoUser`
4. `DeclaredAwsSsoAccountAssignment`

### updated domain.objects (1)
1. `DeclaredAwsIamPolicyStatement` — add `condition` field

### new domain.operations (4 folders, ~20 files)
1. `iamOidcProvider/` — cast, getOne, getAll, set, del
2. `ssoPermissionSet/` — cast, getOne, getAll, set, del
3. `ssoUser/` — cast, getOne, getAll, set, del
4. `ssoAccountAssignment/` — cast, getOne, getAll, set, del

### new access.daos (4)
1. `DeclaredAwsIamOidcProviderDao`
2. `DeclaredAwsSsoPermissionSetDao`
3. `DeclaredAwsSsoUserDao`
4. `DeclaredAwsSsoAccountAssignmentDao`

---

## 7. full contract examples

### 7.1 phase 1: provision/aws/admin.declastruct.resources.ts

```ts
/**
 * .what = bootstrap admin sso access for human administrators
 * .why = enables admins to signin via `aws sso login` instead of root credentials
 *
 * .auth = AWS_PROFILE=use.ehmpathy.root (or root console)
 *
 * .usage
 *   AWS_PROFILE=use.ehmpathy.root npx declastruct plan provision/aws/admin.declastruct.resources.ts
 *   AWS_PROFILE=use.ehmpathy.root npx declastruct apply provision/aws/admin.declastruct.resources.ts
 *
 * .prereq
 *   - identity center must be enabled manually in console (one-time)
 *   - this script provisions the permission set and user assignments
 */
import { DeclastructProvider } from 'declastruct';
import { DomainEntity, RefByUnique } from 'domain-objects';

import {
  DeclaredAwsSsoPermissionSet,
  DeclaredAwsSsoUser,
  DeclaredAwsSsoAccountAssignment,
  getDeclastructAwsProvider,
  getSsoInstance,
} from '../../src/contract/sdks';

export const getProviders = async (): Promise<DeclastructProvider[]> => [
  await getDeclastructAwsProvider(
    {},
    {
      log: {
        info: console.info,
        debug: () => {},
        warn: console.warn,
        error: console.error,
      },
    },
  ),
];

export const getResources = async (): Promise<DomainEntity<any>[]> => {
  // get the provider context
  const [provider] = await getProviders();
  const providerContext = (provider as any).context;
  const accountId = providerContext.aws.credentials.account;

  // lookup the identity center instance (must already be enabled in console)
  const ssoInstance = await getSsoInstance({ by: { auth: true } }, providerContext);
  if (!ssoInstance) throw new Error('identity center not enabled. enable it in aws console first.');

  // declare the admin permission set
  const adminPermissionSet = DeclaredAwsSsoPermissionSet.as({
    instanceArn: ssoInstance.instanceArn,
    name: 'AdministratorAccess',
    description: 'Full administrator access for human admins',
    sessionDuration: 'PT4H',
    managedPolicies: ['arn:aws:iam::aws:policy/AdministratorAccess'],
  });

  // declare the admin user
  const adminUser = DeclaredAwsSsoUser.as({
    identityStoreId: ssoInstance.identityStoreId,
    userName: 'admin',
    displayName: 'Admin User',
    givenName: 'Admin',
    familyName: 'User',
    email: 'admin@ehmpathy.com',
  });

  // declare the account assignment linking admin user to account via permission set
  const adminAssignment = DeclaredAwsSsoAccountAssignment.as({
    instanceArn: ssoInstance.instanceArn,
    permissionSet: RefByUnique.as<typeof DeclaredAwsSsoPermissionSet>(adminPermissionSet),
    principalType: 'USER',
    principal: RefByUnique.as<typeof DeclaredAwsSsoUser>(adminUser),
    targetType: 'AWS_ACCOUNT',
    targetId: accountId, // management account id from context
  });

  return [adminPermissionSet, adminUser, adminAssignment];
};
```

---

### 7.2 phase 2: provision/aws/demo.declastruct.resources.ts

```ts
/**
 * .what = provision demo infrastructure for ehmpathy-demo account
 * .why = enables demo agents (sso) and github actions (oidc) to access demo account
 *
 * .auth = AWS_PROFILE=use.ehmpathy.admin
 *
 * .usage
 *   AWS_PROFILE=use.ehmpathy.admin npx declastruct plan provision/aws/demo.declastruct.resources.ts
 *   AWS_PROFILE=use.ehmpathy.admin npx declastruct apply provision/aws/demo.declastruct.resources.ts
 *
 * .steps
 *   1. declare organization
 *   2. declare demo account in organization
 *   3. declare github oidc provider for demo account
 *   4. declare unified demo role (assumable by both OIDC and SSO)
 *   5. declare permission set that allows assuming the unified demo role
 *   6. declare demo user for agent access
 *   7. declare demo user assignment to demo account via permission set
 */
import { DeclastructProvider } from 'declastruct';
import { DomainEntity, RefByUnique, RefByPrimary } from 'domain-objects';

import {
  DeclaredAwsOrganization,
  DeclaredAwsOrganizationAccount,
  DeclaredAwsIamRole,
  DeclaredAwsIamOidcProvider,
  DeclaredAwsIamPolicyBundle,
  DeclaredAwsIamPolicyDocument,
  DeclaredAwsIamPolicyStatement,
  DeclaredAwsSsoPermissionSet,
  DeclaredAwsSsoUser,
  DeclaredAwsSsoAccountAssignment,
  getDeclastructAwsProvider,
  getSsoInstance,
} from '../../src/contract/sdks';

export const getProviders = async (): Promise<DeclastructProvider[]> => [
  await getDeclastructAwsProvider(
    {},
    {
      log: {
        info: console.info,
        debug: () => {},
        warn: console.warn,
        error: console.error,
      },
    },
  ),
];

export const getResources = async (): Promise<DomainEntity<any>[]> => {
  // get the provider context
  const [provider] = await getProviders();
  const providerContext = (provider as any).context;
  const managementAccountId = providerContext.aws.credentials.account;

  // lookup the identity center instance
  const ssoInstance = await getSsoInstance({ by: { auth: true } }, providerContext);
  if (!ssoInstance) throw new Error('identity center not enabled');

  // =========================================================================
  // step 1: declare organization
  // =========================================================================
  const organization = DeclaredAwsOrganization.as({
    managementAccount: { id: managementAccountId },
    featureSet: 'ALL',
  });

  // =========================================================================
  // step 2: declare demo account in organization
  // =========================================================================
  const demoAccount = DeclaredAwsOrganizationAccount.as({
    organization: RefByUnique.as<typeof DeclaredAwsOrganization>(organization),
    name: 'ehmpathy-demo',
    email: 'demo@ehmpathy.com',
    iamUserAccessToBilling: 'ALLOW',
    tags: {
      managedBy: 'declastruct',
      purpose: 'demo',
    },
  });

  // =========================================================================
  // step 3: declare github oidc provider for demo account
  // note: as of 2025, AWS trusts GitHub's root CA — thumbprints are ignored
  //       for GitHub, Google, Auth0. we omit them for cleaner maintenance.
  // ref: https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_providers_create_oidc_verify-thumbprint.html
  // =========================================================================
  const githubOidcProvider = DeclaredAwsIamOidcProvider.as({
    url: 'https://token.actions.githubusercontent.com',
    clientIds: ['sts.amazonaws.com'],
    thumbprints: [], // empty — AWS uses trusted root CA for GitHub
    tags: {
      managedBy: 'declastruct',
      purpose: 'github-actions-oidc',
    },
  });

  // =========================================================================
  // step 4: declare shared demo permissions policy
  // note: single source of truth — reused by both IAM role (OIDC) and permission set (SSO)
  // =========================================================================
  const demoPermissionsPolicy = DeclaredAwsIamPolicyBundle.as({
    managed: ['arn:aws:iam::aws:policy/ReadOnlyAccess'],
    inline: DeclaredAwsIamPolicyDocument.as({
      statements: [
        DeclaredAwsIamPolicyStatement.as({
          effect: 'Allow',
          action: ['s3:PutObject', 's3:GetObject', 's3:DeleteObject'],
          resource: ['arn:aws:s3:::ehmpathy-demo-*', 'arn:aws:s3:::ehmpathy-demo-*/*'],
        }),
        DeclaredAwsIamPolicyStatement.as({
          effect: 'Allow',
          action: ['lambda:InvokeFunction'],
          resource: [`arn:aws:lambda:*:${demoAccount.id}:function:ehmpathy-demo-*`],
        }),
      ],
    }),
  });

  // =========================================================================
  // step 5: declare demo role for github actions (OIDC)
  // note: uses shared permissions policy
  // =========================================================================
  const demoOidcRole = DeclaredAwsIamRole.as({
    name: 'ehmpathy-demo-oidc',
    description: 'Demo role for github actions (OIDC)',
    assumeRolePolicy: {
      version: '2012-10-17',
      statements: [
        // trust policy: allow github actions to assume via oidc
        {
          effect: 'Allow',
          action: 'sts:AssumeRoleWithWebIdentity',
          principal: {
            federated: `arn:aws:iam::${demoAccount.id}:oidc-provider/token.actions.githubusercontent.com`,
          },
          condition: {
            StringEquals: {
              'token.actions.githubusercontent.com:aud': 'sts.amazonaws.com',
            },
            StringLike: {
              'token.actions.githubusercontent.com:sub': 'repo:ehmpathy/*:*',
            },
          },
        },
      ],
    },
    // permissions: reuse shared policy
    policy: demoPermissionsPolicy,
    tags: {
      managedBy: 'declastruct',
      purpose: 'demo',
    },
  });

  // =========================================================================
  // step 6: declare permission set for sso users
  // note: uses shared permissions policy — sso users get permissions directly
  // =========================================================================
  const demoPermissionSet = DeclaredAwsSsoPermissionSet.as({
    instanceArn: ssoInstance.instanceArn,
    name: 'ehmpathy-demo-sso',
    description: 'Demo access for ehmpathy agents (SSO)',
    sessionDuration: 'PT4H',
    // permissions: reuse shared policy
    policy: demoPermissionsPolicy,
  });

  // =========================================================================
  // step 7: declare demo user for agent access
  // =========================================================================
  const demoUser = DeclaredAwsSsoUser.as({
    identityStoreId: ssoInstance.identityStoreId,
    userName: 'demo-agent',
    displayName: 'Demo Agent',
    givenName: 'Demo',
    familyName: 'Agent',
    email: 'demo-agent@ehmpathy.com',
  });

  // =========================================================================
  // step 8: declare demo user assignment to demo account via permission set
  // =========================================================================
  const demoAssignment = DeclaredAwsSsoAccountAssignment.as({
    instanceArn: ssoInstance.instanceArn,
    permissionSet: RefByUnique.as<typeof DeclaredAwsSsoPermissionSet>(demoPermissionSet),
    principalType: 'USER',
    principal: RefByUnique.as<typeof DeclaredAwsSsoUser>(demoUser),
    targetType: 'AWS_ACCOUNT',
    target: RefByUnique.as<typeof DeclaredAwsOrganizationAccount>(demoAccount),
  });

  // =========================================================================
  // return all declared resources for declastruct to apply
  // =========================================================================
  return [
    // organization layer
    organization,
    demoAccount,

    // iam layer (for demo account)
    githubOidcProvider,
    demoOidcRole,

    // sso layer (for management account)
    demoPermissionSet,
    demoUser,
    demoAssignment,
  ];
};
```

---

### 7.3 usage summary

#### phase 1: root bootstraps admin

```bash
# authenticate as root (or initial admin)
AWS_PROFILE=use.ehmpathy.root npx declastruct plan provision/aws/admin.declastruct.resources.ts
AWS_PROFILE=use.ehmpathy.root npx declastruct apply provision/aws/admin.declastruct.resources.ts
```

**result**: admin can now signin via `aws sso login --profile use.ehmpathy.admin`

---

#### phase 2: admin provisions demo

```bash
# authenticate as admin (via sso)
aws sso login --profile use.ehmpathy.admin
AWS_PROFILE=use.ehmpathy.admin npx declastruct plan provision/aws/demo.declastruct.resources.ts
AWS_PROFILE=use.ehmpathy.admin npx declastruct apply provision/aws/demo.declastruct.resources.ts
```

**result**:
1. organization exists
2. `ehmpathy-demo` account exists under the organization
3. github oidc provider exists in demo account
4. `ehmpathy-demo-oidc` role exists for github actions
5. `ehmpathy-demo-sso` permission set exists with full demo permissions
6. demo user exists
7. demo user can signin and get demo permissions directly

---

### 7.4 after provisioning

#### github actions usage

```yaml
# .github/workflows/deploy.yml
permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${DEMO_ACCOUNT_ID}:role/ehmpathy-demo-oidc
          aws-region: us-east-1

      - run: aws sts get-caller-identity
```

#### agent sso usage

configure `~/.aws/config` with a single profile — sso users get full demo permissions directly from the permission set:

```ini
# ~/.aws/config

[profile use.ehmpathy.demo]
sso_start_url = https://ehmpathy.awsapps.com/start
sso_region = us-east-1
sso_account_id = ${DEMO_ACCOUNT_ID}
sso_role_name = ehmpathy-demo-sso
region = us-east-1
```

then usage is simple:

```bash
# authenticate once (opens browser for sso)
aws sso login --profile use.ehmpathy.demo

# use the profile — has full demo permissions directly
AWS_PROFILE=use.ehmpathy.demo aws sts get-caller-identity
```

no role assumption needed — the permission set provides demo permissions directly.

---

### 7.5 access flow

```
GitHub Actions (OIDC)              SSO User (agents)
        │                                 │
        │                                 ▼
        │                        aws sso login
        │                                 │
        ▼                                 ▼
┌─────────────────────┐       ┌─────────────────────┐
│  ehmpathy-demo-oidc │       │  ehmpathy-demo-sso  │
│     (IAM role)      │       │  (permission set)   │
└─────────────────────┘       └─────────────────────┘
        │                                 │
        └────────────┬────────────────────┘
                     ▼
          ┌─────────────────────┐
          │ demoPermissionsPolicy│
          │ (shared permissions) │
          └─────────────────────┘
```

---

### 7.6 notes

1. **shared permissions policy**: both OIDC role and SSO permission set use the same `demoPermissionsPolicy` constant. this provides a single source of truth for demo permissions while allowing direct access (no role assumption for SSO).

2. **single profile for sso**: sso users get full permissions directly from the permission set — no chained profile or role assumption step needed.

3. **cross-account resources**: the oidc provider and demo role are declared for the demo account, but applied via the management account using assume-role. declastruct handles this via the `targetAccountId` pattern.

4. **idempotency**: all operations use findsert semantics (find-or-insert). running `declastruct apply` multiple times produces the same result.

5. **separation of concerns**: phase 1 (admin bootstrap) and phase 2 (demo provisioning) are separate files with separate auth requirements, following the "human builds the door, robot walks through it" pattern from the research.
