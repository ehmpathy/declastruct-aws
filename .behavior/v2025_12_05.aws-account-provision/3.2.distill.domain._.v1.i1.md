# Distilled Domain: AWS Account Provisioning

## Wish Reference
> "it were easy to provision a new aws account with declastruct-aws"
> e.g., for the usecase of creation of a demo account to use for ehmpathy public tests
> e.g., ehmpathy-cicd-public account

---

## 1. Usecases and Contracts

### Usecase 1: Provision a New AWS Account
**Goal:** Create a new member account within an AWS Organization for CI/CD or demo purposes.

**Prerequisites:**
1. Authenticated with credentials that have `organizations:CreateAccount` permission against the management account

**Contract (resources.acceptance.ts pattern):**
```typescript
import { RefByUnique } from 'domain-objects';
import {
  DeclaredAwsOrganization,
  DeclaredAwsOrganizationAccount,
  getDeclastructAwsProvider,
} from 'declastruct-aws';

/**
 * .what = provider configuration for AWS
 * .why = enables declastruct CLI to interact with AWS Organizations API
 */
export const getProviders = async () => [
  await getDeclastructAwsProvider(
    {},
    {
      log: {
        info: () => {},
        debug: () => {},
        warn: console.warn,
        error: console.error,
      },
    },
  ),
];

/**
 * .what = resource declarations for provisioning
 * .why = defines desired state of organization and accounts
 */
export const getResources = async () => {
  // declare the management account (the account creating/owning the org)
  const managementAccount = DeclaredAwsOrganizationAccount.as({
    name: 'ehmpathy-management',
    email: 'management@example.com',
  });

  // declare the organization
  const organization = DeclaredAwsOrganization.as({
    featureSet: 'ALL',
    managementAccount: RefByUnique.as<typeof DeclaredAwsOrganizationAccount>(managementAccount),
  });

  // declare the member account
  const account = DeclaredAwsOrganizationAccount.as({
    name: 'ehmpathy-cicd-public',
    email: 'ehmpathy-cicd-public@example.com',
    organization: RefByUnique.as<typeof DeclaredAwsOrganization>(organization),
    // iamUserAccessToBilling defaults to 'ALLOW' - cost awareness is important
    roleName: 'OrganizationAccountAccessRole', // optional, has default
    tags: {
      purpose: 'cicd',
      environment: 'public-tests',
    },
  });

  return [
    managementAccount,
    organization,
    account,
  ];
};
```

**Output:** After declastruct applies, the account will have metadata populated:
```typescript
// {
//   id: '987654321098',
//   arn: 'arn:aws:organizations::123456789012:account/o-exampleorgid/987654321098',
//   organization: { id: 'o-exampleorgid' },
//   name: 'ehmpathy-cicd-public',
//   email: 'ehmpathy-cicd-public@example.com',
//   state: 'ACTIVE',
//   joinedMethod: 'CREATED',
//   joinedAt: '2025-12-05T12:00:00Z',
// }
```

### Usecase 2: Query Existing Accounts
**Goal:** List or retrieve accounts in the organization.

**Contract:**
```typescript
// Get one by unique (name not available - use email)
const account = await getOneOrganizationAccount(
  { by: { unique: { email: 'ehmpathy-cicd-public@example.com' } } },
  context,
);

// Get one by primary (id)
const account = await getOneOrganizationAccount(
  { by: { primary: { id: '987654321098' } } },
  context,
);

// Get all accounts
const accounts = await getAllOrganizationAccounts({}, context);
```

### Usecase 3: Move Account to Organizational Unit
**Goal:** Organize accounts into OUs for policy management.

**Contract:**
```typescript
await moveOrganizationAccount(
  {
    account: { id: '987654321098' },
    from: { id: 'r-abc1' }, // root or OU
    to: { id: 'ou-abc1-12345678' }, // destination OU
  },
  context,
);
```

### Usecase 4: Close/Remove Account
**Goal:** Clean up accounts no longer needed.

**Contract:**
```typescript
// Close account (async, transitions to SUSPENDED)
await delOrganizationAccount(
  { by: { primary: { id: '987654321098' } } },
  context,
);
```

---

## 2. Domain Objects

### 2.1 DeclaredAwsOrganization

**File:** `src/domain.objects/DeclaredAwsOrganization.ts`

```typescript
import { DomainEntity, RefByUnique } from 'domain-objects';

import type { DeclaredAwsOrganizationAccount } from './DeclaredAwsOrganizationAccount';

/**
 * .what = the feature set enabled for the organization
 * .options
 *   - 'ALL' = full organization features including Service Control Policies (SCPs),
 *     tag policies, AI services opt-out policies, and backup policies.
 *     enables central governance and security controls across all member accounts.
 *   - 'CONSOLIDATED_BILLING' = billing-only mode. member accounts share a single
 *     payment method and receive volume discounts, but no policy controls.
 *     cannot be upgraded to 'ALL' without member account consent.
 */
export type OrganizationFeatureSet = 'ALL' | 'CONSOLIDATED_BILLING';

/**
 * .what = a declarative structure representing an AWS Organization
 * .why = enables referencing the organization that accounts belong to
 * .ref = https://docs.aws.amazon.com/organizations/latest/APIReference/API_Organization.html
 * .note
 *   - an AWS account can only be the management account of ONE organization
 *   - an account can only belong to ONE organization at a time
 */
export interface DeclaredAwsOrganization {
  /**
   * .what = the unique identifier (ID) of the organization
   * .note = is @metadata -> assigned by AWS on creation
   * .constraint = pattern: o-[a-z0-9]{10,32}
   */
  id?: string;

  /**
   * .what = the Amazon Resource Name (ARN) of the organization
   * .note = is @metadata -> assigned by AWS on creation
   */
  arn?: string;

  /**
   * .what = the feature set enabled for the organization
   * .note = ALL enables SCPs and other policies; CONSOLIDATED_BILLING is billing only
   * .default = 'ALL'
   */
  featureSet: OrganizationFeatureSet;

  /**
   * .what = the management account that owns this organization
   * .note
   *   - the account creating the org becomes the management account
   *   - 1:1 relationship (each account can only manage one org)
   *   - AWS API still uses legacy name "MasterAccountId" but docs call it "management account"
   */
  managementAccount: RefByUnique<typeof DeclaredAwsOrganizationAccount>;
}

export class DeclaredAwsOrganization
  extends DomainEntity<DeclaredAwsOrganization>
  implements DeclaredAwsOrganization
{
  /**
   * .what = primary key - the organization ID (assigned by AWS)
   */
  public static primary = ['id'] as const;

  /**
   * .what = unique constraint - management account (1:1 with org)
   * .note = each account can only be management account of one org
   */
  public static unique = ['managementAccount'] as const;

  /**
   * .what = metadata fields assigned by AWS
   */
  public static metadata = ['id', 'arn'] as const;

  /**
   * .what = nested domain object definitions
   */
  public static nested = {
    managementAccount: RefByUnique<typeof DeclaredAwsOrganizationAccount>,
  };
}
```

### 2.2 DeclaredAwsOrganizationAccount

**File:** `src/domain.objects/DeclaredAwsOrganizationAccount.ts`

```typescript
import type { UniDateTime } from '@ehmpathy/uni-time';
import { DomainEntity, DomainLiteral, RefByPrimary } from 'domain-objects';

import type { DeclaredAwsOrganization } from './DeclaredAwsOrganization';

/**
 * .what = the state of an account in the organization lifecycle
 * .ref = https://docs.aws.amazon.com/organizations/latest/APIReference/API_Account.html
 */
export type OrganizationAccountState =
  | 'PENDING_ACTIVATION'
  | 'ACTIVE'
  | 'SUSPENDED'
  | 'PENDING_CLOSURE'
  | 'CLOSED';

/**
 * .what = method by which the account joined the organization
 */
export type OrganizationAccountJoinedMethod = 'CREATED' | 'INVITED';

/**
 * .what = whether IAM users in the account can access billing
 */
export type IamUserAccessToBilling = 'ALLOW' | 'DENY';

/**
 * .what = a declarative structure representing an AWS Organization member account
 * .why = enables declarative provisioning of AWS accounts via declastruct
 * .ref = https://docs.aws.amazon.com/organizations/latest/APIReference/API_Account.html
 */
export interface DeclaredAwsOrganizationAccount {
  /**
   * .what = the unique identifier (ID) of the account
   * .note = is @metadata -> assigned by AWS on creation
   * .constraint = exactly 12 digits
   */
  id?: string;

  /**
   * .what = the Amazon Resource Name (ARN) of the account
   * .note = is @metadata -> assigned by AWS on creation
   */
  arn?: string;

  /**
   * .what = the organization this account belongs to
   * .note = is @readonly -> derived from AWS, parsed from ARN
   */
  organization?: RefByPrimary<typeof DeclaredAwsOrganization>;

  /**
   * .what = the friendly name of the account
   * .constraint = 1-50 chars, printable ASCII
   */
  name: string;

  /**
   * .what = the email address associated with the account
   * .constraint = 6-64 chars, unique across all AWS
   * .note = this is the unique identifier from user perspective
   */
  email: string;

  /**
   * .what = the current state of the account in its lifecycle
   * .note = is @readonly -> derived from AWS source of truth
   */
  state?: OrganizationAccountState;

  /**
   * .what = method by which the account joined the organization
   * .note = is @readonly -> derived from AWS source of truth
   */
  joinedMethod?: OrganizationAccountJoinedMethod;

  /**
   * .what = when the account joined the organization
   * .note = is @readonly -> derived from AWS source of truth
   */
  joinedAt?: UniDateTime;

  /**
   * .what = whether IAM users can access billing information
   * .default = 'ALLOW'
   * .why = cost awareness is important; anyone using AWS resources should be cognizant of costs
   */
  iamUserAccessToBilling?: IamUserAccessToBilling;

  /**
   * .what = the name of the cross-account access role
   * .default = 'OrganizationAccountAccessRole'
   * .note = only settable at creation time
   */
  roleName?: string;

  /**
   * .what = tags to apply to the account
   */
  tags?: Record<string, string>;
}

export class DeclaredAwsOrganizationAccount
  extends DomainEntity<DeclaredAwsOrganizationAccount>
  implements DeclaredAwsOrganizationAccount
{
  /**
   * .what = primary key assigned by AWS
   * .note = id is the 12-digit account number
   */
  public static primary = ['id'] as const;

  /**
   * .what = unique constraint for user-specified identity
   * .note = email is globally unique across all AWS accounts
   */
  public static unique = ['email'] as const;

  /**
   * .what = identity attributes assigned by the persistence layer
   * .note = these are assigned by AWS on account creation
   */
  public static metadata = ['id', 'arn'] as const;

  /**
   * .what = intrinsic attributes resolved from AWS, not user-settable
   * .note = these reflect the current state of the account
   */
  public static readonly = ['organization', 'state', 'joinedMethod', 'joinedAt'] as const;

  /**
   * .what = nested domain object definitions
   */
  public static nested = {
    organization: RefByPrimary<typeof DeclaredAwsOrganization>,
    tags: DomainLiteral,
  };
}
```

### 2.3 DeclaredAwsOrganizationAccountCreationStatus

**File:** `src/domain.objects/DeclaredAwsOrganizationAccountCreationStatus.ts`

```typescript
import type { UniDateTime } from '@ehmpathy/uni-time';
import { DomainEntity, RefByPrimary } from 'domain-objects';

import type { DeclaredAwsOrganizationAccount } from './DeclaredAwsOrganizationAccount';

/**
 * .what = the state of an account creation request
 */
export type AccountCreationState = 'IN_PROGRESS' | 'SUCCEEDED' | 'FAILED';

/**
 * .what = reason for account creation failure
 * .ref = https://docs.aws.amazon.com/organizations/latest/APIReference/API_CreateAccountStatus.html
 */
export type AccountCreationFailureReason =
  | 'ACCOUNT_LIMIT_EXCEEDED'
  | 'EMAIL_ALREADY_EXISTS'
  | 'INVALID_ADDRESS'
  | 'INVALID_EMAIL'
  | 'CONCURRENT_ACCOUNT_MODIFICATION'
  | 'INTERNAL_FAILURE'
  | 'GOVCLOUD_ACCOUNT_ALREADY_EXISTS'
  | 'MISSING_BUSINESS_VALIDATION'
  | 'FAILED_BUSINESS_VALIDATION'
  | 'PENDING_BUSINESS_VALIDATION'
  | 'INVALID_IDENTITY_FOR_BUSINESS_VALIDATION'
  | 'UNKNOWN_BUSINESS_VALIDATION'
  | 'MISSING_PAYMENT_INSTRUMENT'
  | 'INVALID_PAYMENT_INSTRUMENT'
  | 'UPDATE_EXISTING_RESOURCE_POLICY_WITH_TAGS_NOT_SUPPORTED';

/**
 * .what = tracks the status of an async account creation request
 * .why = CreateAccount is async; this tracks the request lifecycle
 * .ref = https://docs.aws.amazon.com/organizations/latest/APIReference/API_CreateAccountStatus.html
 */
export interface DeclaredAwsOrganizationAccountCreationStatus {
  /**
   * .what = the unique request ID
   * .constraint = pattern: car-[a-z0-9]{8,32}
   */
  requestId: string;

  /**
   * .what = reference to the created account (if successful)
   */
  account?: RefByPrimary<typeof DeclaredAwsOrganizationAccount>;

  /**
   * .what = the name given to the account at creation
   */
  accountName: string;

  /**
   * .what = current state of the creation request
   */
  state: AccountCreationState;

  /**
   * .what = reason for failure (if state is FAILED)
   */
  failureReason?: AccountCreationFailureReason;

  /**
   * .what = when the request was made
   */
  requestedAt: UniDateTime;

  /**
   * .what = when the request completed (success or failure)
   */
  completedAt?: UniDateTime;
}

export class DeclaredAwsOrganizationAccountCreationStatus
  extends DomainEntity<DeclaredAwsOrganizationAccountCreationStatus>
  implements DeclaredAwsOrganizationAccountCreationStatus
{
  public static primary = ['requestId'] as const;
  public static unique = ['requestId'] as const;

  public static metadata = [] as const;
  public static readonly = [
    'state',
    'failureReason',
    'requestedAt',
    'completedAt',
  ] as const;

  public static nested = {
    account: RefByPrimary<typeof DeclaredAwsOrganizationAccount>,
  };
}
```

### 2.4 DeclaredAwsOrganizationalUnit (Future Extension)

For completeness in organizing accounts:

```typescript
/**
 * .what = a container for accounts within an organization
 * .note = out of scope for initial account provisioning wish
 */
export interface DeclaredAwsOrganizationalUnit {
  id?: string;   // ou-xxxx-xxxxxxxx
  arn?: string;
  name: string;
  parentId: string; // root or parent OU
}
```

---

## 3. Domain Operations

### 3.1 getOneOrganization

**File:** `src/domain.operations/organization/getOneOrganization.ts`

```typescript
import { asProcedure } from 'as-procedure';
import {
  OrganizationsClient,
  DescribeOrganizationCommand,
} from '@aws-sdk/client-organizations';
import type { HasReadonly } from 'domain-objects';
import { HelpfulError } from 'helpful-errors';
import type { VisualogicContext } from 'visualogic';

import type { ContextAwsApi } from '../../domain.objects/ContextAwsApi';
import type { DeclaredAwsOrganization } from '../../domain.objects/DeclaredAwsOrganization';
import { castIntoDeclaredAwsOrganization } from './castIntoDeclaredAwsOrganization';

/**
 * .what = retrieves the organization for the current credentials
 * .note
 *   - there is only one organization per management account
 *   - returns null if caller is not in an organization
 */
export const getOneOrganization = asProcedure(
  async (
    _input: Record<string, never>,
    context: ContextAwsApi & VisualogicContext,
  ): Promise<HasReadonly<typeof DeclaredAwsOrganization> | null> => {
    const client = new OrganizationsClient({ region: 'us-east-1' });

    try {
      const response = await client.send(new DescribeOrganizationCommand({}));
      if (!response.Organization) return null;
      return castIntoDeclaredAwsOrganization(response.Organization);
    } catch (error) {
      if (error.name === 'AWSOrganizationsNotInUseException') return null;
      throw new HelpfulError('aws.getOneOrganization error', { cause: error });
    }
  },
);
```

### 3.2 setOrganization

**File:** `src/domain.operations/organization/setOrganization.ts`

```typescript
import { asProcedure } from 'as-procedure';
import {
  OrganizationsClient,
  CreateOrganizationCommand,
} from '@aws-sdk/client-organizations';
import type { HasReadonly } from 'domain-objects';
import { HelpfulError } from 'helpful-errors';
import type { PickOne } from 'type-fns';
import type { VisualogicContext } from 'visualogic';

import type { ContextAwsApi } from '../../domain.objects/ContextAwsApi';
import type { DeclaredAwsOrganization } from '../../domain.objects/DeclaredAwsOrganization';
import { getOneOrganization } from './getOneOrganization';
import { castIntoDeclaredAwsOrganization } from './castIntoDeclaredAwsOrganization';

/**
 * .what = creates an organization (findsert only)
 * .note
 *   - can only have one organization per management account
 *   - findsert returns existing if already exists (idempotent)
 */
export const setOrganization = asProcedure(
  async (
    input: PickOne<{
      findsert: Pick<DeclaredAwsOrganization, 'featureSet'>;
      // Note: upsert not supported - organizations cannot be updated
    }>,
    context: ContextAwsApi & VisualogicContext,
  ): Promise<HasReadonly<typeof DeclaredAwsOrganization>> => {
    const client = new OrganizationsClient({ region: 'us-east-1' });

    // Check if already exists (idempotent findsert)
    const existing = await getOneOrganization({}, context);
    if (existing) return existing;

    try {
      const response = await client.send(
        new CreateOrganizationCommand({
          FeatureSet: input.findsert?.featureSet ?? 'ALL',
        }),
      );
      if (!response.Organization) {
        throw new HelpfulError('CreateOrganization did not return organization');
      }
      return castIntoDeclaredAwsOrganization(response.Organization);
    } catch (error) {
      // Idempotent: already exists
      if (error.name === 'AlreadyInOrganizationException') {
        const org = await getOneOrganization({}, context);
        if (org) return org;
      }
      throw new HelpfulError('aws.setOrganization error', { cause: error });
    }
  },
);
```

### 3.3 delOrganization

**File:** `src/domain.operations/organization/delOrganization.ts`

```typescript
import { asProcedure } from 'as-procedure';
import {
  OrganizationsClient,
  DeleteOrganizationCommand,
} from '@aws-sdk/client-organizations';
import { HelpfulError } from 'helpful-errors';
import type { VisualogicContext } from 'visualogic';

import type { ContextAwsApi } from '../../domain.objects/ContextAwsApi';
import { getOneOrganization } from './getOneOrganization';

/**
 * .what = deletes the organization
 * .note
 *   - can only delete if all member accounts have been removed
 *   - idempotent: returns success if already deleted
 */
export const delOrganization = asProcedure(
  async (
    _input: Record<string, never>,
    context: ContextAwsApi & VisualogicContext,
  ): Promise<{ deleted: true }> => {
    const client = new OrganizationsClient({ region: 'us-east-1' });

    // Check if exists
    const existing = await getOneOrganization({}, context);
    if (!existing) return { deleted: true };

    try {
      await client.send(new DeleteOrganizationCommand({}));
      return { deleted: true };
    } catch (error) {
      // Idempotent: already deleted
      if (error.name === 'AWSOrganizationsNotInUseException') {
        return { deleted: true };
      }
      throw new HelpfulError('aws.delOrganization error', { cause: error });
    }
  },
);
```

### 3.4 castIntoDeclaredAwsOrganization

**File:** `src/domain.operations/organization/castIntoDeclaredAwsOrganization.ts`

```typescript
import type { Organization } from '@aws-sdk/client-organizations';
import type { HasReadonly } from 'domain-objects';
import { isPresent } from 'type-fns';

import {
  DeclaredAwsOrganization,
  type OrganizationFeatureSet,
} from '../../domain.objects/DeclaredAwsOrganization';
import { assure } from '../../utils/assure';
import { hasReadonly } from '../../utils/hasReadonly';

/**
 * .what = transforms AWS SDK Organization to DeclaredAwsOrganization
 * .note = AWS API uses legacy "MasterAccountId" but we map to "managementAccount"
 */
export const castIntoDeclaredAwsOrganization = (
  input: Organization,
): HasReadonly<typeof DeclaredAwsOrganization> => {
  return assure(
    DeclaredAwsOrganization.as({
      id: assure(input.Id, isPresent),
      arn: input.Arn,
      featureSet: input.FeatureSet as OrganizationFeatureSet,
      // AWS API returns MasterAccountId/Email; we map to managementAccount ref
      managementAccount: {
        email: assure(input.MasterAccountEmail, isPresent),
      },
    }),
    hasReadonly({ of: DeclaredAwsOrganization }),
  );
};
```

### 3.5 DeclaredAwsOrganizationDao

**File:** `src/access/daos/DeclaredAwsOrganizationDao.ts`

```typescript
import { DeclastructDao } from 'declastruct';
import { UnexpectedCodePathError } from 'helpful-errors';
import type { ContextLogTrail } from 'simple-log-methods';

import type { ContextAwsApi } from '../../domain.objects/ContextAwsApi';
import { DeclaredAwsOrganization } from '../../domain.objects/DeclaredAwsOrganization';
import { getOneOrganization } from '../../domain.operations/organization/getOneOrganization';
import { setOrganization } from '../../domain.operations/organization/setOrganization';
import { delOrganization } from '../../domain.operations/organization/delOrganization';

/**
 * .what = declastruct DAO for AWS Organization
 * .why = wraps organization operations to conform to declastruct interface
 * .note
 *   - only one organization per management account
 *   - get.byPrimary/byUnique/byRef all return the same organization (singleton)
 *   - only findsert supported (organizations cannot be updated)
 */
export const DeclaredAwsOrganizationDao = new DeclastructDao<
  DeclaredAwsOrganization,
  typeof DeclaredAwsOrganization,
  ContextAwsApi & ContextLogTrail
>({
  get: {
    byPrimary: async (_input, context) => {
      // Organizations are singletons - ignore input, return the one org
      return getOneOrganization({}, context);
    },
    byUnique: async (_input, context) => {
      // Organizations are singletons - ignore input, return the one org
      return getOneOrganization({}, context);
    },
    byRef: async (_input, context) => {
      // Organizations are singletons - ignore input, return the one org
      return getOneOrganization({}, context);
    },
  },
  set: {
    findsert: async (input, context) => {
      return setOrganization({ findsert: { featureSet: input.featureSet } }, context);
    },
    // Note: upsert not supported - organizations cannot be updated after creation
    delete: async (_input, context) => {
      await delOrganization({}, context);
    },
  },
});
```

---

### 3.6 getOneOrganizationAccount

**File:** `src/domain.operations/organizationAccount/getOneOrganizationAccount.ts`

```typescript
import { asProcedure } from 'as-procedure';
import {
  OrganizationsClient,
  DescribeAccountCommand,
  ListAccountsCommand,
} from '@aws-sdk/client-organizations';
import type { HasReadonly, Ref, RefByPrimary, RefByUnique } from 'domain-objects';
import { isRefByPrimary, isRefByUnique } from 'domain-objects';
import { HelpfulError } from 'helpful-errors';
import type { PickOne } from 'type-fns';
import type { VisualogicContext } from 'visualogic';

import type { ContextAwsApi } from '../../domain.objects/ContextAwsApi';
import type { DeclaredAwsOrganizationAccount } from '../../domain.objects/DeclaredAwsOrganizationAccount';
import { castIntoDeclaredAwsOrganizationAccount } from './castIntoDeclaredAwsOrganizationAccount';

/**
 * .what = retrieves a single organization account
 * .how = by primary (id) or unique (email)
 * .note = returns null if not found (idempotent)
 */
export const getOneOrganizationAccount = asProcedure(
  async (
    input: {
      by: PickOne<{
        primary: RefByPrimary<typeof DeclaredAwsOrganizationAccount>;
        unique: RefByUnique<typeof DeclaredAwsOrganizationAccount>;
        ref: Ref<typeof DeclaredAwsOrganizationAccount>;
      }>;
    },
    context: ContextAwsApi & VisualogicContext,
  ): Promise<HasReadonly<typeof DeclaredAwsOrganizationAccount> | null> => {
    // Handle ref dispatch
    if (input.by.ref) {
      if (isRefByUnique({ of: DeclaredAwsOrganizationAccount })(input.by.ref))
        return getOneOrganizationAccount({ by: { unique: input.by.ref } }, context);
      if (isRefByPrimary({ of: DeclaredAwsOrganizationAccount })(input.by.ref))
        return getOneOrganizationAccount({ by: { primary: input.by.ref } }, context);
    }

    const client = new OrganizationsClient({ region: 'us-east-1' }); // Organizations API is global

    // By primary (id) - use DescribeAccount
    if (input.by.primary) {
      try {
        const response = await client.send(
          new DescribeAccountCommand({ AccountId: input.by.primary.id }),
        );
        if (!response.Account) return null;
        return castIntoDeclaredAwsOrganizationAccount(response.Account);
      } catch (error) {
        if (error.name === 'AccountNotFoundException') return null;
        throw new HelpfulError('aws.getOneOrganizationAccount error', { cause: error });
      }
    }

    // By unique (email) - must iterate ListAccounts
    if (input.by.unique) {
      let nextToken: string | undefined;
      do {
        const response = await client.send(
          new ListAccountsCommand({ NextToken: nextToken }),
        );
        const found = response.Accounts?.find(
          (acc) => acc.Email === input.by.unique!.email,
        );
        if (found) return castIntoDeclaredAwsOrganizationAccount(found);
        nextToken = response.NextToken;
      } while (nextToken);
      return null;
    }

    return null;
  },
);
```

### 3.7 getAllOrganizationAccounts

**File:** `src/domain.operations/organizationAccount/getAllOrganizationAccounts.ts`

```typescript
import { asProcedure } from 'as-procedure';
import {
  OrganizationsClient,
  ListAccountsCommand,
} from '@aws-sdk/client-organizations';
import type { HasReadonly } from 'domain-objects';
import { HelpfulError } from 'helpful-errors';
import type { VisualogicContext } from 'visualogic';

import type { ContextAwsApi } from '../../domain.objects/ContextAwsApi';
import type { DeclaredAwsOrganizationAccount } from '../../domain.objects/DeclaredAwsOrganizationAccount';
import { castIntoDeclaredAwsOrganizationAccount } from './castIntoDeclaredAwsOrganizationAccount';

/**
 * .what = lists all accounts in the organization
 * .note = handles pagination automatically
 */
export const getAllOrganizationAccounts = asProcedure(
  async (
    input: {
      page?: {
        limit?: number;
        nextToken?: string;
      };
    },
    context: ContextAwsApi & VisualogicContext,
  ): Promise<{
    accounts: HasReadonly<typeof DeclaredAwsOrganizationAccount>[];
    nextToken?: string;
  }> => {
    const client = new OrganizationsClient({ region: 'us-east-1' });

    try {
      const response = await client.send(
        new ListAccountsCommand({
          MaxResults: input.page?.limit ?? 20,
          NextToken: input.page?.nextToken,
        }),
      );

      const accounts = (response.Accounts ?? []).map(
        castIntoDeclaredAwsOrganizationAccount,
      );

      return {
        accounts,
        nextToken: response.NextToken,
      };
    } catch (error) {
      throw new HelpfulError('aws.getAllOrganizationAccounts error', { cause: error });
    }
  },
);
```

### 3.8 setOrganizationAccount

**File:** `src/domain.operations/organizationAccount/setOrganizationAccount.ts`

```typescript
import { asProcedure } from 'as-procedure';
import {
  OrganizationsClient,
  CreateAccountCommand,
  DescribeCreateAccountStatusCommand,
} from '@aws-sdk/client-organizations';
import type { HasReadonly } from 'domain-objects';
import { BadRequestError, HelpfulError } from 'helpful-errors';
import type { PickOne } from 'type-fns';
import type { VisualogicContext } from 'visualogic';
import { sleep } from 'simple-sleep';

import type { ContextAwsApi } from '../../domain.objects/ContextAwsApi';
import type { DeclaredAwsOrganizationAccount } from '../../domain.objects/DeclaredAwsOrganizationAccount';
import { getOneOrganizationAccount } from './getOneOrganizationAccount';
import { castIntoDeclaredAwsOrganizationAccount } from './castIntoDeclaredAwsOrganizationAccount';

/**
 * .what = creates an organization account (findsert only)
 * .why = accounts cannot be updated after creation, only created
 * .note
 *   - CreateAccount is async; this polls until completion
 *   - findsert returns existing account if email already exists (idempotent)
 */
export const setOrganizationAccount = asProcedure(
  async (
    input: PickOne<{
      findsert: DeclaredAwsOrganizationAccount;
      // Note: upsert not supported - accounts cannot be updated
    }>,
    context: ContextAwsApi & VisualogicContext,
  ): Promise<HasReadonly<typeof DeclaredAwsOrganizationAccount>> => {
    const accountDesired = input.findsert;
    if (!accountDesired) {
      throw new BadRequestError('findsert is required (accounts cannot be updated)');
    }

    const client = new OrganizationsClient({ region: 'us-east-1' });

    // Check if already exists (idempotent findsert)
    const existing = await getOneOrganizationAccount(
      { by: { unique: { email: accountDesired.email } } },
      context,
    );
    if (existing) return existing;

    // Create account (async)
    const createResponse = await client.send(
      new CreateAccountCommand({
        AccountName: accountDesired.name,
        Email: accountDesired.email,
        IamUserAccessToBilling: accountDesired.iamUserAccessToBilling ?? 'ALLOW',
        RoleName: accountDesired.roleName ?? 'OrganizationAccountAccessRole',
        Tags: accountDesired.tags
          ? Object.entries(accountDesired.tags).map(([Key, Value]) => ({ Key, Value }))
          : undefined,
      }),
    );

    const requestId = createResponse.CreateAccountStatus?.Id;
    if (!requestId) {
      throw new HelpfulError('CreateAccount did not return a request ID', {
        createResponse,
      });
    }

    // Poll until completion
    let status = createResponse.CreateAccountStatus;
    while (status?.State === 'IN_PROGRESS') {
      await sleep(2000); // Wait 2 seconds between polls
      const statusResponse = await client.send(
        new DescribeCreateAccountStatusCommand({
          CreateAccountRequestId: requestId,
        }),
      );
      status = statusResponse.CreateAccountStatus;
    }

    // Handle failure
    if (status?.State === 'FAILED') {
      throw new HelpfulError('Account creation failed', {
        failureReason: status.FailureReason,
        accountName: accountDesired.name,
        email: accountDesired.email,
      });
    }

    // Fetch the created account
    if (!status?.AccountId) {
      throw new HelpfulError('Account creation succeeded but no AccountId returned', {
        status,
      });
    }

    const created = await getOneOrganizationAccount(
      { by: { primary: { id: status.AccountId } } },
      context,
    );

    if (!created) {
      throw new HelpfulError('Account creation succeeded but account not found', {
        accountId: status.AccountId,
      });
    }

    return created;
  },
);
```

### 3.9 delOrganizationAccount

**File:** `src/domain.operations/organizationAccount/delOrganizationAccount.ts`

```typescript
import { asProcedure } from 'as-procedure';
import {
  OrganizationsClient,
  CloseAccountCommand,
} from '@aws-sdk/client-organizations';
import type { Ref, RefByPrimary, RefByUnique } from 'domain-objects';
import { isRefByPrimary, isRefByUnique } from 'domain-objects';
import { BadRequestError, HelpfulError } from 'helpful-errors';
import type { PickOne } from 'type-fns';
import type { VisualogicContext } from 'visualogic';

import type { ContextAwsApi } from '../../domain.objects/ContextAwsApi';
import type { DeclaredAwsOrganizationAccount } from '../../domain.objects/DeclaredAwsOrganizationAccount';
import { getOneOrganizationAccount } from './getOneOrganizationAccount';

/**
 * .what = closes an organization account
 * .why = accounts cannot be deleted, only closed (transitions to SUSPENDED)
 * .note
 *   - async operation
 *   - idempotent: already closed accounts return success
 *   - 90-day grace period for reinstatement
 */
export const delOrganizationAccount = asProcedure(
  async (
    input: {
      by: PickOne<{
        primary: RefByPrimary<typeof DeclaredAwsOrganizationAccount>;
        unique: RefByUnique<typeof DeclaredAwsOrganizationAccount>;
        ref: Ref<typeof DeclaredAwsOrganizationAccount>;
      }>;
    },
    context: ContextAwsApi & VisualogicContext,
  ): Promise<{ closed: true }> => {
    // Resolve ref
    const by = (() => {
      if (input.by.primary) return { primary: input.by.primary };
      if (input.by.unique) return { unique: input.by.unique };
      if (input.by.ref) {
        if (isRefByUnique({ of: DeclaredAwsOrganizationAccount })(input.by.ref))
          return { unique: input.by.ref };
        if (isRefByPrimary({ of: DeclaredAwsOrganizationAccount })(input.by.ref))
          return { primary: input.by.ref };
      }
      throw new BadRequestError('Invalid ref type');
    })();

    // Get the account
    const account = await getOneOrganizationAccount({ by }, context);

    // Idempotent: not found or already closed
    if (!account) return { closed: true };
    if (account.state === 'SUSPENDED' || account.state === 'CLOSED') {
      return { closed: true };
    }
    if (account.state === 'PENDING_CLOSURE') {
      return { closed: true }; // Already in progress
    }

    // Cannot close non-active accounts
    if (account.state !== 'ACTIVE') {
      throw new BadRequestError('Can only close ACTIVE accounts', {
        currentState: account.state,
      });
    }

    const client = new OrganizationsClient({ region: 'us-east-1' });

    try {
      await client.send(
        new CloseAccountCommand({ AccountId: account.id }),
      );
      return { closed: true };
    } catch (error) {
      // Idempotent: already closed
      if (error.name === 'AccountAlreadyClosedException') {
        return { closed: true };
      }
      throw new HelpfulError('aws.delOrganizationAccount error', { cause: error });
    }
  },
);
```

### 3.10 castIntoDeclaredAwsOrganizationAccount

**File:** `src/domain.operations/organizationAccount/castIntoDeclaredAwsOrganizationAccount.ts`

```typescript
import type { Account } from '@aws-sdk/client-organizations';
import { isUniDateTime } from '@ehmpathy/uni-time';
import type { HasReadonly, RefByUnique } from 'domain-objects';
import { isPresent } from 'type-fns';

import type { DeclaredAwsOrganization } from '../../domain.objects/DeclaredAwsOrganization';
import {
  DeclaredAwsOrganizationAccount,
  type OrganizationAccountState,
  type OrganizationAccountJoinedMethod,
} from '../../domain.objects/DeclaredAwsOrganizationAccount';
import { assure } from '../../utils/assure';
import { hasReadonly } from '../../utils/hasReadonly';

/**
 * .what = transforms AWS SDK Account to DeclaredAwsOrganizationAccount
 */
export const castIntoDeclaredAwsOrganizationAccount = (input: {
  account: Account;
  organization: RefByUnique<typeof DeclaredAwsOrganization>;
}): HasReadonly<typeof DeclaredAwsOrganizationAccount> => {
  return assure(
    DeclaredAwsOrganizationAccount.as({
      id: assure(input.account.Id, isPresent),
      arn: assure(input.account.Arn, isPresent),
      name: assure(input.account.Name, isPresent),
      email: assure(input.account.Email, isPresent),
      organization: input.organization,
      state: (input.account.State ?? input.account.Status) as OrganizationAccountState,
      joinedMethod: input.account.JoinedMethod as OrganizationAccountJoinedMethod,
      joinedAt: input.account.JoinedTimestamp
        ? isUniDateTime.assure(input.account.JoinedTimestamp.toISOString())
        : undefined,
      // Note: iamUserAccessToBilling and roleName are write-only (not returned by API)
      // Note: tags require separate ListTagsForResource call (future enhancement)
    }),
    hasReadonly({ of: DeclaredAwsOrganizationAccount }),
  );
};
```

---

## 4. Access DAOs

### 4.1 DeclaredAwsOrganizationAccountDao

**File:** `src/access/daos/DeclaredAwsOrganizationAccountDao.ts`

```typescript
import { DeclastructDao } from 'declastruct';
import { isRefByPrimary, isRefByUnique } from 'domain-objects';
import { UnexpectedCodePathError } from 'helpful-errors';
import type { ContextLogTrail } from 'simple-log-methods';

import type { ContextAwsApi } from '../../domain.objects/ContextAwsApi';
import { DeclaredAwsOrganizationAccount } from '../../domain.objects/DeclaredAwsOrganizationAccount';
import { getOneOrganizationAccount } from '../../domain.operations/organizationAccount/getOneOrganizationAccount';
import { setOrganizationAccount } from '../../domain.operations/organizationAccount/setOrganizationAccount';
import { delOrganizationAccount } from '../../domain.operations/organizationAccount/delOrganizationAccount';

/**
 * .what = declastruct DAO for AWS Organization Account resources
 * .why = wraps account operations to conform to declastruct interface
 * .note
 *   - only findsert supported (accounts cannot be updated)
 *   - delete = close (transitions to SUSPENDED)
 */
export const DeclaredAwsOrganizationAccountDao = new DeclastructDao<
  DeclaredAwsOrganizationAccount,
  typeof DeclaredAwsOrganizationAccount,
  ContextAwsApi & ContextLogTrail
>({
  get: {
    byPrimary: async (input, context) => {
      return getOneOrganizationAccount({ by: { primary: input } }, context);
    },
    byUnique: async (input, context) => {
      return getOneOrganizationAccount({ by: { unique: input } }, context);
    },
    byRef: async (input, context) => {
      if (isRefByUnique({ of: DeclaredAwsOrganizationAccount })(input))
        return getOneOrganizationAccount({ by: { unique: input } }, context);
      if (isRefByPrimary({ of: DeclaredAwsOrganizationAccount })(input))
        return getOneOrganizationAccount({ by: { primary: input } }, context);
      UnexpectedCodePathError.throw('unsupported ref type', { input });
    },
  },
  set: {
    findsert: async (input, context) => {
      return setOrganizationAccount({ findsert: input }, context);
    },
    // Note: upsert not supported - accounts cannot be updated after creation
    delete: async (input, context) => {
      await delOrganizationAccount({ by: { ref: input } }, context);
    },
  },
});
```

---

## 5. File Structure Summary

```
src/
├── domain.objects/
│   ├── DeclaredAwsOrganization.ts
│   ├── DeclaredAwsOrganizationAccount.ts
│   └── DeclaredAwsOrganizationAccountCreationStatus.ts
│
├── domain.operations/
│   ├── organization/
│   │   ├── getOneOrganization.ts
│   │   ├── setOrganization.ts
│   │   ├── delOrganization.ts
│   │   └── castIntoDeclaredAwsOrganization.ts
│   │
│   └── organizationAccount/
│       ├── getOneOrganizationAccount.ts
│       ├── getAllOrganizationAccounts.ts
│       ├── setOrganizationAccount.ts
│       ├── delOrganizationAccount.ts
│       └── castIntoDeclaredAwsOrganizationAccount.ts
│
└── access/daos/
    ├── DeclaredAwsOrganizationDao.ts
    └── DeclaredAwsOrganizationAccountDao.ts
```

---

## 6. Key Design Decisions

### 6.1 Primary vs Unique Keys
- **Primary:** `id` (12-digit AWS account number, assigned by AWS)
- **Unique:** `email` (globally unique across all AWS, user-specified)

### 6.2 findsert Only (No Upsert)
AWS accounts cannot be updated after creation. The `setOrganizationAccount` operation only supports `findsert`:
- If account with email exists: return existing (idempotent)
- If not: create new account

### 6.3 Delete = Close
AWS accounts cannot be truly deleted. `delOrganizationAccount` calls `CloseAccount` which:
- Transitions account to `PENDING_CLOSURE` then `SUSPENDED`
- 90-day grace period for reinstatement via AWS Support
- After 90 days, transitions to `CLOSED`

### 6.4 Async Operations
`CreateAccount` is async. The `setOrganizationAccount` operation:
1. Calls `CreateAccount` (returns immediately)
2. Polls `DescribeCreateAccountStatus` until `SUCCEEDED` or `FAILED`
3. Fetches and returns the created account

### 6.5 Region Consideration
AWS Organizations API is global - always use `us-east-1` region for the client.

---

## 7. Usage Example

**File:** `resources.provision.ts`

```typescript
import { RefByUnique } from 'domain-objects';
import {
  DeclaredAwsOrganization,
  DeclaredAwsOrganizationAccount,
  getDeclastructAwsProvider,
} from 'declastruct-aws';

/**
 * .what = provider configuration for AWS
 * .why = enables declastruct CLI to interact with AWS Organizations API
 * .note = requires AWS credentials with organizations:* permissions on management account
 */
export const getProviders = async () => [
  await getDeclastructAwsProvider(
    {},
    {
      log: {
        info: () => {},
        debug: () => {},
        warn: console.warn,
        error: console.error,
      },
    },
  ),
];

/**
 * .what = resource declarations for ehmpathy CI/CD account
 * .why = defines desired state for declastruct to apply
 */
export const getResources = async () => {
  // declare the management account
  const managementAccount = DeclaredAwsOrganizationAccount.as({
    name: 'ehmpathy-management',
    email: 'management@ehmpathy.com',
  });

  // declare the organization
  const organization = DeclaredAwsOrganization.as({
    featureSet: 'ALL',
    managementAccount: RefByUnique.as<typeof DeclaredAwsOrganizationAccount>(managementAccount),
  });

  // declare the CI/CD account
  const cicdAccount = DeclaredAwsOrganizationAccount.as({
    name: 'ehmpathy-cicd-public',
    email: 'ehmpathy-cicd-public@ehmpathy.com',
    organization: RefByUnique.as<typeof DeclaredAwsOrganization>(organization),
    // iamUserAccessToBilling defaults to 'ALLOW' - cost awareness is important
    tags: {
      purpose: 'cicd',
      repo: 'declastruct-aws',
      managedBy: 'declastruct',
    },
  });

  return [
    managementAccount,
    organization,
    cicdAccount,
  ];
};
```

**Apply with declastruct CLI:**
```bash
npx declastruct apply --resources ./resources.provision.ts
```
