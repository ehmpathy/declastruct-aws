# Roadmap: AWS Account Provisioning Implementation

## References
- Blueprint: `3.3.blueprint.v1.i1.md`
- Research: `3.1.research.domain._.v1.i1.md`
- Distillation: `3.2.distill.domain._.v1.i1.md`

---

## Checklist

### Step 0: Dependencies
- [ ] **0.1** Install `@aws-sdk/client-organizations`
  - **depends on:** nothing
  - **acceptance:** `pnpm install @aws-sdk/client-organizations` succeeds
  - **verify:** `pnpm list @aws-sdk/client-organizations` shows version installed

---

### Step 1: Domain Objects

- [ ] **1.1** Create `DeclaredAwsOrganization`
  - **depends on:** 0.1
  - **file:** `src/domain.objects/DeclaredAwsOrganization.ts`
  - **acceptance:**
    - Exports `OrganizationFeatureSet` type
    - Exports `DeclaredAwsOrganization` interface with `id?`, `arn?`, `featureSet`, `managementAccount`
    - Exports `DeclaredAwsOrganization` class with `primary`, `unique`, `metadata`, `nested`
  - **verify:** `npx tsc --noEmit` passes; can import and instantiate with `.as()`

- [ ] **1.2** Create `DeclaredAwsOrganizationAccount`
  - **depends on:** 0.1
  - **file:** `src/domain.objects/DeclaredAwsOrganizationAccount.ts`
  - **acceptance:**
    - Exports `OrganizationAccountState`, `OrganizationAccountJoinedMethod`, `IamUserAccessToBilling` types
    - Exports `DeclaredAwsOrganizationAccount` interface with all fields from distillation
    - Exports class with `primary`, `unique`, `metadata`, `readonly`, `nested`
  - **verify:** `npx tsc --noEmit` passes; can import and instantiate with `.as()`

---

### Step 2: Cast Functions

- [ ] **2.1** Create `castIntoDeclaredAwsOrganization`
  - **depends on:** 1.1
  - **file:** `src/domain.operations/organization/castIntoDeclaredAwsOrganization.ts`
  - **acceptance:**
    - Takes AWS SDK `Organization` as input
    - Returns `HasReadonly<typeof DeclaredAwsOrganization>`
    - Uses `assure(x, isPresent)` pattern
    - Maps `MasterAccountEmail` → `managementAccount.email`
  - **verify:** Unit test passes: `castIntoDeclaredAwsOrganization.test.ts`

- [ ] **2.2** Create `castIntoDeclaredAwsOrganizationAccount`
  - **depends on:** 1.1, 1.2
  - **file:** `src/domain.operations/organizationAccount/castIntoDeclaredAwsOrganizationAccount.ts`
  - **acceptance:**
    - Takes `{ account: Account; organization: RefByUnique<typeof DeclaredAwsOrganization> }` as input
    - Returns `HasReadonly<typeof DeclaredAwsOrganizationAccount>`
    - Uses `assure(x, isPresent)` pattern
    - Maps `JoinedTimestamp` → `isUniDateTime.assure()`
  - **verify:** Unit test passes: `castIntoDeclaredAwsOrganizationAccount.test.ts`

---

### Step 3: Organization Get Operations

- [ ] **3.1** Create `getOneOrganization`
  - **depends on:** 2.1
  - **file:** `src/domain.operations/organization/getOneOrganization.ts`
  - **acceptance:**
    - Uses `DescribeOrganizationCommand`
    - Returns `null` when `AWSOrganizationsNotInUseException`
    - Uses region `us-east-1`
  - **verify:** Unit test passes: `getOneOrganization.test.ts`

---

### Step 4: Organization Account Get Operations

- [ ] **4.1** Create `getOneOrganizationAccount`
  - **depends on:** 2.2, 3.1
  - **file:** `src/domain.operations/organizationAccount/getOneOrganizationAccount.ts`
  - **acceptance:**
    - By primary (id): uses `DescribeAccountCommand`
    - By unique (email): iterates `ListAccountsCommand`
    - Returns `null` when `AccountNotFoundException`
    - Calls `getOneOrganization` to get organization ref for cast
  - **verify:** Unit test passes: `getOneOrganizationAccount.test.ts`

- [ ] **4.2** Create `getAllOrganizationAccounts`
  - **depends on:** 2.2, 3.1
  - **file:** `src/domain.operations/organizationAccount/getAllOrganizationAccounts.ts`
  - **acceptance:**
    - Uses `ListAccountsCommand` with pagination
    - Calls `getOneOrganization` to get organization ref
    - Maps each account with `castIntoDeclaredAwsOrganizationAccount`
  - **verify:** Unit test passes: `getAllOrganizationAccounts.test.ts`

---

### Step 5: Organization Set/Del Operations

- [ ] **5.1** Create `setOrganization`
  - **depends on:** 3.1
  - **file:** `src/domain.operations/organization/setOrganization.ts`
  - **acceptance:**
    - Supports `findsert` only (no upsert)
    - Uses `CreateOrganizationCommand`
    - Returns existing org when `AlreadyInOrganizationException` (idempotent)
  - **verify:** Unit test passes: `setOrganization.test.ts`

- [ ] **5.2** Create `delOrganization`
  - **depends on:** 3.1
  - **file:** `src/domain.operations/organization/delOrganization.ts`
  - **acceptance:**
    - Uses `DeleteOrganizationCommand`
    - Returns success when `AWSOrganizationsNotInUseException` (idempotent)
  - **verify:** Unit test passes: `delOrganization.test.ts`

---

### Step 6: Organization Account Set/Del Operations

- [ ] **6.1** Create `setOrganizationAccount`
  - **depends on:** 4.1
  - **file:** `src/domain.operations/organizationAccount/setOrganizationAccount.ts`
  - **acceptance:**
    - Supports `findsert` only (no upsert)
    - Uses `CreateAccountCommand` (async)
    - Polls `DescribeCreateAccountStatusCommand` until SUCCEEDED/FAILED
    - Defaults `iamUserAccessToBilling: 'ALLOW'`
    - Defaults `roleName: 'OrganizationAccountAccessRole'`
    - Returns existing account if email already exists (idempotent)
  - **verify:** Unit test passes: `setOrganizationAccount.test.ts`

- [ ] **6.2** Create `delOrganizationAccount`
  - **depends on:** 4.1
  - **file:** `src/domain.operations/organizationAccount/delOrganizationAccount.ts`
  - **acceptance:**
    - Uses `CloseAccountCommand`
    - Returns success for already closed states (SUSPENDED, CLOSED, PENDING_CLOSURE)
    - Returns success when `AccountAlreadyClosedException` (idempotent)
  - **verify:** Unit test passes: `delOrganizationAccount.test.ts`

---

### Step 7: DAOs

- [ ] **7.1** Create `DeclaredAwsOrganizationDao`
  - **depends on:** 3.1, 5.1, 5.2
  - **file:** `src/access/daos/DeclaredAwsOrganizationDao.ts`
  - **acceptance:**
    - `get.byPrimary`, `get.byUnique`, `get.byRef` → call `getOneOrganization`
    - `set.findsert` → calls `setOrganization`
    - `set.delete` → calls `delOrganization`
    - No `set.upsert` (not supported)
  - **verify:** `npx tsc --noEmit` passes; DAO can be instantiated

- [ ] **7.2** Create `DeclaredAwsOrganizationAccountDao`
  - **depends on:** 4.1, 6.1, 6.2
  - **file:** `src/access/daos/DeclaredAwsOrganizationAccountDao.ts`
  - **acceptance:**
    - `get.byPrimary`, `get.byUnique`, `get.byRef` → route to `getOneOrganizationAccount`
    - `set.findsert` → calls `setOrganizationAccount`
    - `set.delete` → calls `delOrganizationAccount`
    - No `set.upsert` (not supported)
  - **verify:** `npx tsc --noEmit` passes; DAO can be instantiated

---

### Step 8: Provider Integration

- [ ] **8.1** Register DAOs with provider
  - **depends on:** 7.1, 7.2
  - **file:** `src/domain.operations/provider/getDeclastructAwsProvider.ts`
  - **acceptance:**
    - Imports `DeclaredAwsOrganizationDao` and `DeclaredAwsOrganizationAccountDao`
    - Registers both in provider's `daos` object
  - **verify:** `npx tsc --noEmit` passes; provider returns daos when called

---

### Step 9: Integration Tests

- [ ] **9.1** Integration test for organization operations
  - **depends on:** 8.1
  - **file:** `src/domain.operations/organization/getOneOrganization.integration.test.ts`
  - **acceptance:**
    - Tests against real AWS with organizations:* permissions
    - Verifies `getOneOrganization` returns valid data or null
  - **verify:** `npx jest getOneOrganization.integration.test.ts` passes (requires AWS credentials)

- [ ] **9.2** Integration test for organization account operations
  - **depends on:** 8.1
  - **file:** `src/domain.operations/organizationAccount/getOneOrganizationAccount.integration.test.ts`
  - **acceptance:**
    - Tests against real AWS with organizations:* permissions
    - Verifies `getOneOrganizationAccount` returns valid data or null
  - **verify:** `npx jest getOneOrganizationAccount.integration.test.ts` passes (requires AWS credentials)

---

### Step 10: Refactoring (Independent)

- [ ] **10.1** Replace `getOrThrow` with `assure(x, isPresent)` in castIntoDeclaredAwsLambda
  - **depends on:** nothing (can be done in parallel)
  - **file:** `src/domain.operations/lambda/castIntoDeclaredAwsLambda.ts`
  - **acceptance:**
    - Remove local `getOrThrow` helper function
    - Replace all 11 usages with `assure(input.FieldName, isPresent)`
    - Import `isPresent` from `type-fns` (assure already imported)
  - **verify:** `npx tsc --noEmit` passes; existing unit tests pass: `npx jest castIntoDeclaredAwsLambda.test.ts`

---

## Dependency Graph

```
0.1 (install sdk)
 ├── 1.1 (DeclaredAwsOrganization)
 │    └── 2.1 (castIntoOrg)
 │         └── 3.1 (getOneOrg)
 │              ├── 5.1 (setOrg)
 │              ├── 5.2 (delOrg)
 │              └── 7.1 (OrgDao) ─────────────────┐
 │                                                │
 └── 1.2 (DeclaredAwsOrganizationAccount)         │
      └── 2.2 (castIntoAccount)                   │
           ├── 4.1 (getOneAccount)                │
           │    ├── 6.1 (setAccount)              │
           │    ├── 6.2 (delAccount)              │
           │    └── 7.2 (AccountDao) ─────────────┤
           │                                      │
           └── 4.2 (getAllAccounts)               │
                                                  │
                                         8.1 (provider) ──── 9.1, 9.2 (integration tests)

10.1 (refactor getOrThrow) ← independent, can run anytime
```

---

## Summary

| Phase | Steps   | Description                            |
| ----- | ------- | -------------------------------------- |
| 0     | 0.1     | Install AWS SDK dependency             |
| 1     | 1.1-1.2 | Create domain objects                  |
| 2     | 2.1-2.2 | Create cast functions                  |
| 3     | 3.1     | Create organization get operation      |
| 4     | 4.1-4.2 | Create account get operations          |
| 5     | 5.1-5.2 | Create organization set/del operations |
| 6     | 6.1-6.2 | Create account set/del operations      |
| 7     | 7.1-7.2 | Create DAOs                            |
| 8     | 8.1     | Register with provider                 |
| 9     | 9.1-9.2 | Integration tests                      |
| 10    | 10.1    | Refactor legacy code                   |

**Total:** 16 steps
