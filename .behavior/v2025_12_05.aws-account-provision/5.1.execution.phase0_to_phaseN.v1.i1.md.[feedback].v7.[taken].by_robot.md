# feedback v8 response

## checklist

- [x] blocker.1: unit tests for organization account
  - created 5 test files, 36 tests total
  - all 101 unit tests passing

- [x] blocker.2: extract `getAwsOrganizationsClient` to `access/sdks`
  - [x] create `src/access/sdks/getAwsOrganizationsClient.ts`
  - [x] returns `{ client, organization }` tuple
  - [x] encapsulates fail-fast org manager auth check
  - [x] refactor getOneOrganizationAccount to use it
  - [x] refactor getAllOrganizationAccounts to use it
  - [x] refactor setOrganizationAccount to use it
  - [x] refactor delOrganizationAccount to use it

- [x] blocker.3: create provision/aws/declastruct.resources.ts
  - [x] create organization for authenticated account
  - [x] create demo account within the organization
  - [x] add github actions for aws provisioning

## execution

### blocker.1: unit tests (completed in previous session)

- `castIntoDeclaredAwsOrganizationAccount.test.ts` - 7 tests
- `getOneOrganizationAccount.test.ts` - 7 tests
- `setOrganizationAccount.test.ts` - 7 tests
- `delOrganizationAccount.test.ts` - 10 tests
- `getAllOrganizationAccounts.test.ts` - 5 tests

### blocker.2: getAwsOrganizationsClient (completed)

created `src/access/sdks/getAwsOrganizationsClient.ts`:
```ts
export const getAwsOrganizationsClient = async (
  context: ContextAwsApi & VisualogicContext,
): Promise<{
  client: OrganizationsClient;
  organization: HasReadonly<typeof DeclaredAwsOrganization>;
}> => {
  // fail-fast: require org manager auth
  const organization = await getOneOrganization({ by: { auth: true } }, context);
  if (!organization)
    BadRequestError.throw(
      'org manager auth required to use organizations client',
    );

  // declare the client
  const client = new OrganizationsClient({
    region: context.aws.credentials.region,
  });

  return { client, organization };
};
```

refactored all 4 organization account operations:
- `getOneOrganizationAccount.ts`
- `getAllOrganizationAccounts.ts`
- `setOrganizationAccount.ts`
- `delOrganizationAccount.ts`

updated all 4 test files to mock `getAwsOrganizationsClient` instead of `getOneOrganization`.

all 101 unit tests passing.

### blocker.3: provision/aws/declastruct.resources.ts (completed)

created `provision/aws/declastruct.resources.ts` following the github pattern:
- getProviders() returns the aws provider
- getResources() finserts organization first, then declares demo account

```ts
export const getResources = async (): Promise<DomainEntity<any>[]> => {
  // get the provider to access context
  const [provider] = await getProviders();
  const providerContext = (provider as any).context;
  const accountId = providerContext.aws.credentials.account;

  // finsert the organization first to ensure it exists and get its id
  const organization = await setOrganization(
    {
      finsert: DeclaredAwsOrganization.as({
        managementAccount: { id: accountId },
        featureSet: 'ALL',
      }),
    },
    providerContext,
  );

  // declare a demo account within the organization
  const demoAccount = DeclaredAwsOrganizationAccount.as({
    organization: { id: organization.id! },
    name: 'declastruct-demo',
    email: 'declastruct-demo@ahbode.dev',
    iamUserAccessToBilling: 'ALLOW',
    tags: { managedBy: 'declastruct', purpose: 'demo' },
  });

  // return resources for declastruct to apply
  return [organization, demoAccount];
};
```

usage:
```sh
AWS_PROFILE=<admin-profile> npx declastruct apply provision/aws/declastruct.resources.ts
```

### github actions for aws provisioning (completed)

updated `.github/workflows/.declastruct.yml`:
- added `aws-region` input parameter
- added `aws-account-id`, `aws-access-key-id`, `aws-secret-access-key` secrets
- added aws credentials configuration steps to both plan and apply jobs
- includes account verification step for safety

updated `.github/workflows/provision.yml`:
- added `aws` job that provisions aws organization and demo account
- uses secrets: `PROVISION_AWS_ACCOUNT_ID`, `PROVISION_AWS_ACCESS_KEY_ID`, `PROVISION_AWS_SECRET_ACCESS_KEY`

all 101 unit tests still passing.
