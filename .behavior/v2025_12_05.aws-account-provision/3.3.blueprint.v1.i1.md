# Implementation Blueprint: AWS Account Provisioning

## Wish Reference
> "it were easy to provision a new aws account with declastruct-aws"
> e.g., for the usecase of creation of a demo account to use for ehmpathy public tests
> e.g., ehmpathy-cicd-public account

## References
- Research: `3.1.research.domain._.v1.i1.md`
- Distillation: `3.2.distill.domain._.v1.i1.md`

---

## Implementation Tasks

### Phase 1: Domain Objects

#### 1.1 Create DeclaredAwsOrganization
**File:** `src/domain.objects/DeclaredAwsOrganization.ts`

Follow pattern from: `src/domain.objects/DeclaredAwsIamRole.ts`

- Define `OrganizationFeatureSet` type ('ALL' | 'CONSOLIDATED_BILLING')
- Define `DeclaredAwsOrganization` interface with:
  - `id?: string` (metadata)
  - `arn?: string` (metadata)
  - `featureSet: OrganizationFeatureSet` (required input)
  - `managementAccount: RefByUnique<typeof DeclaredAwsOrganizationAccount>` (unique key)
- Define class with:
  - `primary = ['id']`
  - `unique = ['managementAccount']`
  - `metadata = ['id', 'arn']`
  - `nested = { managementAccount: RefByUnique }`

#### 1.2 Create DeclaredAwsOrganizationAccount
**File:** `src/domain.objects/DeclaredAwsOrganizationAccount.ts`

Follow pattern from: `src/domain.objects/DeclaredAwsLambda.ts`

- Define types:
  - `OrganizationAccountState` ('PENDING_ACTIVATION' | 'ACTIVE' | 'SUSPENDED' | 'PENDING_CLOSURE' | 'CLOSED')
  - `OrganizationAccountJoinedMethod` ('CREATED' | 'INVITED')
  - `IamUserAccessToBilling` ('ALLOW' | 'DENY')
- Define `DeclaredAwsOrganizationAccount` interface with fields from distillation
- Define class with:
  - `primary = ['id']`
  - `unique = ['email']`
  - `metadata = ['id', 'arn']`
  - `readonly = ['organization', 'state', 'joinedMethod', 'joinedAt']`
  - `nested = { organization: RefByPrimary, tags: DomainLiteral }`

---

### Phase 2: Domain Operations

#### 2.1 Organization Operations

##### 2.1.1 castIntoDeclaredAwsOrganization
**File:** `src/domain.operations/organization/castIntoDeclaredAwsOrganization.ts`

Follow pattern from: `src/domain.operations/lambda/castIntoDeclaredAwsLambda.ts`

- Use `assure(x, isPresent)` pattern (NOT `getOrThrow`)
- Map AWS SDK `Organization` → `DeclaredAwsOrganization`
- Map `MasterAccountEmail` → `managementAccount.email`

##### 2.1.2 getOneOrganization
**File:** `src/domain.operations/organization/getOneOrganization.ts`

Follow pattern from: `src/domain.operations/lambda/getOneLambda.ts`

- Use `DescribeOrganizationCommand`
- Handle `AWSOrganizationsNotInUseException` → return null
- Region: `us-east-1` (Organizations API is global)

##### 2.1.3 setOrganization
**File:** `src/domain.operations/organization/setOrganization.ts`

Follow pattern from: `src/domain.operations/lambda/setLambda.ts`

- finsert only (organizations cannot be updated)
- Use `CreateOrganizationCommand`
- Handle `AlreadyInOrganizationException` → return existing (idempotent)

##### 2.1.4 delOrganization
**File:** `src/domain.operations/organization/delOrganization.ts`

- Use `DeleteOrganizationCommand`
- Handle `AWSOrganizationsNotInUseException` → return success (idempotent)

#### 2.2 Organization Account Operations

##### 2.2.1 castIntoDeclaredAwsOrganizationAccount
**File:** `src/domain.operations/organizationAccount/castIntoDeclaredAwsOrganizationAccount.ts`

Follow pattern from: `src/domain.operations/lambda/castIntoDeclaredAwsLambda.ts`

- Input: `{ account: Account; organization: RefByUnique<typeof DeclaredAwsOrganization> }`
- Use `assure(x, isPresent)` pattern
- Map `JoinedTimestamp` → `isUniDateTime.assure()`

##### 2.2.2 getOneOrganizationAccount
**File:** `src/domain.operations/organizationAccount/getOneOrganizationAccount.ts`

Follow pattern from: `src/domain.operations/lambda/getOneLambda.ts`

- By primary (id): use `DescribeAccountCommand`
- By unique (email): iterate `ListAccountsCommand` (email not indexed)
- Handle `AccountNotFoundException` → return null

##### 2.2.3 getAllOrganizationAccounts
**File:** `src/domain.operations/organizationAccount/getAllOrganizationAccounts.ts`

Follow pattern from: `src/domain.operations/lambda/getAllLambdas.ts`

- Use `ListAccountsCommand` with pagination
- Map each account with `castIntoDeclaredAwsOrganizationAccount`
- Note: requires getting organization first for the ref

##### 2.2.4 setOrganizationAccount
**File:** `src/domain.operations/organizationAccount/setOrganizationAccount.ts`

Follow pattern from: `src/domain.operations/lambda/setLambda.ts`

- finsert only (accounts cannot be updated)
- Use `CreateAccountCommand` (async operation)
- Poll `DescribeCreateAccountStatusCommand` until SUCCEEDED/FAILED
- Handle polling with `simple-sleep` (2s intervals)
- Default `iamUserAccessToBilling: 'ALLOW'`
- Default `roleName: 'OrganizationAccountAccessRole'`

##### 2.2.5 delOrganizationAccount
**File:** `src/domain.operations/organizationAccount/delOrganizationAccount.ts`

- Use `CloseAccountCommand`
- Handle already closed states (SUSPENDED, CLOSED, PENDING_CLOSURE) → return success
- Handle `AccountAlreadyClosedException` → return success (idempotent)

---

### Phase 3: DAOs

#### 3.1 DeclaredAwsOrganizationDao
**File:** `src/access/daos/DeclaredAwsOrganizationDao.ts`

Follow pattern from: `src/access/daos/DeclaredAwsLambdaDao.ts`

- get.byPrimary/byUnique/byRef → all call `getOneOrganization` (singleton)
- set.finsert → `setOrganization`
- set.delete → `delOrganization`
- Note: upsert not supported

#### 3.2 DeclaredAwsOrganizationAccountDao
**File:** `src/access/daos/DeclaredAwsOrganizationAccountDao.ts`

Follow pattern from: `src/access/daos/DeclaredAwsLambdaDao.ts`

- get.byPrimary/byUnique/byRef → route to `getOneOrganizationAccount`
- set.finsert → `setOrganizationAccount`
- set.delete → `delOrganizationAccount`
- Note: upsert not supported (accounts cannot be updated)

---

### Phase 4: Provider Integration

#### 4.1 Register DAOs with Provider
**File:** `src/domain.operations/provider/getDeclastructAwsProvider.ts`

Add:
```typescript
import { DeclaredAwsOrganizationDao } from '../../access/daos/DeclaredAwsOrganizationDao';
import { DeclaredAwsOrganizationAccountDao } from '../../access/daos/DeclaredAwsOrganizationAccountDao';
```

Register in provider's `daos` object.

---

### Phase 5: Tests

#### 5.1 Unit Tests
For each domain operation:
- `*.test.ts` - unit tests with mocked AWS SDK

#### 5.2 Integration Tests
- `*.integration.test.ts` - tests against real AWS (require organizations:* permissions)
- Note: Integration tests for account creation are expensive/slow (CreateAccount takes ~1min)

---

### Phase 6: Refactoring

#### 6.1 Replace getOrThrow with assure(x, isPresent)
**File:** `src/domain.operations/lambda/castIntoDeclaredAwsLambda.ts`

Current:
```typescript
const getOrThrow = <T, K extends keyof T>(obj: T, key: K): NotUndefined<T[K]> => {
  const value = obj[key];
  if (isNotUndefined(value)) return value;
  throw new UnexpectedCodePathError(`${String(key)} not found on response`, { input: obj, key });
};

// usage
arn: getOrThrow(input, 'FunctionArn'),
```

Replace with:
```typescript
import { assure, isPresent } from 'type-fns';

// usage
arn: assure(input.FunctionArn, isPresent),
```

Benefits:
- Removes local `getOrThrow` helper
- Uses standard `type-fns` pattern
- Less copypasta, more consistent with distillation design

---

## File Structure After Implementation

```
src/
├── domain.objects/
│   ├── DeclaredAwsOrganization.ts          [NEW]
│   └── DeclaredAwsOrganizationAccount.ts   [NEW]
│
├── domain.operations/
│   ├── organization/                        [NEW directory]
│   │   ├── index.ts
│   │   ├── getOneOrganization.ts
│   │   ├── getOneOrganization.test.ts
│   │   ├── setOrganization.ts
│   │   ├── setOrganization.test.ts
│   │   ├── delOrganization.ts
│   │   ├── delOrganization.test.ts
│   │   └── castIntoDeclaredAwsOrganization.ts
│   │
│   ├── organizationAccount/                 [NEW directory]
│   │   ├── index.ts
│   │   ├── getOneOrganizationAccount.ts
│   │   ├── getOneOrganizationAccount.test.ts
│   │   ├── getAllOrganizationAccounts.ts
│   │   ├── getAllOrganizationAccounts.test.ts
│   │   ├── setOrganizationAccount.ts
│   │   ├── setOrganizationAccount.test.ts
│   │   ├── delOrganizationAccount.ts
│   │   ├── delOrganizationAccount.test.ts
│   │   └── castIntoDeclaredAwsOrganizationAccount.ts
│   │
│   └── lambda/
│       └── castIntoDeclaredAwsLambda.ts     [MODIFY: replace getOrThrow]
│
└── access/daos/
    ├── DeclaredAwsOrganizationDao.ts        [NEW]
    └── DeclaredAwsOrganizationAccountDao.ts [NEW]
```

---

## Dependencies

### AWS SDK
Add to `package.json`:
```json
"@aws-sdk/client-organizations": "^3.x.x"
```

### Existing Dependencies (already installed)
- `domain-objects` - DomainEntity, RefByUnique, RefByPrimary
- `@ehmpathy/uni-time` - UniDateTime
- `type-fns` - assure, isPresent, isNotUndefined
- `helpful-errors` - HelpfulError, UnexpectedCodePathError
- `as-procedure` - asProcedure
- `simple-sleep` - sleep (for polling)

---

## Implementation Order (Recommended)

1. Install `@aws-sdk/client-organizations`
2. Create domain objects (1.1, 1.2)
3. Create cast functions (2.1.1, 2.2.1)
4. Create get operations (2.1.2, 2.2.2, 2.2.3)
5. Create set operations (2.1.3, 2.2.4)
6. Create del operations (2.1.4, 2.2.5)
7. Create DAOs (3.1, 3.2)
8. Register with provider (4.1)
9. Write tests (5.1, 5.2)
10. Refactor getOrThrow → assure(x, isPresent) (6.1)

---

## Usage Example (After Implementation)

```typescript
// resources.provision.ts
import { RefByUnique } from 'domain-objects';
import {
  DeclaredAwsOrganization,
  DeclaredAwsOrganizationAccount,
  getDeclastructAwsProvider,
} from 'declastruct-aws';

export const getProviders = async () => [
  await getDeclastructAwsProvider({}, { log: { ... } }),
];

export const getResources = async () => {
  const managementAccount = DeclaredAwsOrganizationAccount.as({
    name: 'ehmpathy-management',
    email: 'management@ehmpathy.com',
  });

  const organization = DeclaredAwsOrganization.as({
    featureSet: 'ALL',
    managementAccount: RefByUnique.as<typeof DeclaredAwsOrganizationAccount>(managementAccount),
  });

  const cicdAccount = DeclaredAwsOrganizationAccount.as({
    name: 'ehmpathy-cicd-public',
    email: 'ehmpathy-cicd-public@ehmpathy.com',
    organization: RefByUnique.as<typeof DeclaredAwsOrganization>(organization),
    tags: { purpose: 'cicd', managedBy: 'declastruct' },
  });

  return [managementAccount, organization, cicdAccount];
};
```

Apply:
```bash
npx declastruct apply --resources ./resources.provision.ts
```
