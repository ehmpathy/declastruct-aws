# Feedback Response Checklist

## blocker.1 - Unit tests
- [x] Unit tests exist at:
  - `src/domain.operations/organization/castIntoDeclaredAwsOrganization.test.ts`
  - `src/domain.operations/organization/getOneOrganization.test.ts`
  - `src/domain.operations/organization/setOrganization.test.ts`
  - `src/domain.operations/organization/delOrganization.test.ts`
  - `src/domain.operations/organizationAccount/castIntoDeclaredAwsOrganizationAccount.test.ts`
  - `src/domain.operations/organizationAccount/getOneOrganizationAccount.test.ts`
  - `src/domain.operations/organizationAccount/getAllOrganizationAccounts.test.ts`
  - `src/domain.operations/organizationAccount/setOrganizationAccount.test.ts`
  - `src/domain.operations/organizationAccount/delOrganizationAccount.test.ts`

## blocker.2 - Acceptance test
- [x] Added organization read tests to `src/contract/sdks/declastruct.acceptance.test.ts`
- [x] Tests verify: `getOneOrganization` and `getAllOrganizationAccounts` work via provider context
- [x] Note: Organization create/delete tests intentionally excluded (destructive, singleton resources)
- [x] Exported `DeclaredAwsOrganization`, `DeclaredAwsOrganizationAccount`, DAOs, and operations from `src/contract/sdks/index.ts`

## blocker.3 - Variable naming
- [x] Replace all `existing` with `foundBefore` or `foundAfter` in:
  - `setOrganization.ts`
  - `delOrganization.ts`
  - `setOrganizationAccount.ts`
  - `delOrganizationAccount.ts`

## blocker.4 - setOrganization input and validation
- [x] Change input from `Pick<DeclaredAwsOrganization, 'featureSet'>` to full `DeclaredAwsOrganization`
- [x] Validate that `desired.managementAccount` matches the created org's managementAccount
- [x] Pre-validate managementAccount via `DescribeAccountCommand` BEFORE any mutation
- [x] Post-validate managementAccount after creation as double-check

## blocker.5 - getOneOrganization pattern
- [x] Add `byUnique` and `byPrimary` input pattern consistent with other `get` operations
- [x] Support lookup by `id` (primary) or `managementAccount` (unique)
- [x] Made `by` parameter optional to support simple credential-based lookup

## blocker.6 - delOrganization input and validation
- [x] Change input to accept `by: PickOne<{ primary, unique, ref }>`
- [x] Validate that the desired org to delete matches the authed account's org
- [x] Fail fast if request is inconsistent/impossible

## blocker.7 - Client region from context
- [x] Updated all OrganizationsClient instantiations to use `context.aws.credentials.region`
- [x] Note: Decided not to create a separate `getAwsClient` utility since the pattern is simple (`new OrganizationsClient({ region: context.aws.credentials.region })`)

## blocker.8 - setOrganizationAccount organization validation
- [x] Validate that the organization of the current account matches the organization the account was asked to be created in (if `desired.organization` is provided)
- [x] Fail fast if mismatch detected

## Summary of changes
- `getOneOrganization.ts` - Now accepts `by?: PickOne<{ primary, unique, ref }>` with optional validation
- `setOrganization.ts` - Accepts full `DeclaredAwsOrganization`, validates managementAccount BEFORE AND AFTER creation via `getCurrentAccountEmail` helper
- `delOrganization.ts` - Accepts `by: PickOne<{ primary, unique, ref }>`, validates org matches before delete
- `setOrganizationAccount.ts` - Validates organization match if `desired.organization` provided
- `delOrganizationAccount.ts` - Uses `foundBefore` terminology, uses `context.aws.credentials.region`, validates org exists and account matches requested ref
- `getOneOrganizationAccount.ts` - Uses `context.aws.credentials.region`
- `getAllOrganizationAccounts.ts` - Uses `context.aws.credentials.region`
- `DeclaredAwsOrganizationDao.ts` - Updated to use new operation signatures

All 60 organization tests pass (total 356 tests pass).

## Additional validation added
- `delOrganizationAccount.ts` - Added validation that account is in the authed account's organization before closing
- Added test cases for organization mismatch and account mismatch scenarios
