# Roadmap: Log Retention Policies Implementation

> **Wish**: Set log retention policies for all log groups that currently exist

---

## Prerequisites

- [ ] **P1**: Node.js and npm installed
- [ ] **P2**: AWS credentials configured (`source .agent/repo=.this/skills/use.demo.awsprofile.sh`)
- [ ] **P3**: Dependencies installed (`npm install`)
- [ ] **P4**: Project builds successfully (`npm run build`)
- [ ] **P5**: Unit tests pass (`npm run test`)

**Verification**: Run `npm run build && npm run test` â€” should complete with no errors.

---

## Step 1: Update Domain Object

**Dependencies**: P1, P2, P3

### 1.1 Remove `retentionInDays` from readonly array

- [ ] **1.1.1**: Open `src/domain.objects/DeclaredAwsLogGroup.ts`
- [ ] **1.1.2**: Locate `public static readonly = ['storedBytes', 'createdAt', 'retentionInDays'] as const;`
- [ ] **1.1.3**: Remove `'retentionInDays'` from the array
- [ ] **1.1.4**: Result: `public static readonly = ['storedBytes', 'createdAt'] as const;`

**Acceptance Criteria**:
- `retentionInDays` is no longer in the `readonly` array
- TypeScript compiles without errors

**Verification**:
```sh
npm run build
# Should complete successfully
grep -n "readonly.*retentionInDays" src/domain.objects/DeclaredAwsLogGroup.ts
# Should return no matches
```

---

## Step 2: Create Domain Operation

**Dependencies**: Step 1

### 2.1 Create `setLogGroup.ts`

- [ ] **2.1.1**: Create file `src/domain.operations/logGroup/setLogGroup.ts`
- [ ] **2.1.2**: Import AWS SDK commands: `CreateLogGroupCommand`, `PutRetentionPolicyCommand`, `DeleteRetentionPolicyCommand`
- [ ] **2.1.3**: Import dependencies: `asProcedure`, `UnexpectedCodePathError`, `PickOne`, `getOneLogGroup`
- [ ] **2.1.4**: Implement `setLogGroup` function with:
  - [ ] **2.1.4a**: `findsert` mode: create if not found, return foundBefore if found
  - [ ] **2.1.4b**: `upsert` mode: create if not found, update retention if found
  - [ ] **2.1.4c**: `CreateLogGroupCommand` for new log groups
  - [ ] **2.1.4d**: `PutRetentionPolicyCommand` when `retentionInDays` is a number
  - [ ] **2.1.4e**: `DeleteRetentionPolicyCommand` when `retentionInDays` is null
  - [ ] **2.1.4f**: Skip retention update when value unchanged (optimization)

**Acceptance Criteria**:
- Function handles both `findsert` and `upsert` modes
- Creates log group when not found
- Sets retention policy when specified
- Deletes retention policy when null
- Returns `foundBefore` for findsert when log group exists
- TypeScript compiles without errors

**Verification**:
```sh
npm run build
# Should complete successfully
```

### 2.2 Create `setLogGroup.test.ts`

- [ ] **2.2.1**: Create file `src/domain.operations/logGroup/setLogGroup.test.ts`
- [ ] **2.2.2**: Mock `@aws-sdk/client-cloudwatch-logs` and `./getOneLogGroup`
- [ ] **2.2.3**: Implement test cases:
  - [ ] **2.2.3a**: `findsert` creates log group when not found
  - [ ] **2.2.3b**: `findsert` returns foundBefore when log group exists (idempotent)
  - [ ] **2.2.3c**: `upsert` creates log group when not found
  - [ ] **2.2.3d**: `upsert` updates retention when different
  - [ ] **2.2.3e**: `upsert` deletes retention when null
  - [ ] **2.2.3f**: `upsert` skips update when retention unchanged

**Acceptance Criteria**:
- All 6 test cases pass
- Tests cover findsert idempotency
- Tests cover upsert retention changes
- Tests verify correct AWS SDK commands are called

**Verification**:
```sh
npm run test -- --testPathPattern=setLogGroup.test.ts
# Should show 6 passing tests
```

---

## Step 3: Update DAO

**Dependencies**: Step 2

### 3.1 Update `DeclaredAwsLogGroupDao.ts`

- [ ] **3.1.1**: Open `src/access/daos/DeclaredAwsLogGroupDao.ts`
- [ ] **3.1.2**: Import `setLogGroup` from `../../domain.operations/logGroup/setLogGroup`
- [ ] **3.1.3**: Replace `set.findsert` implementation:
  - [ ] **3.1.3a**: Remove `BadRequestError.throw(...)`
  - [ ] **3.1.3b**: Add `return setLogGroup({ findsert: input }, context);`
- [ ] **3.1.4**: Add `set.upsert` implementation:
  - [ ] **3.1.4a**: Add `upsert: async (input, context) => { return setLogGroup({ upsert: input }, context); }`

**Acceptance Criteria**:
- `set.findsert` delegates to `setLogGroup({ findsert: ... })`
- `set.upsert` delegates to `setLogGroup({ upsert: ... })`
- TypeScript compiles without errors

**Verification**:
```sh
npm run build
# Should complete successfully
```

---

## Step 4: Export from SDK

**Dependencies**: Step 3

### 4.1 Update `index.ts` exports

- [ ] **4.1.1**: Open `src/contract/sdks/index.ts`
- [ ] **4.1.2**: Locate the `// aws log group operations` section
- [ ] **4.1.3**: Add export: `export { setLogGroup } from '../../domain.operations/logGroup/setLogGroup';`

**Acceptance Criteria**:
- `setLogGroup` is exported from the SDK
- TypeScript compiles without errors
- Consumers can import `setLogGroup` from `declastruct-aws`

**Verification**:
```sh
npm run build
# Should complete successfully
grep -n "setLogGroup" dist/contract/sdks/index.js
# Should show the export
```

---

## Step 5: Run Full Test Suite

**Dependencies**: Steps 1-4

### 5.1 Verify all unit tests pass

- [ ] **5.1.1**: Run full test suite
- [ ] **5.1.2**: Verify no regressions in existing tests
- [ ] **5.1.3**: Verify new `setLogGroup` tests pass

**Acceptance Criteria**:
- All existing tests continue to pass
- New `setLogGroup` tests pass
- No TypeScript errors

**Verification**:
```sh
npm run build && npm run test
# Should complete with all tests passing
```

---

## Step 6: Add Acceptance Test Resources

**Dependencies**: Step 5

### 6.1 Update `resources.acceptance.ts`

- [ ] **6.1.1**: Open `src/contract/sdks/.test/assets/resources.acceptance.ts`
- [ ] **6.1.2**: Add log group declaration with retention:
  ```ts
  const logGroupWithRetention = DeclaredAwsLogGroup.as({
    name: '/declastruct/acceptance-test/with-retention',
    class: 'STANDARD',
    kmsKeyId: null,
    retentionInDays: 14,
  });
  ```
- [ ] **6.1.3**: Add `logGroupWithRetention` to the return array

**Acceptance Criteria**:
- Log group with retention is declared in resources file
- File has no syntax errors

**Verification**:
```sh
npx tsc --noEmit src/contract/sdks/.test/assets/resources.acceptance.ts
# Should complete with no errors
```

---

## Step 7: Add Acceptance Test Cases

**Dependencies**: Step 6

### 7.1 Update `declastruct.acceptance.test.ts`

- [ ] **7.1.1**: Open `src/contract/sdks/declastruct.acceptance.test.ts`
- [ ] **7.1.2**: Add test in `'when generating a plan'` block:
  - [ ] **7.1.2a**: `then('plan includes log group with retention resource', ...)`
- [ ] **7.1.3**: Add test in `'when applying a plan'` block:
  - [ ] **7.1.3a**: `then('creates log group with retention policy', ...)`
- [ ] **7.1.4**: Add/update `'when re-planning after apply to verify idempotency'` block:
  - [ ] **7.1.4a**: `then('all resources show KEEP after apply', ...)`
  - [ ] **7.1.4b**: `then('log group with retention shows KEEP', ...)`

**Acceptance Criteria**:
- Plan test verifies log group is in plan
- Apply test verifies log group change is processed
- Re-plan test verifies all resources show KEEP (idempotency)
- Re-plan test verifies log group specifically shows KEEP

**Verification**:
```sh
npm run build
# Acceptance tests require AWS credentials and are run separately
```

---

## Step 8: Run Acceptance Tests

**Dependencies**: Step 7, P2

### 8.1 Execute acceptance test suite

- [ ] **8.1.1**: Source AWS profile: `source .agent/repo=.this/skills/use.demo.awsprofile.sh`
- [ ] **8.1.2**: Build project: `npm run build`
- [ ] **8.1.3**: Run acceptance tests: `npm run test:acceptance`
- [ ] **8.1.4**: Verify plan includes log group with retention
- [ ] **8.1.5**: Verify apply succeeds
- [ ] **8.1.6**: Verify re-plan shows all KEEP

**Acceptance Criteria**:
- Plan includes `DeclaredAwsLogGroup` resource
- Apply creates log group in AWS with correct retention
- Re-plan shows `willDo: 'KEEP'` for log group
- Re-plan shows `willDo: 'KEEP'` for all resources (idempotency)

**Verification**:
```sh
source .agent/repo=.this/skills/use.demo.awsprofile.sh && npm run build && npm run test:acceptance
# Should complete with all acceptance tests passing
```

---

## Step 9: Manual Verification (Optional)

**Dependencies**: Step 8

### 9.1 Verify in AWS Console

- [ ] **9.1.1**: Log into AWS Console
- [ ] **9.1.2**: Navigate to CloudWatch > Log groups
- [ ] **9.1.3**: Find `/declastruct/acceptance-test/with-retention`
- [ ] **9.1.4**: Verify retention is set to 14 days

**Acceptance Criteria**:
- Log group exists in AWS
- Retention shows "14 days" in console

**Verification**: Visual confirmation in AWS Console.

---

## Summary Checklist

| Step | Description                    | Status |
| ---- | ------------------------------ | ------ |
| P    | Prerequisites                  | [ ]    |
| 1    | Update Domain Object           | [ ]    |
| 2    | Create Domain Operation        | [ ]    |
| 3    | Update DAO                     | [ ]    |
| 4    | Export from SDK                | [ ]    |
| 5    | Run Full Test Suite            | [ ]    |
| 6    | Add Acceptance Test Resources  | [ ]    |
| 7    | Add Acceptance Test Cases      | [ ]    |
| 8    | Run Acceptance Tests           | [ ]    |
| 9    | Manual Verification (Optional) | [ ]    |

---

## Rollback Plan

If any step fails:

1. **Revert changes**: `git checkout -- .`
2. **Verify build**: `npm run build && npm run test`
3. **Review error**: Check error message and logs
4. **Fix and retry**: Address the specific issue and retry from the failed step
