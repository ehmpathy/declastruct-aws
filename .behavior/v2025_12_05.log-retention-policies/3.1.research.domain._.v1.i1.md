# Domain Research: AWS CloudWatch Logs Retention Policies

> **Wish**: Set log retention policies for all log groups that currently exist

---

## Domain Objects

### 1. Entities

#### LogGroup

The primary entity in CloudWatch Logs representing a collection of log streams.

**Properties** [1]:

| Property | Type | Description |
|----------|------|-------------|
| `logGroupName` | String (1-512 chars) | "The name of the log group." Pattern: `[\.\-_/#A-Za-z0-9]+` |
| `logGroupArn` | String | "The Amazon Resource Name (ARN) of the log group" (without trailing `:*`) |
| `arn` | String | ARN with trailing `:*` (used for IAM policies) |
| `retentionInDays` | Integer | Days to retain log events. Null = never expire |
| `creationTime` | Long | "The creation time of the log group, expressed as the number of milliseconds after Jan 1, 1970 00:00:00 UTC." |
| `storedBytes` | Long | "The number of bytes stored." |
| `metricFilterCount` | Integer | "The number of metric filters." |
| `kmsKeyId` | String | "The Amazon Resource Name (ARN) of the AWS KMS key to use when encrypting log data." |
| `logGroupClass` | String | "Specifies class: Standard (all features), Infrequent Access (subset, lower cost), or Delivery (Lambda logs only)" |
| `dataProtectionStatus` | String | Indicates if log group has a data protection policy |
| `deletionProtectionEnabled` | Boolean | "Indicates whether deletion protection is enabled for this log group." |
| `inheritedProperties` | Array | "Displays all the properties that this log group has inherited from account-level settings." |

#### RetentionPolicy (conceptual)

> **Important Finding**: AWS does not expose retention policy as a separate entity. The retention policy is an **attribute** of the LogGroup entity (`retentionInDays`). This means:
> - Retention is managed via `PutRetentionPolicy` / `DeleteRetentionPolicy` operations
> - These operations **update** the existing LogGroup, not create separate entities
> - There is no "get retention policy" operation — you get it from the LogGroup itself

### 2. Literals (Enums)

#### RetentionInDays

"Possible values are: 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1096, 1827, 2192, 2557, 2922, 3288, and 3653." [2]

| Days | Approximate Duration |
|------|---------------------|
| 1 | 1 day |
| 3 | 3 days |
| 5 | 5 days |
| 7 | 1 week |
| 14 | 2 weeks |
| 30 | 1 month |
| 60 | 2 months |
| 90 | 3 months |
| 120 | 4 months |
| 150 | 5 months |
| 180 | 6 months |
| 365 | 1 year |
| 400 | ~13 months |
| 545 | ~18 months |
| 731 | 2 years |
| 1096 | 3 years |
| 1827 | 5 years |
| 2192 | 6 years |
| 2557 | 7 years |
| 2922 | 8 years |
| 3288 | 9 years |
| 3653 | 10 years |

> "To set a log group so that its log events do not expire, use DeleteRetentionPolicy." [2]

#### LogGroupClass

"Possible values are: STANDARD, INFREQUENT_ACCESS, or DELIVERY" [3]

| Value | Description |
|-------|-------------|
| `STANDARD` | "The Standard log class supports all CloudWatch Logs features." Default value. |
| `INFREQUENT_ACCESS` | "The Infrequent Access log class supports a subset of CloudWatch Logs features and incurs lower costs." 50% lower ingestion cost. |
| `DELIVERY` | "Use the Delivery log class only for delivering Lambda logs to store in Amazon S3 or Amazon Data Firehose." Logs kept for only 1 day. |

> "The logGroupClass property cannot be changed once the log group is created." [3]

---

## Domain Operations

### Read Operations

#### DescribeLogGroups

"Lists the specified log groups. You can list all your log groups or filter the results by prefix. The results are ASCII-sorted by log group name." [4]

**Input**:
- `logGroupNamePrefix`: String — prefix filter (mutually exclusive with pattern)
- `logGroupNamePattern`: String — "case-sensitive substring search"
- `logGroupClass`: String — filter by class
- `limit`: Integer (1-50) — max items returned
- `nextToken`: String — pagination token

**Output**:
- `logGroups`: Array of LogGroup objects
- `nextToken`: String — for pagination

**Errors**:
- `InvalidParameterException` (HTTP 400)
- `ServiceUnavailableException` (HTTP 500)

#### ListLogGroups

"Returns a list of log groups in the Region in your account." [5]

**Differences from DescribeLogGroups**:
- Supports regex pattern matching (up to 5 patterns separated by `|`)
- Higher limit (1-1000 vs 1-50)
- Simpler response (only `logGroupArn`, `logGroupClass`, `logGroupName`)
- Use for quick enumeration vs detailed info

**Input**:
- `logGroupNamePattern`: String — regex filter (3-129 chars)
- `logGroupClass`: String — filter by class
- `limit`: Integer (1-1000, default 50)
- `nextToken`: String — pagination token

**Output**:
- `logGroups`: Array of LogGroupSummary objects (minimal fields)
- `nextToken`: String — for pagination

### Write Operations

#### PutRetentionPolicy

"Sets the retention of the specified log group. With a retention policy, you can configure the number of days for which to retain log events in the specified log group." [2]

**Input**:
- `logGroupName` (required): String — target log group name
- `retentionInDays` (required): Integer — one of the valid literal values

**Output**:
- "If the action is successful, the service sends back an HTTP 200 response with an empty HTTP body." [2]

**Errors**:
- `InvalidParameterException` (HTTP 400) — "A parameter is specified incorrectly"
- `OperationAbortedException` (HTTP 400) — "Multiple concurrent requests to update the same resource were in conflict"
- `ResourceNotFoundException` (HTTP 400) — "The specified resource does not exist"
- `ServiceUnavailableException` (HTTP 500) — "The service cannot complete the request"

**Important Note**:
> "CloudWatch Logs doesn't immediately delete log events when they reach their retention setting. It typically takes up to 72 hours after that before log events are deleted, but in rare situations might take longer. When log events reach their retention setting they are marked for deletion. After they are marked for deletion, they do not add to your archival storage costs anymore, even if they are not actually deleted until later." [2]

#### DeleteRetentionPolicy

"Deletes the specified retention policy." [6]

"Log events do not expire if they belong to log groups without a retention policy." [6]

**Input**:
- `logGroupName` (required): String — target log group name

**Output**:
- "an HTTP 200 response with an empty HTTP body." [6]

**Errors**: Same as PutRetentionPolicy

---

## Operation Mapping

| Conceptual Operation | AWS Operation | Notes |
|---------------------|---------------|-------|
| `getOne(LogGroup)` | `DescribeLogGroups` with `logGroupIdentifiers` | Returns single log group by name or ARN |
| `getAll(LogGroup)` | `DescribeLogGroups` or `ListLogGroups` (paginated) | Use pagination helpers |
| `setUpdate(RetentionPolicy)` | `PutRetentionPolicy` | Updates LogGroup's retentionInDays |
| `setDelete(RetentionPolicy)` | `DeleteRetentionPolicy` | Sets retentionInDays to null (never expire) |

> **Note**: There is no `setCreate` for retention policy — it's always an update to an existing log group. `PutRetentionPolicy` is idempotent.

---

## SDK Reference (JavaScript v3)

### Package
`@aws-sdk/client-cloudwatch-logs` [7]

### Commands

```typescript
import {
  CloudWatchLogsClient,
  DescribeLogGroupsCommand,
  PutRetentionPolicyCommand,
  DeleteRetentionPolicyCommand,
  paginateDescribeLogGroups,
} from '@aws-sdk/client-cloudwatch-logs';
```

### PutRetentionPolicy Example

```typescript
import { CloudWatchLogsClient, PutRetentionPolicyCommand }
  from "@aws-sdk/client-cloudwatch-logs";

const client = new CloudWatchLogsClient({ region: "us-east-1" });

const command = new PutRetentionPolicyCommand({
  logGroupName: "/aws/lambda/my-function",
  retentionInDays: 30,
});

const response = await client.send(command);
```
[8]

### Pagination Example

```typescript
import {
  paginateDescribeLogGroups,
  CloudWatchLogsClient,
} from "@aws-sdk/client-cloudwatch-logs";

const client = new CloudWatchLogsClient({});

for await (const page of paginateDescribeLogGroups({ client }, {
  logGroupNamePrefix: '/aws/lambda/'
})) {
  for (const logGroup of page.logGroups ?? []) {
    console.log(logGroup.logGroupName, logGroup.retentionInDays);
  }
}
```
[9]

---

## Existing Codebase Patterns

The codebase already has:

1. **Entity**: `DeclaredAwsLogGroup` at `src/domain.objects/DeclaredAwsLogGroup.ts`
   - Has `retentionInDays` as a `readonly` attribute
   - Uses declastruct patterns with `primary`, `unique`, `metadata`, `readonly` static properties

2. **Operations**:
   - `getOneLogGroup` — uses `DescribeLogGroupsCommand`
   - `getAllLogGroups` — uses `paginateDescribeLogGroups`
   - Both are in `src/domain.operations/logGroup/`

3. **Missing Operations for Wish**:
   - `setLogGroupRetentionPolicy` — needs `PutRetentionPolicyCommand`
   - `deleteLogGroupRetentionPolicy` — needs `DeleteRetentionPolicyCommand`

---

## Citations

[1] LogGroup Data Type — Amazon CloudWatch Logs API Reference
https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_LogGroup.html
> "The name of the log group." / "The Amazon Resource Name (ARN) of the log group" / "The creation time of the log group, expressed as the number of milliseconds after Jan 1, 1970 00:00:00 UTC." / "The number of bytes stored." / "The number of metric filters." / "The Amazon Resource Name (ARN) of the AWS KMS key to use when encrypting log data." / "Indicates whether deletion protection is enabled for this log group." / "Displays all the properties that this log group has inherited from account-level settings."

[2] PutRetentionPolicy — Amazon CloudWatch Logs API Reference
https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_PutRetentionPolicy.html
> "Sets the retention of the specified log group. With a retention policy, you can configure the number of days for which to retain log events in the specified log group." / "Possible values are: 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1096, 1827, 2192, 2557, 2922, 3288, and 3653." / "If the action is successful, the service sends back an HTTP 200 response with an empty HTTP body." / "CloudWatch Logs doesn't immediately delete log events when they reach their retention setting. It typically takes up to 72 hours after that before log events are deleted, but in rare situations might take longer. When log events reach their retention setting they are marked for deletion. After they are marked for deletion, they do not add to your archival storage costs anymore, even if they are not actually deleted until later."

[3] Log classes — Amazon CloudWatch Logs User Guide
https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/CloudWatch_Logs_Log_Classes.html
> "The Standard log class supports all CloudWatch Logs features." / "The Infrequent Access log class supports a subset of CloudWatch Logs features and incurs lower costs." / "Use the Delivery log class only for delivering Lambda logs to store in Amazon S3 or Amazon Data Firehose." / "The logGroupClass property cannot be changed once the log group is created."

[4] DescribeLogGroups — Amazon CloudWatch Logs API Reference
https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_DescribeLogGroups.html
> "Lists the specified log groups. You can list all your log groups or filter the results by prefix. The results are ASCII-sorted by log group name." / "case-sensitive substring search"

[5] ListLogGroups — Amazon CloudWatch Logs API Reference
https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_ListLogGroups.html
> "Returns a list of log groups in the Region in your account."

[6] DeleteRetentionPolicy — Amazon CloudWatch Logs API Reference
https://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/API_DeleteRetentionPolicy.html
> "Deletes the specified retention policy." / "Log events do not expire if they belong to log groups without a retention policy." / "an HTTP 200 response with an empty HTTP body."

[7] @aws-sdk/client-cloudwatch-logs — npm
https://www.npmjs.com/package/@aws-sdk/client-cloudwatch-logs

[8] PutRetentionPolicyCommand — AWS SDK for JavaScript v3
https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/client/cloudwatch-logs/command/PutRetentionPolicyCommand/
> Example code for using PutRetentionPolicyCommand

[9] CloudWatch Logs examples using SDK for JavaScript (v3) — AWS SDK for JavaScript
https://docs.aws.amazon.com/sdk-for-javascript/v3/developer-guide/javascript_cloudwatch-logs_code_examples.html
> Pagination examples and SDK usage patterns
