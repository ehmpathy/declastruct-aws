# Roadmap: IAM User Access Key Purge Implementation

## Quick Reference

```
wish: getAllIamUserAccessKeys({ by: { account } }) → del(key)
```

---

## Phase 1: Foundation — Domain Objects

### 1.1 DeclaredAwsIamUser

- [ ] create `src/domain.objects/DeclaredAwsIamUser.ts`
- [ ] create `src/domain.objects/DeclaredAwsIamUser.test.ts`

**acceptance criteria:**
- domain object defines `primary = ['id']`
- domain object defines `unique = ['account', 'username']`
- domain object defines `readonly = ['createDate']`
- domain object defines `metadata = ['id', 'arn']`

**verification:**
```bash
npm run test:types
npm run test:unit -- DeclaredAwsIamUser.test.ts
```

---

### 1.2 DeclaredAwsIamUserAccessKey

> depends: none (parallel with 1.1)

- [ ] create `src/domain.objects/DeclaredAwsIamUserAccessKey.ts`
- [ ] create `src/domain.objects/DeclaredAwsIamUserAccessKey.test.ts`

**acceptance criteria:**
- domain object defines `primary = ['accessKeyId']`
- domain object has no unique key (only primary)
- domain object defines `readonly = ['createDate', 'lastUsedDate', 'lastUsedService', 'lastUsedRegion']`
- domain object defines `metadata = ['accessKeyId']`
- domain object defines `nested = { user: RefByUnique }`

**verification:**
```bash
npm run test:types
npm run test:unit -- DeclaredAwsIamUserAccessKey.test.ts
```

---

## Phase 2: IAM User Operations

### 2.1 castIntoDeclaredAwsIamUser

> depends: 1.1

- [ ] create `src/domain.operations/iamUser/castIntoDeclaredAwsIamUser.ts`
- [ ] create `src/domain.operations/iamUser/castIntoDeclaredAwsIamUser.test.ts`

**acceptance criteria:**
- uses `assure(DeclaredAwsIamUser.as({...}), hasReadonly({ of: DeclaredAwsIamUser }))`
- fails fast if `UserId` is missing
- fails fast if `Arn` is missing
- fails fast if `UserName` is missing
- fails fast if `CreateDate` is missing
- returns `HasReadonly<typeof DeclaredAwsIamUser>`

**verification:**
```bash
npm run test:types
npm run test:unit -- castIntoDeclaredAwsIamUser.test.ts
```

---

### 2.2 getAllIamUsers

> depends: 2.1

- [ ] create `src/domain.operations/iamUser/getAllIamUsers.ts`
- [ ] create `src/domain.operations/iamUser/getAllIamUsers.integration.test.ts`

**acceptance criteria:**
- accepts `by: { account: RefByPrimary<typeof DeclaredAwsOrganizationAccount> }`
- paginates using `Marker` until all users fetched
- casts each user via `castIntoDeclaredAwsIamUser`
- returns `HasReadonly<typeof DeclaredAwsIamUser>[]`

**verification:**
```bash
npm run test:types
AWS_PROFILE=ahbode.dev npm run test:integration -- getAllIamUsers.integration.test.ts
```

---

### 2.3 getOneIamUser

> depends: 2.1

- [ ] create `src/domain.operations/iamUser/getOneIamUser.ts`
- [ ] create `src/domain.operations/iamUser/getOneIamUser.integration.test.ts`

**acceptance criteria:**
- accepts `by: { primary | unique | ref }`
- uses `GetUserCommand` for lookup
- returns `HasReadonly<typeof DeclaredAwsIamUser> | null`

**verification:**
```bash
npm run test:types
AWS_PROFILE=ahbode.dev npm run test:integration -- getOneIamUser.integration.test.ts
```

---

## Phase 3: IAM Access Key Operations

### 3.1 castIntoDeclaredAwsIamUserAccessKey

> depends: 1.2

- [ ] create `src/domain.operations/iamUserAccessKey/castIntoDeclaredAwsIamUserAccessKey.ts`
- [ ] create `src/domain.operations/iamUserAccessKey/castIntoDeclaredAwsIamUserAccessKey.test.ts`

**acceptance criteria:**
- uses `assure(DeclaredAwsIamUserAccessKey.as({...}), hasReadonly({ of: DeclaredAwsIamUserAccessKey }))`
- fails fast if `AccessKeyId` is missing
- fails fast if `Status` is missing
- fails fast if `CreateDate` is missing
- handles nullable `lastUsedDate`, `lastUsedService`, `lastUsedRegion`
- returns `HasReadonly<typeof DeclaredAwsIamUserAccessKey>`

**verification:**
```bash
npm run test:types
npm run test:unit -- castIntoDeclaredAwsIamUserAccessKey.test.ts
```

---

### 3.2 getAllIamUserAccessKeys

> depends: 2.2, 3.1

- [ ] create `src/domain.operations/iamUserAccessKey/getAllIamUserAccessKeys.ts`
- [ ] create `src/domain.operations/iamUserAccessKey/getAllIamUserAccessKeys.integration.test.ts`

**acceptance criteria:**
- accepts `by: { user | account }` (PickOne)
- when `by.account`: fetches all users via `getAllIamUsers`, then keys for each
- when `by.user`: fetches keys for that user only
- enriches each key with `GetAccessKeyLastUsed` data
- casts each key via `castIntoDeclaredAwsIamUserAccessKey`
- returns `HasReadonly<typeof DeclaredAwsIamUserAccessKey>[]`

**verification:**
```bash
npm run test:types
AWS_PROFILE=ahbode.dev npm run test:integration -- getAllIamUserAccessKeys.integration.test.ts
```

---

### 3.3 getOneIamUserAccessKey

> depends: 3.1

- [ ] create `src/domain.operations/iamUserAccessKey/getOneIamUserAccessKey.ts`
- [ ] create `src/domain.operations/iamUserAccessKey/getOneIamUserAccessKey.integration.test.ts`

**acceptance criteria:**
- accepts `by: { primary | ref }` (no unique — access keys have no unique key)
- uses `GetAccessKeyLastUsed` to resolve `UserName` from `accessKeyId`
- uses `ListAccessKeysCommand` to get full metadata
- returns `HasReadonly<typeof DeclaredAwsIamUserAccessKey> | null`
- returns `null` if key does not exist

**verification:**
```bash
npm run test:types
AWS_PROFILE=ahbode.dev npm run test:integration -- getOneIamUserAccessKey.integration.test.ts
```

---

### 3.4 delIamUserAccessKey

> depends: 3.3

- [ ] create `src/domain.operations/iamUserAccessKey/delIamUserAccessKey.ts`
- [ ] create `src/domain.operations/iamUserAccessKey/delIamUserAccessKey.integration.test.ts`

**acceptance criteria:**
- accepts `by: { primary | ref }`
- uses `GetAccessKeyLastUsed` to resolve `UserName` from `accessKeyId`
- uses `DeleteAccessKeyCommand` to delete
- idempotent: returns `{ deleted: true }` if key already deleted
- catches `NoSuchEntityException` and returns success

**verification:**
```bash
npm run test:types
AWS_PROFILE=ahbode.dev npm run test:integration -- delIamUserAccessKey.integration.test.ts
```

---

### 3.5 setIamUserAccessKey (fail-fast stub)

> depends: 1.2

- [ ] create `src/domain.operations/iamUserAccessKey/setIamUserAccessKey.ts`
- [ ] create `src/domain.operations/iamUserAccessKey/setIamUserAccessKey.test.ts`

**acceptance criteria:**
- accepts `PickOne<{ finsert | upsert }>`
- immediately throws `BadRequestError` with explanation
- message explains: access keys superseded by SSO/OIDC, use `getAllIamUserAccessKeys` + `delIamUserAccessKey` to audit and purge

**verification:**
```bash
npm run test:types
npm run test:unit -- setIamUserAccessKey.test.ts
```

---

## Phase 4: Access DAOs

### 4.1 DeclaredAwsIamUserDao

> depends: 2.2, 2.3

- [ ] create `src/access/daos/DeclaredAwsIamUserDao.ts`

**acceptance criteria:**
- implements `get.byPrimary`, `get.byUnique`, `get.byRef`
- delegates to `getOneIamUser`

**verification:**
```bash
npm run test:types
```

---

### 4.2 DeclaredAwsIamUserAccessKeyDao

> depends: 3.3, 3.4, 3.5

- [ ] create `src/access/daos/DeclaredAwsIamUserAccessKeyDao.ts`

**acceptance criteria:**
- implements `get.byPrimary`, `get.byRef`
- does NOT implement `get.byUnique` (access keys have no unique key)
- implements `set.finsert` (delegates to set, which fails fast)
- implements `set.delete` (delegates to `delIamUserAccessKey`)

**verification:**
```bash
npm run test:types
```

---

## Phase 5: Integration Verification

### 5.1 End-to-End Verification

> depends: all phases

- [ ] verify full wish can be fulfilled

**acceptance criteria:**
- can call `getAllIamUserAccessKeys({ by: { account } })`
- can call `del(key)` on each returned key
- can call `declastruct.apply(toDelete, context)`
- all keys are deleted from account

**verification:**
```bash
# manual verification in dev account
AWS_PROFILE=ahbode.dev npm run test:integration -- iamUserAccessKey
```

---

## Dependency Graph

```
1.1 DeclaredAwsIamUser ─────┬──▶ 2.1 castIntoDeclaredAwsIamUser ──▶ 2.2 getAllIamUsers ──┐
                            │                                                              │
                            └──▶ 2.3 getOneIamUser ───▶ 4.1 DeclaredAwsIamUserDao         │
                                                                                           │
1.2 DeclaredAwsIamUserAccessKey ──▶ 3.1 castIntoDeclaredAwsIamUserAccessKey ──────────────┤
                                                                                           ▼
                                   3.2 getAllIamUserAccessKeys ◀───────────────────────────┘
                                            │
                                            ▼
                                   3.3 getOneIamUserAccessKey
                                            │
                                            ▼
                                   3.4 delIamUserAccessKey
                                            │
                                            ▼
                                   3.5 setIamUserAccessKey (fail-fast)
                                            │
                                            ▼
                                   4.2 DeclaredAwsIamUserAccessKeyDao
```

---

## Implementation Order

1. [ ] 1.1 DeclaredAwsIamUser
2. [ ] 1.2 DeclaredAwsIamUserAccessKey
3. [ ] 2.1 castIntoDeclaredAwsIamUser
4. [ ] 3.1 castIntoDeclaredAwsIamUserAccessKey
5. [ ] 2.2 getAllIamUsers
6. [ ] 2.3 getOneIamUser
7. [ ] 3.2 getAllIamUserAccessKeys
8. [ ] 3.3 getOneIamUserAccessKey
9. [ ] 3.4 delIamUserAccessKey
10. [ ] 3.5 setIamUserAccessKey (fail-fast stub)
11. [ ] 4.1 DeclaredAwsIamUserDao
12. [ ] 4.2 DeclaredAwsIamUserAccessKeyDao

---

## AWS SDK Dependency

ensure `@aws-sdk/client-iam` is installed:

```bash
npm ls @aws-sdk/client-iam || npm install @aws-sdk/client-iam
```
