# AWS IAM Tokens Domain Research

## Overview

Based on the wish in `0.wish.md`, the goal is to:
1. `getAllIamTokens({ by: { account: RefByPrimary<typeof DeclaredAwsOrganizationAccount> }})`
2. Mark all tokens for deletion (`deletedAt: 'ASAP'` or `del(token)`)
3. Have declastruct invoke `dao.delete` for each resource marked for deletion

This research identifies the AWS IAM "token" types (credentials) that can be listed, managed, and deleted via AWS APIs.

---

## Domain Objects

### Entities

#### 1. AwsIamAccessKey
Long-term credentials for an IAM user consisting of an access key ID and secret access key.

**Key Attributes:**
- `accessKeyId` - Unique identifier (e.g., `AKIAIOSFODNN7EXAMPLE`) [1]
- `secretAccessKey` - Secret key (only available at creation time) [1]
- `status` - `Active` or `Inactive` [2]
- `createDate` - When the key was created [3]
- `userName` - The IAM user associated with the key [3]

> "Access keys consist of two parts: an access key ID (for example, AKIAIOSFODNN7EXAMPLE) and a secret access key (for example, wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY). You must use both the access key ID and secret access key together to authenticate your requests." [1]

> "Access keys are long-term credentials for an IAM user or the AWS account root user." [1]

> "You can have a maximum of two access keys per user." [1]

---

#### 2. AwsIamMfaDevice
Multi-factor authentication devices associated with IAM users.

**Key Attributes:**
- `serialNumber` - Unique identifier for the MFA device (ARN for virtual, serial for hardware) [4]
- `userName` - The IAM user associated with the device [5]
- `enableDate` - When the device was enabled [5]

> "For virtual MFA devices, the serial number is the device ARN." [4]

---

#### 3. AwsIamSigningCertificate
X.509 signing certificates associated with IAM users.

**Key Attributes:**
- `certificateId` - Unique identifier for the certificate [6]
- `userName` - The IAM user associated with the certificate [6]
- `status` - `Active` or `Inactive` [7]
- `certificateBody` - The PEM-encoded certificate body [6]
- `uploadDate` - When the certificate was uploaded [6]

> "Length Constraints: Minimum length of 24, Maximum length of 128." [7]

---

#### 4. AwsIamSshPublicKey
SSH public keys for CodeCommit authentication.

**Key Attributes:**
- `sshPublicKeyId` - Unique identifier (e.g., `APKA123456789EXAMPLE`) [8]
- `userName` - The IAM user associated with the key [8]
- `status` - `Active` or `Inactive` [9]
- `uploadDate` - When the key was uploaded [8]
- `fingerprint` - The MD5 fingerprint of the key [10]

> "The SSH public key uploaded by this operation can be used only for authenticating the associated IAM user to a CodeCommit repository." [8]

> "SSH public keys that are inactive cannot be used for authentication." [9]

---

#### 5. AwsIamServiceSpecificCredential
Service-specific credentials for services like CodeCommit, Amazon Keyspaces, and Amazon Bedrock.

**Key Attributes:**
- `serviceSpecificCredentialId` - Unique identifier [11]
- `userName` - The IAM user associated with the credential [11]
- `serviceName` - The service the credential is for (e.g., `codecommit.amazonaws.com`) [11]
- `serviceUserName` - The generated user name for the service [11]
- `status` - `Active` or `Inactive` [12]
- `createDate` - When the credential was created [11]

> "You can have a maximum of two sets of service-specific credentials for each supported service per user." [11]

> "You can create service-specific credentials for Amazon Bedrock, CodeCommit and Amazon Keyspaces (for Apache Cassandra)." [11]

> "The password for the credential is only available at creation time. It cannot be recovered later." [11]

---

#### 6. AwsIamUser (Supporting Entity)
The IAM user that owns the credentials.

**Key Attributes:**
- `userName` - Unique name of the user [13]
- `userId` - Unique identifier [13]
- `arn` - Amazon Resource Name [13]
- `createDate` - When the user was created [13]
- `passwordLastUsed` - When console password was last used [13]
- `path` - Path to the user [13]

> "IAM resource-listing operations return a subset of the available attributes for the resource. This operation does not return all attributes. To view all of the information for a user, see GetUser." [13]

---

### Literals

#### AccessKeyStatus
```typescript
type AccessKeyStatus = 'Active' | 'Inactive';
```
> "Status - The status you want to assign to the secret access key. Active means that the key can be used for AWS API calls, while Inactive means that the key cannot be used." [2]

#### MfaDeviceType
```typescript
type MfaDeviceType = 'virtual' | 'hardware' | 'sms'; // SMS deprecated
```

#### CredentialStatus
```typescript
type CredentialStatus = 'Active' | 'Inactive';
```

---

## Domain Operations

### AwsIamAccessKey Operations

#### getAll: ListAccessKeys
> "Returns information about the access key IDs associated with the specified IAM user. If there is none, the operation returns an empty list." [3]

**Parameters:**
- `userName` (optional) - If not specified, uses the caller's identity [3]
- `maxItems` - Default 100, max 1000 [3]
- `marker` - Pagination token [3]

#### getOne: GetAccessKeyLastUsed
> "Retrieves information about when the specified access key was last used. The information includes the date and time of last use, along with the AWS service and Region that were specified in the last request made with that key." [14]

**Response includes:**
- `lastUsedDate` [14]
- `serviceName` [14]
- `region` [14]

#### setUpdate: UpdateAccessKey
> "Changes the status of the specified access key from Active to Inactive, or vice versa. This operation can be used to disable a user's key as part of a key rotation workflow." [2]

**Parameters:**
- `accessKeyId` (required) [2]
- `status` - `Active` or `Inactive` [2]
- `userName` (optional) [2]

#### setDelete: DeleteAccessKey
> "Deletes the access key pair associated with the specified IAM user." [15]

**Parameters:**
- `accessKeyId` (required) - Length 16-128 characters [15]
- `userName` (optional) [15]

---

### AwsIamMfaDevice Operations

#### getAll: ListMFADevices
> "Lists the MFA devices for an IAM user. If the request includes a IAM user name, then this operation lists all the MFA devices associated with the specified user." [5]

**Parameters:**
- `userName` (optional) [5]
- `maxItems` - Default 100, max 1000 [5]
- `marker` - Pagination token [5]

#### setDelete: DeactivateMFADevice + DeleteVirtualMFADevice
> "Deactivates the specified MFA device and removes it from association with the user name for which it was originally enabled." [4]

> "Deletes a virtual MFA device. You must deactivate a user's virtual MFA device before you can delete it." [16]

**Process:**
1. Call `DeactivateMFADevice` with `userName` and `serialNumber` [4]
2. Call `DeleteVirtualMFADevice` with `serialNumber` [16]

---

### AwsIamSigningCertificate Operations

#### getAll: ListSigningCertificates
> "Returns information about the signing certificates associated with the specified IAM user. If none exists, the operation returns an empty list." [6]

**Parameters:**
- `userName` (optional) [6]
- `maxItems` - Default 100, max 1000 [6]
- `marker` - Pagination token [6]

#### setUpdate: UpdateSigningCertificate
> "Changes the status of the specified user signing certificate from active to disabled, or vice versa. This operation can be used to disable an IAM user's signing certificate as part of a certificate rotation work flow." [7]

**Parameters:**
- `certificateId` (required) [7]
- `status` - `Active` or `Inactive` [7]
- `userName` (optional) [7]

#### setDelete: DeleteSigningCertificate
> "Deletes a signing certificate associated with the specified IAM user." [17]

**Parameters:**
- `certificateId` (required) [17]
- `userName` (optional) [17]

---

### AwsIamSshPublicKey Operations

#### getAll: ListSSHPublicKeys
> "Returns SSH public keys used only for authenticating the IAM user to a CodeCommit repository." [10]

**Parameters:**
- `userName` (optional) [10]
- `maxItems` [10]
- `marker` - Pagination token [10]

#### setUpdate: UpdateSSHPublicKey
> "Sets the status of an IAM user's SSH public key to active or inactive. SSH public keys that are inactive cannot be used for authentication." [9]

**Parameters:**
- `userName` (required) [9]
- `sshPublicKeyId` (required) [9]
- `status` - `Active` or `Inactive` [9]

#### setDelete: DeleteSSHPublicKey
> "Deletes the specified SSH public key." [8]

**Parameters:**
- `userName` (required) [8]
- `sshPublicKeyId` (required) [8]

---

### AwsIamServiceSpecificCredential Operations

#### getAll: ListServiceSpecificCredentials
> "Returns information about the service-specific credentials associated with the specified IAM user. If none exists, the operation returns an empty list." [11]

**Parameters:**
- `userName` (optional) [11]
- `serviceName` (optional) - Filter by service [11]

#### setUpdate: UpdateServiceSpecificCredential
> "Sets the status of a service-specific credential to Active or Inactive. Service-specific credentials that are inactive cannot be used for authentication to the service." [12]

**Parameters:**
- `userName` (optional) [12]
- `serviceSpecificCredentialId` (required) [12]
- `status` - `Active` or `Inactive` [12]

#### setDelete: DeleteServiceSpecificCredential
Deletes the service-specific credential.

**Parameters:**
- `userName` (optional)
- `serviceSpecificCredentialId` (required)

---

### AwsIamUser Operations (Supporting)

#### getAll: ListUsers
> "Lists the IAM users that have the specified path prefix. If no path prefix is specified, the operation returns all users in the AWS account." [13]

**Parameters:**
- `pathPrefix` (optional) [13]
- `maxItems` - Default 100, max 1000 [13]
- `marker` - Pagination token [13]

#### getOne: GetUser
> "To view all of the information for a user, see GetUser." [13]

---

## Important Notes on STS Session Tokens

STS session tokens (temporary credentials) **cannot be individually revoked or deleted**:

> "It's not possible to cancel or manually expire a set of temporary credentials." [18]

> "Individual sessions on an IAM Role cannot be revoked. The option here is a broad stroke in which you revoke all sessions which were initiated at, and prior to, a fixed point in time." [18]

**Mitigation Strategy:**
> "You can immediately revoke all permissions to the role's credentials issued before a certain point in time if you need to. All temporary credentials for that role issued before the specified time become invalid." [19]

> "IAM then attaches a policy named AWSRevokeOlderSessions to the role." [19]

This is done via policy conditions using `aws:TokenIssueTime`:
> "You can also revoke session permissions at any time of your choice using the AWS CLI or SDK to specify a value for the aws:TokenIssueTime key in the Condition element of a policy." [19]

---

## Summary: Credential Types That Can Be Deleted

| Credential Type | List Operation | Delete Operation | Notes |
|-----------------|----------------|------------------|-------|
| Access Keys | `ListAccessKeys` | `DeleteAccessKey` | Max 2 per user |
| MFA Devices | `ListMFADevices` | `DeactivateMFADevice` + `DeleteVirtualMFADevice` | Must deactivate first |
| Signing Certificates | `ListSigningCertificates` | `DeleteSigningCertificate` | - |
| SSH Public Keys | `ListSSHPublicKeys` | `DeleteSSHPublicKey` | CodeCommit only |
| Service-Specific Credentials | `ListServiceSpecificCredentials` | `DeleteServiceSpecificCredential` | Max 2 per service |
| STS Session Tokens | N/A | N/A (revoke via policy) | Cannot be individually deleted |

---

## Citations

1. [AWS - Manage access keys for IAM users](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_access-keys.html)
2. [AWS - UpdateAccessKey API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_UpdateAccessKey.html)
3. [AWS - ListAccessKeys API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_ListAccessKeys.html)
4. [AWS - DeactivateMFADevice API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeactivateMFADevice.html)
5. [AWS - ListMFADevices API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_ListMFADevices.html)
6. [AWS - ListSigningCertificates API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_ListSigningCertificates.html)
7. [AWS - UpdateSigningCertificate API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_UpdateSigningCertificate.html)
8. [AWS - DeleteSSHPublicKey CLI Reference](https://docs.aws.amazon.com/cli/latest/reference/iam/delete-ssh-public-key.html)
9. [AWS - UpdateSSHPublicKey API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_UpdateSSHPublicKey.html)
10. [AWS - ListSSHPublicKeys API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_ListSSHPublicKeys.html)
11. [AWS - CreateServiceSpecificCredential API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_CreateServiceSpecificCredential.html)
12. [AWS - UpdateServiceSpecificCredential API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_UpdateServiceSpecificCredential.html)
13. [AWS - ListUsers API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_ListUsers.html)
14. [AWS - GetAccessKeyLastUsed API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_GetAccessKeyLastUsed.html)
15. [AWS - DeleteAccessKey API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeleteAccessKey.html)
16. [AWS - DeleteVirtualMFADevice API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeleteVirtualMFADevice.html)
17. [AWS - DeleteSigningCertificate API Reference](https://docs.aws.amazon.com/IAM/latest/APIReference/API_DeleteSigningCertificate.html)
18. [AWS re:Post - How to revoke Systems Manager aws_session_token](https://repost.aws/questions/QUSJyn0DInRgK06adyG7oQhg/how-to-revoke-systems-manager-aws-session-token)
19. [AWS - Revoke IAM role temporary security credentials](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles_use_revoke-sessions.html)
